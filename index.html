<!doctype html>
<html lang="zh-TW">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ–° HSK 3.0 ç”Ÿè©å¡å­¸ç¿’ç³»çµ±</title>
  <script src="./google-sheets-sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      box-sizing: border-box;
    }

    .card-flip {
      perspective: 1000px;
      -webkit-perspective: 1000px;
      position: relative;
    }

    .card-inner {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      transition: transform 0.6s;
      transform-style: preserve-3d;
      -webkit-transform-style: preserve-3d;
    }

    .card-flip.flipped .card-inner {
      transform: rotateY(180deg);
      -webkit-transform: rotateY(180deg);
    }

    .card-front, .card-back {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      backface-visibility: hidden;
      -webkit-backface-visibility: hidden;
      border-radius: 0.5rem;
      box-sizing: border-box;
    }

    .card-back {
      transform: rotateY(180deg);
      -webkit-transform: rotateY(180deg);
    }

    .fade-in {
      animation: fadeIn 0.3s ease-in;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .sync-indicator {
      animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .matching-card {
      transition: all 0.3s ease;
    }

    .matching-card:hover:not(.matched) {
      transform: scale(1.05);
    }

    .matching-card.flipped .card-inner {
      transform: rotateY(180deg);
    }

    .matching-card.matched {
      opacity: 0.5;
      pointer-events: none;
    }

    .shake {
      animation: shake 0.5s;
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-10px); }
      75% { transform: translateX(10px); }
    }

    .choice-btn {
      transition: all 0.2s;
    }

    .choice-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.15);
    }

    .choice-btn.correct {
      animation: correctPulse 0.6s;
    }

    .choice-btn.wrong {
      animation: wrongShake 0.5s;
    }

    @keyframes correctPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    @keyframes wrongShake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-8px); }
      75% { transform: translateX(8px); }
    }

    /* Login Modal Styles - Same.new inspired design */
    .login-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(229, 229, 229, 0.95);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }

    .login-modal {
      background-color: white;
      border-radius: 1rem;
      padding: 1.5rem;
      max-width: 380px;
      width: 90%;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
      border: 1px solid #e5e5e5;
      animation: modalIn 0.3s ease-out;
    }

    @keyframes modalIn {
      from {
        opacity: 0;
        transform: scale(0.95) translateY(-10px);
      }
      to {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }

    .login-input {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 1px solid #e5e5e5;
      border-radius: 0.5rem;
      font-size: 1rem;
      transition: border-color 0.2s, box-shadow 0.2s;
      outline: none;
      box-sizing: border-box;
    }

    .login-input:focus {
      border-color: #1f2937;
      box-shadow: 0 0 0 3px rgba(31, 41, 55, 0.1);
    }

    .login-btn {
      width: 100%;
      padding: 0.75rem 1rem;
      border-radius: 9999px;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .login-btn-primary {
      background-color: #1f2937;
      color: white;
      border: none;
    }

    .login-btn-primary:hover {
      background-color: #374151;
    }

    .login-btn-primary:disabled {
      background-color: #9ca3af;
      cursor: not-allowed;
    }

    .login-error {
      background-color: #fef2f2;
      border: 1px solid #fecaca;
      color: #991b1b;
      padding: 0.75rem;
      border-radius: 0.5rem;
      font-size: 0.875rem;
      text-align: center;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="w-full min-h-full" style="margin: 0; padding: 0;">
  <div id="app" class="w-full min-h-full"></div>
  <script>
    const defaultConfig = {
      site_title: "æ–° HSK 3.0 ç”Ÿè©å¡å­¸ç¿’ç³»çµ±",
      search_placeholder: "æœå°‹ç”Ÿè©...(æ”¯æ´ç°¡ç¹é«”ä¸­æ–‡ã€è‹±æ–‡æ‹¼éŸ³)",
      background_color: "#f0f4f8",
      card_color: "#ffffff",
      primary_color: "#3b82f6",
      text_color: "#1f2937",
      accent_color: "#10b981",
      font_family: "system-ui",
      font_size: 16
    };

    let allWords = [];
    let currentView = 'home';
    let selectedLevel = null;
    let studyMode = null;
    let currentCardIndex = 0;
    let studyWords = [];
    let testScore = 0;
    let testAnswers = [];
    let isLoading = false;
    let customWordTypes = ['åè¯ n.', 'åŠ¨è¯ v.', 'å½¢å®¹è¯ adj.', 'å‰¯è¯ adv.', 'ä»£è¯ pron.', 'æ•°è¯ num.', 'é‡è¯ m.', 'è¿è¯ conj.', 'ä»‹è¯ prep.', 'åŠ©è¯ part.', 'å¹è¯ int.', 'æ‹Ÿå£°è¯ nomo.', 'æˆè¯­ idiom.', 'æƒ¯ç”¨è¯­ com.phr.', 'è°šè¯­ pro.v.', 'ä¿—è¯­ com.say.', 'æ­‡åè¯­ com.expr.', 'å‰ç¼€ pref.', 'åç¼€ suff.'];
    let showWordTypeModal = false;
    let showLevelModal = false;
    let showSettingsModal = false;
    let showWordCountModal = false;
    let showManageLevelModal = false;
    let editingLevelId = null;
    let selectedWordCount = 10;
    let pendingStudyMode = null;
    const defaultLevels = [
      { id: '1', label: 'HSK 1', value: 1 },
      { id: '2', label: 'HSK 2', value: 2 },
      { id: '3', label: 'HSK 3', value: 3 },
      { id: '4', label: 'HSK 4', value: 4 },
      { id: '5', label: 'HSK 5', value: 5 },
      { id: '6', label: 'HSK 6', value: 6 },
      { id: '7-9', label: 'HSK 7-9', value: 7 }
    ];

    // Load custom levels from localStorage or use default
    let customLevels = loadLevelsFromStorage();

    // Helper functions for level storage
    function loadLevelsFromStorage() {
      try {
        const stored = localStorage.getItem('hsk_custom_levels');
        if (stored) {
          return JSON.parse(stored);
        }
      } catch (e) {
        console.error('Failed to load levels from storage:', e);
      }
      return [...defaultLevels];
    }

    function saveLevelsToStorage() {
      try {
        localStorage.setItem('hsk_custom_levels', JSON.stringify(customLevels));
      } catch (e) {
        console.error('Failed to save levels to storage:', e);
      }
    }
    let lastSyncTime = null;
    let gameOptions = [];
    let gameTimeLeft = 60;
    let gameTimer = null;
    let matchingPairs = [];
    let selectedCards = [];
    let matchedPairs = [];
    let gameStartTime = null;

    // ç™»å…¥ç‹€æ…‹ç®¡ç†
    let isLoggedIn = localStorage.getItem('hsk_logged_in') === 'true';
    let currentUser = localStorage.getItem('hsk_current_user') || '';
    let loginError = '';
    let isLoggingIn = false;
    let loginAttempts = {}; // è¿½è¹¤æœ¬åœ°ç™»å…¥å˜—è©¦æ¬¡æ•¸
    let lockedAccounts = {}; // è¿½è¹¤è¢«é–å®šçš„å¸³è™Ÿ
    let showLoginHistory = false; // é¡¯ç¤ºç™»å…¥æ­·å²å½ˆçª—
    let loginHistoryData = []; // ç™»å…¥æ­·å²è³‡æ–™

    // æ”¶è—ç”Ÿè©åº« (Favorites) - stored in localStorage
    let favoriteWords = JSON.parse(localStorage.getItem('hsk_favorites') || '[]');

    // ç™»å…¥å‡½æ•¸
    function login(username, password) {
      localStorage.setItem('hsk_logged_in', 'true');
      localStorage.setItem('hsk_current_user', username);
      isLoggedIn = true;
      currentUser = username;
      // æ¸…é™¤è©²ç”¨æˆ¶çš„å¤±æ•—æ¬¡æ•¸
      delete loginAttempts[username];
    }

    // ç™»å‡ºå‡½æ•¸
    function logout() {
      localStorage.removeItem('hsk_logged_in');
      localStorage.removeItem('hsk_current_user');
      isLoggedIn = false;
      currentUser = '';
      renderApp();
    }

    // æ ¼å¼åŒ–æ—¥æœŸæ™‚é–“
    function formatDateTime(date) {
      if (!date) return '';
      const d = new Date(date);
      return d.getFullYear() + '-' +
        String(d.getMonth() + 1).padStart(2, '0') + '-' +
        String(d.getDate()).padStart(2, '0') + ' ' +
        String(d.getHours()).padStart(2, '0') + ':' +
        String(d.getMinutes()).padStart(2, '0');
    }

    // é©—è­‰ç”¨æˆ¶ï¼ˆå¾ Google Sheets çš„ User å·¥ä½œè¡¨é©—è­‰ï¼‰
    // âš ï¸ é‡è¦ï¼šç”¨æˆ¶åå’Œå¯†ç¢¼å¿…é ˆèˆ‡ Google Sheets ä¸Šçš„å®Œå…¨ä¸€è‡´æ‰èƒ½ç™»å…¥
    // âš ï¸ ä¸å…è¨±ä»»ä½•å›é€€ç™»å…¥ - å¿…é ˆå¾ Google Sheets é©—è­‰
    async function authenticateUser(username, password) {
      const apiUrl = window.getGoogleScriptUrl ? window.getGoogleScriptUrl() : '';

      // ç”¨æˆ¶åå»é™¤å‰å¾Œç©ºç™½ï¼ˆç¢ºä¿ç²¾ç¢ºåŒ¹é…ï¼‰
      const trimmedUsername = username.trim();

      // æª¢æŸ¥æœ¬åœ°æ˜¯å¦å·²è¨˜éŒ„é–å®š
      if (lockedAccounts[trimmedUsername]) {
        return {
          success: false,
          message: 'å¸³è™Ÿå·²è¢«é–å®š',
          locked: true,
          lockTime: lockedAccounts[trimmedUsername]
        };
      }

      // âš ï¸ å¿…é ˆè¨­ç½® API URL æ‰èƒ½ç™»å…¥
      if (!apiUrl) {
        return {
          success: false,
          message: 'å°šæœªè¨­ç½® Google Sheets é€£æ¥\nè«‹å…ˆé»æ“Šã€Œè¨­å®šã€æŒ‰éˆ•é…ç½® API URL'
        };
      }

      try {
        console.log('ğŸ” æ­£åœ¨é©—è­‰ç”¨æˆ¶:', trimmedUsername);

        // èª¿ç”¨ Google Apps Script é©—è­‰ç”¨æˆ¶
        // âš ï¸ ç”¨æˆ¶åå’Œå¯†ç¢¼å¿…é ˆèˆ‡ Google Sheetsã€ŒUserã€å·¥ä½œè¡¨å®Œå…¨ä¸€è‡´
        const response = await fetch(apiUrl + '?action=verifyUser&username=' + encodeURIComponent(trimmedUsername) + '&password=' + encodeURIComponent(password), {
          method: 'GET',
          redirect: 'follow',
          cache: 'no-cache'
        });

        // æª¢æŸ¥å›æ‡‰ç‹€æ…‹
        if (!response.ok) {
          console.error('API response not ok:', response.status);
          return {
            success: false,
            message: 'API é€£æ¥å¤±æ•— (HTTP ' + response.status + ')\nè«‹ç¢ºèª Google Apps Script å·²æ­£ç¢ºéƒ¨ç½²'
          };
        }

        const result = await response.json();
        console.log('ğŸ” é©—è­‰çµæœ:', result);

        // âš ï¸ åš´æ ¼æª¢æŸ¥ï¼šå¿…é ˆæ˜¯èªè­‰å›æ‡‰ï¼ˆæœ‰ authenticated æ¬„ä½ï¼‰ï¼Œä¸èƒ½æ˜¯è³‡æ–™å›æ‡‰
        // è³‡æ–™è…³æœ¬æœƒè¿”å› { success: true, data: [...] }ï¼Œé€™ä¸æ˜¯æœ‰æ•ˆçš„èªè­‰å›æ‡‰
        if (result.data !== undefined || result.authenticated === undefined) {
          // é€™æ˜¯è³‡æ–™å›æ‡‰ï¼Œä¸æ˜¯èªè­‰å›æ‡‰ - è¡¨ç¤ºè…³æœ¬æœªæ­£ç¢ºè¨­ç½®èªè­‰åŠŸèƒ½
          console.error('âŒ æ”¶åˆ°è³‡æ–™å›æ‡‰è€Œéèªè­‰å›æ‡‰ï¼Œè«‹ç¢ºèª Google Apps Script åŒ…å«ç”¨æˆ¶é©—è­‰åŠŸèƒ½');
          return {
            success: false,
            message: 'Google Apps Script æœªæ­£ç¢ºè¨­ç½®\n\nè«‹ç¢ºèªæ‚¨çš„è…³æœ¬åŒ…å«ç”¨æˆ¶é©—è­‰åŠŸèƒ½ï¼ˆverifyUser actionï¼‰\n\nè«‹åƒè€ƒ AUTH_SETUP_GUIDE.md è¨­ç½®èªè­‰è…³æœ¬'
          };
        }

        if (result.success && result.authenticated === true) {
          // ç™»å…¥æˆåŠŸ - è¨˜éŒ„ç™»å…¥æ­·å²
          recordLoginHistory(trimmedUsername, true);
          return { success: true };
        } else {
          // ç™»å…¥å¤±æ•—
          // æª¢æŸ¥æ˜¯å¦è¢«é–å®š
          if (result.locked) {
            lockedAccounts[trimmedUsername] = result.lockTime;
            return {
              success: false,
              message: 'å¸³è™Ÿå·²è¢«é–å®šæ–¼ ' + result.lockTime,
              locked: true,
              lockTime: result.lockTime
            };
          }

          // è¨˜éŒ„å¤±æ•—å˜—è©¦
          recordLoginHistory(trimmedUsername, false);

          return {
            success: false,
            message: result.message || 'å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤\nâš ï¸ è«‹ç¢ºèªèˆ‡ Google Sheetsã€ŒUserã€å·¥ä½œè¡¨ä¸­çš„è³‡æ–™å®Œå…¨ä¸€è‡´',
            attemptsRemaining: result.attemptsRemaining
          };
        }
      } catch (error) {
        console.error('Authentication error:', error);

        // âš ï¸ API èª¿ç”¨å¤±æ•—æ™‚ï¼Œä¸å…è¨±ç™»å…¥ï¼ˆç„¡å›é€€æ©Ÿåˆ¶ï¼‰
        return {
          success: false,
          message: 'é€£ç·š Google Sheets å¤±æ•—\n\nå¯èƒ½åŸå› ï¼š\n1. ç¶²è·¯é€£æ¥å•é¡Œ\n2. Google Apps Script URL éŒ¯èª¤\n3. è…³æœ¬æœªæ­£ç¢ºéƒ¨ç½²\n\nè«‹æª¢æŸ¥è¨­å®šå¾Œé‡è©¦'
        };
      }
    }

    // è¨˜éŒ„ç™»å…¥æ­·å²åˆ° Google Sheets
    async function recordLoginHistory(username, success) {
      const apiUrl = window.getGoogleScriptUrl ? window.getGoogleScriptUrl() : '';
      if (!apiUrl) return;

      try {
        await fetch(apiUrl + '?action=recordLoginHistory&username=' + encodeURIComponent(username) + '&success=' + success + '&timestamp=' + encodeURIComponent(new Date().toISOString()));
      } catch (error) {
        console.error('Failed to record login history:', error);
      }
    }

    // ç²å–ç™»å…¥æ­·å²
    async function fetchLoginHistory() {
      const apiUrl = window.getGoogleScriptUrl ? window.getGoogleScriptUrl() : '';
      if (!apiUrl) {
        loginHistoryData = [
          { username: 'admin', success: true, timestamp: new Date().toISOString(), ip: '127.0.0.1' }
        ];
        return;
      }

      try {
        const response = await fetch(apiUrl + '?action=getLoginHistory');
        const result = await response.json();
        if (result.success) {
          loginHistoryData = result.history || [];
        }
      } catch (error) {
        console.error('Failed to fetch login history:', error);
        loginHistoryData = [];
      }
    }

    // ä¿å­˜æ”¶è—åˆ° localStorage
    function saveFavorites() {
      localStorage.setItem('hsk_favorites', JSON.stringify(favoriteWords));
    }

    // æ·»åŠ åˆ°æ”¶è—
    function addToFavorites(wordId) {
      if (!favoriteWords.includes(wordId)) {
        favoriteWords.push(wordId);
        saveFavorites();
        return true;
      }
      return false;
    }

    // å¾æ”¶è—ç§»é™¤
    function removeFromFavorites(wordId) {
      const index = favoriteWords.indexOf(wordId);
      if (index > -1) {
        favoriteWords.splice(index, 1);
        saveFavorites();
        return true;
      }
      return false;
    }

    // æª¢æŸ¥æ˜¯å¦å·²æ”¶è—
    function isFavorite(wordId) {
      return favoriteWords.includes(wordId);
    }

    // ç²å–æ”¶è—çš„ç”Ÿè©
    function getFavoriteWords() {
      return allWords.filter(w => favoriteWords.includes(w.id));
    }

    // æ‹¼éŸ³è½‰è‹±æ–‡å­—æ¯ï¼ˆå»é™¤è²èª¿ï¼‰ç”¨æ–¼æœç´¢
    function normalizePinyin(pinyin) {
      if (!pinyin) return '';
      const toneMap = {
        'Ä': 'a', 'Ã¡': 'a', 'Ç': 'a', 'Ã ': 'a',
        'Ä“': 'e', 'Ã©': 'e', 'Ä›': 'e', 'Ã¨': 'e',
        'Ä«': 'i', 'Ã­': 'i', 'Ç': 'i', 'Ã¬': 'i',
        'Å': 'o', 'Ã³': 'o', 'Ç’': 'o', 'Ã²': 'o',
        'Å«': 'u', 'Ãº': 'u', 'Ç”': 'u', 'Ã¹': 'u',
        'Ç–': 'v', 'Ç˜': 'v', 'Çš': 'v', 'Çœ': 'v', 'Ã¼': 'v',
        'Å„': 'n', 'Åˆ': 'n', 'Ç¹': 'n'
      };

      let result = pinyin.toLowerCase();
      for (const [tone, base] of Object.entries(toneMap)) {
        result = result.replace(new RegExp(tone, 'g'), base);
      }
      result = result.replace(/[1-4]/g, '');
      result = result.replace(/\s+/g, '');
      return result;
    }

    // å¢å¼·æœç´¢åŠŸèƒ½
    function searchWords(query, wordsToSearch) {
      if (!query) return wordsToSearch;

      const normalizedQuery = query.toLowerCase().trim();
      const queryWithoutTones = normalizePinyin(normalizedQuery);

      return wordsToSearch.filter(word => {
        if (word.simplified.includes(normalizedQuery)) return true;
        if (word.traditional.includes(normalizedQuery)) return true;
        if (word.pinyin.toLowerCase().includes(normalizedQuery)) return true;
        if (normalizePinyin(word.pinyin).includes(queryWithoutTones)) return true;
        if (word.thai_meanings.toLowerCase().includes(normalizedQuery)) return true;
        return false;
      });
    }

    // ç°¡ç¹è½‰æ›å°ç…§è¡¨
    const conversionMap = {
      'å­¦': 'å­¸', 'ä¹ ': 'ç¿’', 'å›½': 'åœ‹', 'è¿™': 'é€™', 'é‚£': 'é‚£',
      'é‡Œ': 'è£¡', 'è¯´': 'èªª', 'è¯': 'è©±', 'åƒ': 'åƒ', 'é¥­': 'é£¯',
      'å–': 'å–', 'èŒ¶': 'èŒ¶', 'ä¹°': 'è²·', 'ä¸œ': 'æ±', 'è¥¿': 'è¥¿',
      'é—¨': 'é–€', 'å¼€': 'é–‹', 'å…³': 'é—œ', 'ä¹¦': 'æ›¸', 'çœ‹': 'çœ‹',
      'è¯»': 'è®€', 'å†™': 'å¯«', 'å¬': 'è½', 'ä¼š': 'æœƒ', 'è§': 'è¦‹',
      'æ—¶': 'æ™‚', 'é—´': 'é–“', 'å¤©': 'å¤©', 'æ°”': 'æ°£', 'å€™': 'å€™'
    };

    function convertToTraditional(text) {
      let result = '';
      for (let char of text) {
        result += conversionMap[char] || char;
      }
      return result;
    }

    const dataHandler = {
      onDataChanged(data) {
        allWords = data.sort((a, b) => a.hsk_level - b.hsk_level || a.simplified.localeCompare(b.simplified));
        lastSyncTime = new Date();
        if (!isLoading && currentView !== 'add') {
          renderApp();
        }
      }
    };

    async function onConfigChange(config) {
      const baseSize = config.font_size || defaultConfig.font_size;
      const customFont = config.font_family || defaultConfig.font_family;
      const baseFontStack = 'system-ui, -apple-system, sans-serif';

      document.body.style.backgroundColor = config.background_color || defaultConfig.background_color;
      document.body.style.fontFamily = customFont + ', ' + baseFontStack;
      document.body.style.fontSize = baseSize + 'px';
      document.body.style.color = config.text_color || defaultConfig.text_color;

      renderApp();
    }

    async function initializeSDKs() {
      const elementResult = await window.elementSdk.init({
        defaultConfig,
        onConfigChange,
        mapToCapabilities: (config) => ({
          recolorables: [],
          borderables: [],
          fontEditable: null,
          fontSizeable: null
        }),
        mapToEditPanelValues: (config) => new Map([
          ["site_title", config.site_title || defaultConfig.site_title],
          ["search_placeholder", config.search_placeholder || defaultConfig.search_placeholder]
        ])
      });

      const dataResult = await window.dataSdk.init(dataHandler);

      if (!dataResult.isOk) {
        console.error("Failed to initialize Data SDK");
      }
    }

    function getColors() {
      const config = window.elementSdk?.config || defaultConfig;
      return {
        background: config.background_color || defaultConfig.background_color,
        card: config.card_color || defaultConfig.card_color,
        primary: config.primary_color || defaultConfig.primary_color,
        text: config.text_color || defaultConfig.text_color,
        accent: config.accent_color || defaultConfig.accent_color
      };
    }

    function getFontSize() {
      const config = window.elementSdk?.config || defaultConfig;
      return config.font_size || defaultConfig.font_size;
    }

    function formatSyncTime() {
      if (!lastSyncTime) return 'å°šæœªåŒæ­¥';
      const now = new Date();
      const diff = Math.floor((now - lastSyncTime) / 1000);

      if (diff < 5) return 'å‰›å‰›';
      if (diff < 60) return diff + ' ç§’å‰';
      if (diff < 3600) return Math.floor(diff / 60) + ' åˆ†é˜å‰';
      return lastSyncTime.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' });
    }

    // ç™»å…¥å½ˆçª—æ¸²æŸ“
    function renderLoginModal() {
      // æª¢æŸ¥æ˜¯å¦æœ‰è¢«é–å®šçš„å¸³è™Ÿè¨Šæ¯
      let lockWarningHtml = '';
      const lastAttemptedUser = localStorage.getItem('hsk_last_attempted_user') || '';
      if (lastAttemptedUser && lockedAccounts[lastAttemptedUser]) {
        lockWarningHtml = '<div style="background-color: #fef2f2; border: 1px solid #fecaca; color: #991b1b; padding: 0.75rem; border-radius: 0.5rem; font-size: 0.813rem; text-align: center;">' +
          '<div style="font-weight: 600; margin-bottom: 0.25rem;">ğŸ”’ å¸³è™Ÿå·²è¢«é–å®š</div>' +
          '<div>é–å®šæ–¼ï¼š' + lockedAccounts[lastAttemptedUser] + '</div>' +
          '<div style="font-size: 0.75rem; margin-top: 0.25rem; opacity: 0.8;">è«‹è¯ç¹«ç®¡ç†å“¡è§£é–</div>' +
        '</div>';
      }

      return '<div class="login-overlay" id="login-overlay">' +
          '<div class="login-modal">' +
            '<div style="display: flex; flex-direction: column; gap: 1.5rem;">' +
              '<div style="display: flex; justify-content: center;">' +
                '<img src="/hsk-learning-system/logo.png" alt="HSK Logo" style="width: 80px; height: 80px; object-fit: contain; border-radius: 50%;" onerror="this.style.display=\'none\'">' +
              '</div>' +
              '<h1 style="text-align: center; font-size: 1.25rem; font-weight: 600; color: #1f2937; margin: 0;">' +
                'è«‹ç™»å…¥ä»¥ç¹¼çºŒä½¿ç”¨' +
              '</h1>' +
              lockWarningHtml +
              '<form id="login-form" style="display: flex; flex-direction: column; gap: 1rem;">' +
                '<div>' +
                  '<label style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.5rem;">' +
                    'ç”¨æˆ¶å' +
                  '</label>' +
                  '<input type="text" id="login-username" class="login-input" placeholder="è«‹è¼¸å…¥ç”¨æˆ¶å" required autocomplete="username">' +
                '</div>' +
                '<div>' +
                  '<label style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.5rem;">' +
                    'å¯†ç¢¼' +
                  '</label>' +
                  '<input type="password" id="login-password" class="login-input" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" required autocomplete="current-password">' +
                '</div>' +
                (loginError ? '<div class="login-error">' + loginError + '</div>' : '') +
                '<button type="submit" id="login-submit-btn" class="login-btn login-btn-primary" ' + (isLoggingIn ? 'disabled' : '') + '>' +
                  (isLoggingIn ? 'ç™»å…¥ä¸­...' : 'ç™»å…¥') +
                '</button>' +
              '</form>' +
              '<div style="text-align: center; font-size: 0.75rem; color: #9ca3af;">' +
                'ç‰ˆæ¬Šè²æ˜ Copyright Â©2010 Shihua Chinese Language School ç‹®ååè¯­å­¦æ ¡<br><a href="https://www.facebook.com/SHChineseLanguageSchool">https://www.facebook.com/SHChineseLanguageSchool</a><br><span style="color: #ef4444;">âš ï¸ ç”¨æˆ¶åå’Œå¯†ç¢¼å¿…é ˆèˆ‡å®Œå…¨ä¸€è‡´</span>' +
              '</div>' +
            '</div>' +
          '</div>' +
        '</div>';
    }

    function renderSyncIndicator(colors, baseSize) {
      const hasUrl = window.getGoogleScriptUrl && window.getGoogleScriptUrl();
      return '<div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background-color: ' + colors.card + '; border-radius: 0.5rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">' +
          '<div class="sync-indicator" style="width: 8px; height: 8px; background-color: ' + (hasUrl ? colors.accent : '#ef4444') + '; border-radius: 50%;"></div>' +
          '<div style="font-size: ' + (baseSize * 0.85) + 'px; color: ' + colors.text + '; flex: 1;">' +
            '<span style="font-weight: 600;">' + (hasUrl ? 'Google Sheets å·²é€£çµ' : 'Google Sheets æœªé€£çµ') + '</span>' +
            '<span class="sync-time" style="opacity: 0.6; margin-left: 0.5rem;">' + (hasUrl ? 'æœ€å¾ŒåŒæ­¥ï¼š' + formatSyncTime() : '') + '</span>' +
          '</div>' +
          '<button id="settings-btn" style="background-color: ' + colors.primary + '; color: white; padding: 0.25rem 0.75rem; border-radius: 0.5rem; border: none; cursor: pointer; font-size: ' + (baseSize * 0.8) + 'px;">' +
            'âš™ï¸ è¨­å®š' +
          '</button>' +
        '</div>';
    }

    function renderApp() {
      const app = document.getElementById('app');
      const colors = getColors();
      const baseSize = getFontSize();
      const config = window.elementSdk?.config || defaultConfig;

      // ç™»å…¥æª¢æŸ¥
      if (!isLoggedIn) {
        app.innerHTML = renderLoginModal();
        attachLoginListeners();
        return;
      }

      if (currentView === 'home') {
        app.innerHTML = renderHome(colors, baseSize, config);
      } else if (currentView === 'browse') {
        app.innerHTML = renderBrowse(colors, baseSize, config);
      } else if (currentView === 'favorites') {
        app.innerHTML = renderFavorites(colors, baseSize, config);
      } else if (currentView === 'study') {
        app.innerHTML = renderStudy(colors, baseSize, config);
      } else if (currentView === 'test') {
        app.innerHTML = renderTest(colors, baseSize, config);
      } else if (currentView === 'multiple-choice') {
        app.innerHTML = renderMultipleChoice(colors, baseSize, config);
      } else if (currentView === 'speed-challenge') {
        app.innerHTML = renderSpeedChallenge(colors, baseSize, config);
      } else if (currentView === 'matching') {
        app.innerHTML = renderMatching(colors, baseSize, config);
      } else if (currentView === 'listening') {
        app.innerHTML = renderListening(colors, baseSize, config);
      } else if (currentView === 'results') {
        app.innerHTML = renderResults(colors, baseSize, config);
      }

      attachEventListeners();
    }

    // ç™»å…¥è¡¨å–®ç›£è½
    function attachLoginListeners() {
      const loginForm = document.getElementById('login-form');
      const usernameInput = document.getElementById('login-username');

      // é å¡«ä¸Šæ¬¡å˜—è©¦çš„ç”¨æˆ¶å
      const lastAttemptedUser = localStorage.getItem('hsk_last_attempted_user') || '';
      if (usernameInput && lastAttemptedUser) {
        usernameInput.value = lastAttemptedUser;
      }

      if (loginForm) {
        loginForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          // ç¢ºä¿ç”¨æˆ¶åå’Œå¯†ç¢¼å®Œå…¨åŒ¹é…ï¼ˆç§»é™¤å‰å¾Œç©ºç™½ï¼Œä½†ä¿ç•™ä¸­é–“ç©ºæ ¼ï¼‰
          const username = usernameInput.value.trim();
          const password = document.getElementById('login-password').value;

          // å„²å­˜å˜—è©¦çš„ç”¨æˆ¶å
          localStorage.setItem('hsk_last_attempted_user', username);

          // æª¢æŸ¥æ˜¯å¦å·²è¢«é–å®š
          if (lockedAccounts[username]) {
            loginError = 'å¸³è™Ÿå·²è¢«é–å®šæ–¼ ' + lockedAccounts[username] + 'ï¼Œè«‹è¯ç¹«ç®¡ç†å“¡';
            renderApp();
            return;
          }

          isLoggingIn = true;
          loginError = '';
          renderApp();

          const result = await authenticateUser(username, password);

          isLoggingIn = false;

          if (result.success) {
            // æ¸…é™¤å˜—è©¦è¨˜éŒ„
            localStorage.removeItem('hsk_last_attempted_user');
            login(username, password);
            loginError = '';
            renderApp();
          } else {
            // è™•ç†é–å®šç‹€æ…‹
            if (result.locked) {
              lockedAccounts[username] = result.lockTime;
              loginError = 'å¸³è™Ÿå·²è¢«é–å®šæ–¼ ' + result.lockTime;
            } else {
              loginError = result.message || 'ç™»å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥å¸³è™Ÿå¯†ç¢¼';
            }
            renderApp();
          }
        });
      }
    }

    function renderHome(colors, baseSize, config) {
      const levelCounts = Array(9).fill(0);
      allWords.forEach(word => {
        if (word.hsk_level >= 1 && word.hsk_level <= 9) {
          levelCounts[word.hsk_level - 1]++;
        }
      });

      let html = '<div class="w-full min-h-full" style="background-color: ' + colors.background + '; padding: 2rem;">';
      html += '<div style="max-width: 1200px; margin: 0 auto;">';

      // Header with title and sync indicator
      html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem;">';
      html += '<div style="text-align: center; flex: 1;">';
      html += '<div style="display: flex; align-items: center; justify-content: center; gap: 1rem; margin-bottom: 0.5rem;">';
      html += '<img src="/hsk-learning-system/logo.png" alt="HSK Logo" style="width: ' + (baseSize * 3) + 'px; height: ' + (baseSize * 3) + 'px; object-fit: contain; border-radius: 50%;" onerror="this.style.display=\'none\'">';
      html += '<h1 style="font-size: ' + (baseSize * 2.5) + 'px; font-weight: bold; color: ' + colors.text + '; margin: 0;">' + ((config && config.site_title) || defaultConfig.site_title) + '</h1>';
      html += '</div>';
      html += '<p style="font-size: ' + (baseSize * 1.1) + 'px; color: ' + colors.text + '; opacity: 0.7;">å°ˆæ¥­çš„ HSK 3.0 ç”Ÿè©å­¸ç¿’å¹³å° Thai-Chinese V.202601050900</p>';
      html += '<p style="font-size: ' + (baseSize * 1.1) + 'px; color: ' + colors.text + '; opacity: 0.7;"><a href="https://www.facebook.com/SHChineseLanguageSchool">https://www.facebook.com/SHChineseLanguageSchool</a></p>';
      html += '</div>';
      html += renderSyncIndicator(colors, baseSize);
      html += '</div>';

      // User info and logout button
      html += '<div style="background-color: ' + colors.card + '; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.5rem;">';
      html += '<div style="font-size: ' + baseSize + 'px; color: ' + colors.text + ';">æ­¡è¿ï¼Œ<strong>' + currentUser + '</strong></div>';
      html += '<div style="display: flex; gap: 0.5rem;">';
      html += '<button id="login-history-btn" style="padding: 0.5rem 1rem; background-color: ' + colors.primary + '; color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-size: ' + (baseSize * 0.9) + 'px;">ğŸ“‹ ç™»å…¥è¨˜éŒ„</button>';
      html += '<button id="logout-btn" style="padding: 0.5rem 1rem; background-color: #ef4444; color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-size: ' + (baseSize * 0.9) + 'px;">ç™»å‡º</button>';
      html += '</div>';
      html += '</div>';

      // Login history modal
      if (showLoginHistory) {
        html += '<div id="login-history-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 2000; padding: 1rem;">';
        html += '<div style="background-color: ' + colors.card + '; padding: 2rem; border-radius: 1rem; max-width: 700px; width: 100%; max-height: 80%; overflow-y: auto; box-shadow: 0 20px 25px rgba(0,0,0,0.3);">';
        html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">';
        html += '<h2 style="font-size: ' + (baseSize * 1.5) + 'px; font-weight: bold; color: ' + colors.text + ';">ğŸ“‹ ç™»å…¥æ­·å²è¨˜éŒ„</h2>';
        html += '<button id="close-login-history-btn" style="background-color: transparent; border: none; font-size: ' + (baseSize * 1.5) + 'px; color: ' + colors.text + '; cursor: pointer; padding: 0.25rem; line-height: 1;">âœ•</button>';
        html += '</div>';

        if (loginHistoryData.length > 0) {
          html += '<div style="overflow-x: auto;">';
          html += '<table style="width: 100%; border-collapse: collapse; font-size: ' + (baseSize * 0.9) + 'px;">';
          html += '<thead>';
          html += '<tr style="background-color: ' + colors.background + ';">';
          html += '<th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid ' + colors.primary + ';">æ™‚é–“</th>';
          html += '<th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid ' + colors.primary + ';">ç”¨æˆ¶å</th>';
          html += '<th style="padding: 0.75rem; text-align: center; border-bottom: 2px solid ' + colors.primary + ';">ç‹€æ…‹</th>';
          html += '<th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid ' + colors.primary + ';">IP</th>';
          html += '</tr>';
          html += '</thead>';
          html += '<tbody>';
          loginHistoryData.forEach(function(record) {
            const statusColor = record.success ? colors.accent : '#ef4444';
            const statusText = record.success ? 'æˆåŠŸ' : 'å¤±æ•—';
            html += '<tr style="border-bottom: 1px solid #e5e5e5;">';
            html += '<td style="padding: 0.75rem; color: ' + colors.text + ';">' + formatDateTime(record.timestamp) + '</td>';
            html += '<td style="padding: 0.75rem; color: ' + colors.text + '; font-weight: 500;">' + record.username + '</td>';
            html += '<td style="padding: 0.75rem; text-align: center;"><span style="background-color: ' + statusColor + '; color: white; padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: ' + (baseSize * 0.8) + 'px;">' + statusText + '</span></td>';
            html += '<td style="padding: 0.75rem; color: ' + colors.text + '; opacity: 0.7;">' + (record.ip || '-') + '</td>';
            html += '</tr>';
          });
          html += '</tbody>';
          html += '</table>';
          html += '</div>';
        } else {
          html += '<div style="text-align: center; padding: 2rem; color: ' + colors.text + '; opacity: 0.7;">æš«ç„¡ç™»å…¥è¨˜éŒ„</div>';
        }

        html += '</div>';
        html += '</div>';
      }

      // Google Sheets info card
      html += '<div style="background-color: ' + colors.card + '; padding: 1.5rem; border-radius: 1rem; margin-bottom: 2rem; border-left: 4px solid ' + colors.accent + ';">';
      html += '<div style="display: flex; align-items: start; gap: 1rem;">';
      html += '<div style="font-size: ' + (baseSize * 2) + 'px;">ğŸ“Š</div>';
      html += '<div style="flex: 1;">';
      html += '<h3 style="font-size: ' + (baseSize * 1.2) + 'px; font-weight: bold; color: ' + colors.text + '; margin-bottom: 0.5rem;">Google Sheets é›™å‘åŒæ­¥å·²å•Ÿç”¨</h3>';
      html += '<p style="font-size: ' + (baseSize * 0.9) + 'px; color: ' + colors.text + '; opacity: 0.8; margin-bottom: 0.75rem;">æ‚¨çš„ç”Ÿè©è³‡æ–™æœƒè‡ªå‹•å„²å­˜åˆ° Google Sheetsã€‚</p>';
      html += '</div></div></div>';

      // Action cards
      html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-bottom: 3rem;">';

      html += '<div class="action-card" data-action="browse" style="background-color: ' + colors.card + '; padding: 2rem; border-radius: 1rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); cursor: pointer; transition: transform 0.2s;">';
      html += '<div style="font-size: ' + (baseSize * 2) + 'px; margin-bottom: 1rem;">ğŸ“š</div>';
      html += '<h3 style="font-size: ' + (baseSize * 1.3) + 'px; font-weight: bold; color: ' + colors.text + '; margin-bottom: 0.5rem;">ç€è¦½ç”Ÿè©</h3>';
      html += '<p style="font-size: ' + (baseSize * 0.9) + 'px; color: ' + colors.text + '; opacity: 0.7;">æŸ¥çœ‹å’Œæœå°‹æ‰€æœ‰ç”Ÿè©</p>';
      html += '</div>';

      html += '<div class="action-card" data-action="favorites" style="background-color: ' + colors.card + '; padding: 2rem; border-radius: 1rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); cursor: pointer; transition: transform 0.2s;">';
      html += '<div style="font-size: ' + (baseSize * 2) + 'px; margin-bottom: 1rem;">â­</div>';
      html += '<h3 style="font-size: ' + (baseSize * 1.3) + 'px; font-weight: bold; color: ' + colors.text + '; margin-bottom: 0.5rem;">æ”¶è—ç”Ÿè©åº«</h3>';
      html += '<p style="font-size: ' + (baseSize * 0.9) + 'px; color: ' + colors.text + '; opacity: 0.7;">ç®¡ç†æ”¶è—çš„ç”Ÿè©ä¸¦è¨“ç·´ (' + getFavoriteWords().length + ')</p>';
      html += '</div>';

      html += '<div class="action-card" data-action="study" style="background-color: ' + colors.card + '; padding: 2rem; border-radius: 1rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); cursor: pointer; transition: transform 0.2s;">';
      html += '<div style="font-size: ' + (baseSize * 2) + 'px; margin-bottom: 1rem;">âœï¸</div>';
      html += '<h3 style="font-size: ' + (baseSize * 1.3) + 'px; font-weight: bold; color: ' + colors.text + '; margin-bottom: 0.5rem;">è¨“ç·´æ¨¡å¼</h3>';
      html += '<p style="font-size: ' + (baseSize * 0.9) + 'px; color: ' + colors.text + '; opacity: 0.7;">ä½¿ç”¨ç”Ÿè©å¡ç·´ç¿’è¨˜æ†¶</p>';
      html += '</div>';

      html += '</div>';

      // HSK Level stats
      html += '<div style="background-color: ' + colors.card + '; padding: 2rem; border-radius: 1rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">';
      html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">';
      html += '<h2 style="font-size: ' + (baseSize * 1.5) + 'px; font-weight: bold; color: ' + colors.text + '; margin: 0;">HSK ç­‰ç´šçµ±è¨ˆ</h2>';
      html += '<button id="manage-levels-btn" style="padding: 0.5rem 1rem; background-color: ' + colors.primary + '; color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-size: ' + (baseSize * 0.9) + 'px;">ç®¡ç†ç­‰ç´š</button>';
      html += '</div>';
      html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 1rem;">';

      customLevels.forEach(function(level) {
        let count = 0;
        if (level.id === '7-9') {
          count = allWords.filter(w => w.hsk_level >= 7 && w.hsk_level <= 9).length;
        } else {
          count = allWords.filter(w => w.hsk_level === level.value).length;
        }
        html += '<div style="text-align: center; padding: 1rem; background-color: ' + colors.background + '; border-radius: 0.5rem;">';
        html += '<div style="font-size: ' + (baseSize * 1.8) + 'px; font-weight: bold; color: ' + colors.primary + ';">' + count + '</div>';
        html += '<div style="font-size: ' + (baseSize * 0.85) + 'px; color: ' + colors.text + '; opacity: 0.7; margin-top: 0.25rem;">' + level.label + '</div>';
        html += '</div>';
      });

      html += '</div></div>';
html += '<div style="text-align: center; font-size: 0.75rem; color: #9ca3af; margin-top: 2rem; line-height: 1.5;">ç‰ˆæ¬Šè²æ˜ Copyright Â©2010 Shihua Chinese Language School ç‹®ååè¯­å­¦æ ¡<br><a href="https://www.facebook.com/SHChineseLanguageSchool">https://www.facebook.com/SHChineseLanguageSchool</a></div>';
      // Manage Levels Modal
      if (showManageLevelModal) {
        html += '<div id="manage-level-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 2000; padding: 1rem;">';
        html += '<div style="background-color: ' + colors.card + '; padding: 2rem; border-radius: 1rem; max-width: 600px; width: 100%; max-height: 80%; overflow-y: auto; box-shadow: 0 20px 25px rgba(0,0,0,0.3);">';
        html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">';
        html += '<h2 style="font-size: ' + (baseSize * 1.5) + 'px; font-weight: bold; color: ' + colors.text + ';">ç®¡ç† HSK ç­‰ç´š</h2>';
        html += '<button id="close-manage-level-btn" style="background-color: transparent; border: none; font-size: ' + (baseSize * 1.5) + 'px; color: ' + colors.text + '; cursor: pointer; padding: 0.25rem; line-height: 1;">âœ•</button>';
        html += '</div>';

        // Add new level form
        html += '<div style="background-color: ' + colors.background + '; padding: 1.5rem; border-radius: 0.5rem; margin-bottom: 1.5rem;">';
        html += '<h3 style="font-size: ' + (baseSize * 1.1) + 'px; font-weight: bold; color: ' + colors.text + '; margin-bottom: 1rem;">æ–°å¢ç­‰ç´š</h3>';
        html += '<div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 1rem; align-items: end;">';
        html += '<div>';
        html += '<label style="display: block; font-size: ' + (baseSize * 0.85) + 'px; color: ' + colors.text + '; margin-bottom: 0.25rem;">ç­‰ç´šåç¨±</label>';
        html += '<input type="text" id="new-level-label" placeholder="ä¾‹å¦‚ï¼šHSK 10" style="width: 100%; padding: 0.75rem; border: 1px solid #e5e5e5; border-radius: 0.5rem; font-size: ' + baseSize + 'px;">';
        html += '</div>';
        html += '<div>';
        html += '<label style="display: block; font-size: ' + (baseSize * 0.85) + 'px; color: ' + colors.text + '; margin-bottom: 0.25rem;">æ•¸å€¼ (HSK Level)</label>';
        html += '<input type="number" id="new-level-value" placeholder="ä¾‹å¦‚ï¼š10" min="1" max="20" style="width: 100%; padding: 0.75rem; border: 1px solid #e5e5e5; border-radius: 0.5rem; font-size: ' + baseSize + 'px;">';
        html += '</div>';
        html += '<button id="add-level-btn" style="padding: 0.75rem 1.5rem; background-color: ' + colors.accent + '; color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-size: ' + baseSize + 'px; white-space: nowrap;">æ–°å¢</button>';
        html += '</div>';
        html += '</div>';

        // Existing levels list
        html += '<h3 style="font-size: ' + (baseSize * 1.1) + 'px; font-weight: bold; color: ' + colors.text + '; margin-bottom: 1rem;">ç¾æœ‰ç­‰ç´š</h3>';
        html += '<div style="display: flex; flex-direction: column; gap: 0.75rem;">';

        customLevels.forEach(function(level, index) {
          let count = 0;
          if (level.id === '7-9') {
            count = allWords.filter(w => w.hsk_level >= 7 && w.hsk_level <= 9).length;
          } else {
            count = allWords.filter(w => w.hsk_level === level.value).length;
          }

          html += '<div style="display: flex; align-items: center; gap: 1rem; padding: 1rem; background-color: ' + colors.background + '; border-radius: 0.5rem;">';
          html += '<div style="flex: 1;">';
          html += '<div style="font-weight: bold; color: ' + colors.text + ';">' + level.label + '</div>';
          html += '<div style="font-size: ' + (baseSize * 0.85) + 'px; color: ' + colors.text + '; opacity: 0.7;">æ•¸å€¼ï¼š' + level.value + ' | ç”Ÿè©æ•¸ï¼š' + count + '</div>';
          html += '</div>';
          html += '<button class="edit-level-btn" data-index="' + index + '" style="padding: 0.5rem 1rem; background-color: ' + colors.primary + '; color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-size: ' + (baseSize * 0.85) + 'px;">ç·¨è¼¯</button>';
          html += '<button class="delete-level-btn" data-index="' + index + '" style="padding: 0.5rem 1rem; background-color: #ef4444; color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-size: ' + (baseSize * 0.85) + 'px;">åˆªé™¤</button>';
          html += '</div>';
        });

        html += '</div>';

        // Save to localStorage info
        html += '<div style="margin-top: 1.5rem; padding: 1rem; background-color: #fef3c7; border-radius: 0.5rem; font-size: ' + (baseSize * 0.85) + 'px; color: #92400e;">';
        html += 'ç­‰ç´šè¨­å®šæœƒå„²å­˜åœ¨ç€è¦½å™¨ä¸­ã€‚è‹¥è¦é‡ç½®ç‚ºé è¨­å€¼ï¼Œè«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•ã€‚';
        html += '</div>';
        html += '<button id="reset-levels-btn" style="margin-top: 1rem; padding: 0.75rem 1.5rem; background-color: #9ca3af; color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-size: ' + baseSize + 'px;">é‡ç½®ç‚ºé è¨­</button>';

        html += '</div>';
        html += '</div>';
      }

      html += '</div></div>';
      return html;
    }

    function renderBrowse(colors, baseSize, config) {
      let html = '<div class="w-full min-h-full" style="background-color: ' + colors.background + '; padding: 2rem;">';
      html += '<div style="max-width: 1200px; margin: 0 auto;">';

      html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem;">';
      html += '<h1 style="font-size: ' + (baseSize * 2) + 'px; font-weight: bold; color: ' + colors.text + ';">ç€è¦½ç”Ÿè©</h1>';
      html += '<button class="back-btn" style="padding: 0.75rem 1.5rem; background-color: ' + colors.primary + '; color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-size: ' + baseSize + 'px;">è¿”å›é¦–é </button>';
      html += '</div>';

      html += '<div style="margin-bottom: 2rem;">';
      html += '<input type="text" id="search-input" placeholder="' + ((config && config.search_placeholder) || defaultConfig.search_placeholder) + '" style="width: 100%; padding: 1rem; border: 2px solid ' + colors.primary + '; border-radius: 0.5rem; font-size: ' + baseSize + 'px; background-color: ' + colors.card + '; color: ' + colors.text + ';">';
      html += '</div>';

      html += '<div style="display: flex; gap: 0.5rem; margin-bottom: 2rem; flex-wrap: wrap;">';
      html += '<button class="level-filter" data-level="all" style="padding: 0.5rem 1rem; background-color: ' + colors.primary + '; color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-size: ' + (baseSize * 0.9) + 'px;">å…¨éƒ¨</button>';
      customLevels.forEach(function(level) {
        html += '<button class="level-filter" data-level="' + level.id + '" style="padding: 0.5rem 1rem; background-color: ' + colors.card + '; color: ' + colors.text + '; border: 2px solid ' + colors.primary + '; border-radius: 0.5rem; cursor: pointer; font-size: ' + (baseSize * 0.9) + 'px;">' + level.label + '</button>';
      });
      html += '</div>';

      html += '<div id="words-container" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem;">';
      html += renderWordCards(allWords, colors, baseSize);
      html += '</div>';

      html += '</div></div>';
      return html;
    }

    function renderWordCards(words, colors, baseSize) {
      if (words.length === 0) {
        return '<div style="grid-column: 1/-1; text-align: center; padding: 3rem; color: ' + colors.text + '; opacity: 0.7; font-size: ' + (baseSize * 1.1) + 'px;">å°šç„¡ç”Ÿè©è³‡æ–™</div>';
      }

      let html = '';
      words.forEach(function(word) {
        const meanings = word.thai_meanings ? word.thai_meanings.split('|').filter(m => m.trim()) : [];
        const isFav = isFavorite(word.id);

        html += '<div class="word-card" style="background-color: ' + colors.card + '; padding: 1.5rem; border-radius: 1rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">';
        html += '<div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">';
        html += '<div>';
        html += '<div style="font-size: ' + (baseSize * 1.8) + 'px; font-weight: bold; color: ' + colors.text + '; margin-bottom: 0.25rem;">' + word.simplified + '</div>';
        html += '<div style="font-size: ' + (baseSize * 0.9) + 'px; color: ' + colors.text + '; opacity: 0.6;">' + word.traditional + '</div>';
        html += '</div>';
        html += '<div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">';
        html += '<span style="background-color: ' + colors.primary + '; color: white; padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: ' + (baseSize * 0.8) + 'px;">HSK ' + word.hsk_level + '</span>';
        html += '<button class="favorite-word-btn" data-id="' + word.id + '" style="background-color: ' + (isFav ? '#f59e0b' : colors.background) + '; color: ' + (isFav ? 'white' : colors.text) + '; padding: 0.25rem 0.75rem; border-radius: 0.5rem; border: 1px solid #f59e0b; cursor: pointer; font-size: ' + (baseSize * 0.8) + 'px;">' + (isFav ? 'å·²æ”¶è—' : 'æ”¶è—') + '</button>';
        html += '</div></div>';
        html += '<div style="margin-bottom: 1rem;">';
        html += '<div style="font-size: ' + (baseSize * 1.1) + 'px; color: ' + colors.primary + '; margin-bottom: 0.5rem;">' + word.pinyin + '</div>';
        html += '<div style="font-size: ' + (baseSize * 0.85) + 'px; color: ' + colors.accent + '; font-weight: 600;">' + word.word_type + '</div>';
        html += '</div>';
        if (meanings.length > 0) {
          html += '<div style="margin-bottom: 1rem;">';
          html += '<div style="font-size: ' + (baseSize * 0.9) + 'px; font-weight: bold; color: ' + colors.text + '; margin-bottom: 0.5rem;">æ³°æ–‡ç¿»è­¯ï¼š</div>';
          meanings.forEach(function(m) {
            html += '<div style="font-size: ' + (baseSize * 0.85) + 'px; color: ' + colors.text + '; opacity: 0.8; margin-bottom: 0.25rem;">â€¢ ' + m.trim() + '</div>';
          });
          html += '</div>';
        }
        html += '</div>';
      });
      return html;
    }

    function renderFavorites(colors, baseSize, config) {
      const favWords = getFavoriteWords();
      let html = '<div class="w-full min-h-full" style="background-color: ' + colors.background + '; padding: 2rem;">';
      html += '<div style="max-width: 1200px; margin: 0 auto;">';
      html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem;">';
      html += '<h1 style="font-size: ' + (baseSize * 2) + 'px; font-weight: bold; color: ' + colors.text + ';">â­ æ”¶è—ç”Ÿè©åº«</h1>';
      html += '<button class="back-btn" style="padding: 0.75rem 1.5rem; background-color: ' + colors.primary + '; color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-size: ' + baseSize + 'px;">è¿”å›é¦–é </button>';
      html += '</div>';
      if (favWords.length > 0) {
        html += '<div style="display: flex; gap: 1rem; margin-bottom: 2rem; flex-wrap: wrap;">';
        html += '<button id="train-favorites-btn" style="padding: 1rem 2rem; background-color: ' + colors.accent + '; color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-size: ' + baseSize + 'px; font-weight: bold;">è¨“ç·´æ”¶è—ç”Ÿè© (' + favWords.length + ')</button>';
        html += '<button id="clear-favorites-btn" style="padding: 1rem 2rem; background-color: #ef4444; color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-size: ' + baseSize + 'px;">æ¸…ç©ºæ”¶è—</button>';
        html += '</div>';
        html += '<div id="favorites-container" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem;">';
        html += renderWordCards(favWords, colors, baseSize);
        html += '</div>';
      } else {
        html += '<div style="text-align: center; padding: 4rem; background-color: ' + colors.card + '; border-radius: 1rem;">';
        html += '<div style="font-size: ' + (baseSize * 3) + 'px; margin-bottom: 1rem;">â­</div>';
        html += '<h3 style="font-size: ' + (baseSize * 1.5) + 'px; font-weight: bold; color: ' + colors.text + '; margin-bottom: 1rem;">å°šç„¡æ”¶è—çš„ç”Ÿè©</h3>';
        html += '<button class="go-browse-btn" style="padding: 1rem 2rem; background-color: ' + colors.primary + '; color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-size: ' + baseSize + 'px;">å‰å¾€ç€è¦½ç”Ÿè©</button>';
        html += '</div>';
      }
      html += '</div></div>';
      return html;
    }

    function renderStudy(colors, baseSize, config) {
      if (!selectedLevel) {
        let html = '<div class="w-full min-h-full" style="background-color: ' + colors.background + '; padding: 2rem;">';
        html += '<div style="max-width: 800px; margin: 0 auto;">';
        html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">';
        html += '<h1 style="font-size: ' + (baseSize * 2) + 'px; font-weight: bold; color: ' + colors.text + ';">é¸æ“‡è¨“ç·´ç­‰ç´š</h1>';
        html += '<button class="back-btn" style="padding: 0.75rem 1.5rem; background-color: ' + colors.primary + '; color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-size: ' + baseSize + 'px;">è¿”å›é¦–é </button>';
        html += '</div>';
        html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">';
        const favWords = getFavoriteWords();
        html += '<button class="select-level-btn" data-level="favorites" ' + (favWords.length === 0 ? 'disabled' : '') + ' style="padding: 2rem 1rem; background-color: ' + colors.card + '; color: ' + colors.text + '; border: 2px solid #f59e0b; border-radius: 1rem; cursor: ' + (favWords.length === 0 ? 'not-allowed' : 'pointer') + '; opacity: ' + (favWords.length === 0 ? '0.5' : '1') + ';">';
        html += '<div style="font-size: ' + (baseSize * 1.5) + 'px; font-weight: bold; margin-bottom: 0.5rem;">â­ æ”¶è—ç”Ÿè©</div>';
        html += '<div style="font-size: ' + (baseSize * 0.9) + 'px; opacity: 0.7;">' + favWords.length + ' å€‹ç”Ÿè©</div>';
        html += '</button>';
        customLevels.forEach(function(level) {
          let levelWords;
          if (level.id === '7-9') {
            levelWords = allWords.filter(w => w.hsk_level >= 7 && w.hsk_level <= 9);
          } else {
            levelWords = allWords.filter(w => w.hsk_level === level.value);
          }
          html += '<button class="select-level-btn" data-level="' + level.id + '" ' + (levelWords.length === 0 ? 'disabled' : '') + ' style="padding: 2rem 1rem; background-color: ' + colors.card + '; color: ' + colors.text + '; border: 2px solid ' + colors.primary + '; border-radius: 1rem; cursor: ' + (levelWords.length === 0 ? 'not-allowed' : 'pointer') + '; opacity: ' + (levelWords.length === 0 ? '0.5' : '1') + ';">';
          html += '<div style="font-size: ' + (baseSize * 1.5) + 'px; font-weight: bold; margin-bottom: 0.5rem;">' + level.label + '</div>';
          html += '<div style="font-size: ' + (baseSize * 0.9) + 'px; opacity: 0.7;">' + levelWords.length + ' å€‹ç”Ÿè©</div>';
          html += '</button>';
        });
        html += '</div></div></div>';
       html += '<div style="text-align: center; font-size: 0.75rem; color: #9ca3af; margin-top: 2rem; line-height: 1.5;">ç‰ˆæ¬Šè²æ˜ Copyright Â©2010 Shihua Chinese Language School ç‹®ååè¯­å­¦æ ¡<br><a href="https://www.facebook.com/SHChineseLanguageSchool">https://www.facebook.com/SHChineseLanguageSchool</a></div>';
        return html;
      }

      if (!studyMode) {
        let availableWords;
        if (selectedLevel === 'favorites') {
          availableWords = getFavoriteWords();
        } else if (selectedLevel === '7-9') {
          availableWords = allWords.filter(w => w.hsk_level >= 7 && w.hsk_level <= 9);
        } else {
          const levelConfig = customLevels.find(l => l.id === selectedLevel);
          availableWords = levelConfig ? allWords.filter(w => w.hsk_level === levelConfig.value) : [];
        }
        const maxWords = availableWords.length;

        let html = '<div class="w-full min-h-full" style="background-color: ' + colors.background + '; padding: 2rem;">';
        html += '<div style="max-width: 800px; margin: 0 auto;">';
        html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">';
        html += '<h1 style="font-size: ' + (baseSize * 2) + 'px; font-weight: bold; color: ' + colors.text + ';">' + (selectedLevel === 'favorites' ? 'æ”¶è—ç”Ÿè©' : 'HSK ' + selectedLevel) + ' è¨“ç·´æ¨¡å¼</h1>';
        html += '<button class="back-to-level-btn" style="padding: 0.75rem 1.5rem; background-color: ' + colors.primary + '; color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-size: ' + baseSize + 'px;">è¿”å›</button>';
        html += '</div>';
        html += '<div style="background-color: ' + colors.card + '; padding: 1rem; border-radius: 0.5rem; margin-bottom: 2rem; text-align: center;">';
        html += '<span style="font-size: ' + baseSize + 'px; color: ' + colors.text + ';">å¯è¨“ç·´ç”Ÿè©æ•¸é‡ï¼š<strong style="color: ' + colors.accent + ';">' + maxWords + '</strong> å€‹</span>';
        html += '</div>';
        html += '<div style="display: grid; gap: 1.5rem;">';
        const modes = [
          { mode: 'flashcard', icon: 'ğŸ“‡', title: 'ç”Ÿè©å¡æ¨¡å¼', desc: 'ç€è¦½ç”Ÿè©å¡ï¼Œé»æ“Šç¿»è½‰æŸ¥çœ‹ç¿»è­¯å’Œä¾‹å¥' },
          { mode: 'test', icon: 'âœï¸', title: 'æ¸¬é©—æ¨¡å¼', desc: 'æ¸¬è©¦ä½ çš„è¨˜æ†¶ï¼Œè¼¸å…¥æ­£ç¢ºçš„æ³°æ–‡ç¿»è­¯' },
          { mode: 'multiple-choice', icon: 'ğŸ¯', title: 'é¸æ“‡é¡Œæ¨¡å¼', desc: 'å¾å››å€‹é¸é …ä¸­é¸å‡ºæ­£ç¢ºçš„æ³°æ–‡ç¿»è­¯' },
          { mode: 'speed-challenge', icon: 'âš¡', title: 'é€Ÿåº¦æŒ‘æˆ°', desc: '60ç§’å…§ç­”å°è¶Šå¤šè¶Šå¥½ï¼' },
          { mode: 'matching', icon: 'ğŸ´', title: 'é…å°éŠæˆ²', desc: 'ç¿»ç‰Œæ‰¾å‡ºä¸­æ–‡å’Œæ³°æ–‡çš„é…å°çµ„åˆ' },
          { mode: 'listening', icon: 'ğŸ‘‚', title: 'æ‹¼éŸ³ç·´ç¿’', desc: 'çœ‹æ‹¼éŸ³çŒœä¸­æ–‡ï¼Œè¨“ç·´ç™¼éŸ³è¨˜æ†¶' }
        ];
        modes.forEach(function(m) {
          html += '<button class="select-mode-btn" data-mode="' + m.mode + '" style="padding: 2rem; background-color: ' + colors.card + '; color: ' + colors.text + '; border: 2px solid ' + colors.primary + '; border-radius: 1rem; cursor: pointer; text-align: left;">';
          html += '<div style="font-size: ' + (baseSize * 1.5) + 'px; font-weight: bold; margin-bottom: 0.5rem;">' + m.icon + ' ' + m.title + '</div>';
          html += '<div style="font-size: ' + baseSize + 'px; opacity: 0.7;">' + m.desc + '</div>';
          html += '</button>';
        });
        html += '</div>';
       html += '<div style="text-align: center; font-size: 0.75rem; color: #9ca3af; margin-top: 2rem; line-height: 1.5;">ç‰ˆæ¬Šè²æ˜ Copyright Â©2010 Shihua Chinese Language School ç‹®ååè¯­å­¦æ ¡<br><a href="https://www.facebook.com/SHChineseLanguageSchool">https://www.facebook.com/SHChineseLanguageSchool</a></div>';

        // Word count selection modal
        if (showWordCountModal) {
          const wordCountOptions = [5, 10, 15, 20, 30, 50];
          html += '<div id="word-count-modal" style="position: fixed; top: 0; left: 0; width: 95%; height: 100%; background-color: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 2000; padding: 1rem;">';
          html += '<div style="background-color: ' + colors.card + '; padding: 2rem; border-radius: 1rem; max-width: 100%; width: 100%; box-shadow: 0 20px 25px rgba(0,0,0,0.3);">';
          html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">';
          html += '<h2 style="font-size: ' + (baseSize * 1.5) + 'px; font-weight: bold; color: ' + colors.text + '; margin: 0;">é¸æ“‡è¨“ç·´ç”Ÿè©æ•¸é‡</h2>';
          html += '<button id="cancel-word-count-btn" style="background-color: transparent; border: none; font-size: ' + (baseSize * 1.5) + 'px; color: ' + colors.text + '; cursor: pointer; padding: 0.25rem; line-height: 1;">âœ•</button>';
          html += '</div>';
          html += '<p style="font-size: ' + (baseSize * 0.9) + 'px; color: ' + colors.text + '; opacity: 0.7; margin-bottom: 1.5rem;">å¯é¸ç”Ÿè©æ•¸é‡ï¼š<strong style="color: ' + colors.accent + ';">' + maxWords + '</strong> å€‹</p>';
          html += '<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1.5rem;">';
          wordCountOptions.forEach(function(count) {
            const isDisabled = count > maxWords;
            const isSelected = selectedWordCount === count;
            html += '<button class="word-count-option" data-count="' + count + '" ' + (isDisabled ? 'disabled' : '') + ' style="padding: 1rem; background-color: ' + (isSelected ? colors.primary : colors.background) + '; color: ' + (isSelected ? 'white' : colors.text) + '; border: 2px solid ' + colors.primary + '; border-radius: 0.5rem; cursor: ' + (isDisabled ? 'not-allowed' : 'pointer') + '; font-size: ' + (baseSize * 1.2) + 'px; font-weight: bold; opacity: ' + (isDisabled ? '0.4' : '1') + ';">' + count + ' å€‹</button>';
          });
          html += '</div>';
          html += '<button class="word-count-option" data-count="all" style="width: 100%; padding: 1rem; background-color: ' + (selectedWordCount === null ? colors.primary : colors.background) + '; color: ' + (selectedWordCount === null ? 'white' : colors.text) + '; border: 2px solid ' + colors.primary + '; border-radius: 0.5rem; cursor: pointer; font-size: ' + (baseSize * 1.1) + 'px; font-weight: bold; margin-bottom: 1.5rem;">å…¨éƒ¨ (' + maxWords + ' å€‹)</button>';
          html += '<button id="confirm-word-count-btn" style="width: 100%; padding: 1rem; background-color: ' + colors.accent + '; color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-size: ' + (baseSize * 1.1) + 'px; font-weight: bold;">é–‹å§‹è¨“ç·´</button>';
          html += '</div>';
          html += '</div>';
        }

        html += '</div></div>';
        return html;
      }

      if (studyMode === 'flashcard') {
        const word = studyWords[currentCardIndex];
        const meanings = word.thai_meanings ? word.thai_meanings.split('|').filter(m => m.trim()) : [];
        let html = '<div class="w-full min-h-full" style="background-color: ' + colors.background + '; padding: 2rem;">';
        html += '<div style="max-width: 800px; margin: 0 auto;">';
        html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">';
        html += '<h1 style="font-size: ' + (baseSize * 1.5) + 'px; font-weight: bold; color: ' + colors.text + ';">ç”Ÿè©å¡ ' + (currentCardIndex + 1) + ' / ' + studyWords.length + '</h1>';
        html += '<button class="back-to-mode-btn" style="padding: 0.75rem 1.5rem; background-color: ' + colors.primary + '; color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-size: ' + baseSize + 'px;">è¿”å›</button>';
        html += '</div>';
        html += '<div class="card-flip" id="flashcard" style="position: relative; width: 100%; max-width: 600px; height: 380px; margin: 0 auto; cursor: pointer; perspective: 1000px; -webkit-perspective: 1000px;">';
        html += '<div class="card-inner" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; transform-style: preserve-3d; -webkit-transform-style: preserve-3d; transition: transform 0.6s;">';
        html += '<div class="card-front" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: ' + colors.card + '; padding: 1.5rem; display: flex; flex-direction: column; justify-content: center; align-items: center; box-shadow: 0 10px 20px rgba(0,0,0,0.2); backface-visibility: hidden; -webkit-backface-visibility: hidden; border-radius: 0.5rem;">';
        html += '<div style="font-size: ' + (baseSize * 3) + 'px; font-weight: bold; color: ' + colors.text + '; margin-bottom: 0.75rem;">' + word.simplified + '</div>';
        html += '<div style="background-color: ' + colors.accent + '; color: white; padding: 0.4rem 0.8rem; border-radius: 1rem; font-size: ' + (baseSize * 0.9) + 'px; font-weight: 600;">' + word.word_type + '</div>';
        html += '<div style="margin-top: 1.5rem; font-size: ' + (baseSize * 0.8) + 'px; color: ' + colors.text + '; opacity: 0.5;">é»æ“Šç¿»è½‰å¡ç‰‡</div>';
        html += '</div>';
        html += '<div class="card-back" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: ' + colors.card + '; padding: 1rem; display: flex; flex-direction: column; justify-content: flex-start; align-items: center; box-shadow: 0 10px 20px rgba(0,0,0,0.2); backface-visibility: hidden; -webkit-backface-visibility: hidden; border-radius: 0.5rem; transform: rotateY(180deg); overflow-y: auto;">';
        html += '<div style="text-align: center; margin-bottom: 0.5rem; width: 100%;">';
        html += '<div style="font-size: ' + (baseSize * 1.6) + 'px; font-weight: bold; color: ' + colors.text + '; margin-bottom: 0.15rem;">' + word.simplified + '</div>';
        if (word.traditional && word.traditional !== word.simplified) {
          html += '<div style="font-size: ' + (baseSize * 1.1) + 'px; color: ' + colors.text + '; opacity: 0.7; margin-bottom: 0.15rem;">ï¼ˆ' + word.traditional + 'ï¼‰</div>';
        }
        html += '<div style="font-size: ' + (baseSize * 0.9) + 'px; color: ' + colors.primary + ';">' + word.pinyin + '</div>';
        html += '</div>';
        if (meanings.length > 0) {
          html += '<div style="margin-bottom: 0.5rem; width: 100%;">';
          html += '<div style="font-size: ' + (baseSize * 0.85) + 'px; font-weight: bold; color: ' + colors.accent + '; margin-bottom: 0.25rem; text-align: center;">æ³°æ–‡ç¿»è­¯</div>';
          meanings.forEach(function(m) {
            html += '<div style="font-size: ' + (baseSize * 0.8) + 'px; color: ' + colors.text + '; margin-bottom: 0.2rem; text-align: center;">' + m.trim() + '</div>';
          });
          html += '</div>';
        }
        // ä¾‹å¥é¡¯ç¤º - å˜—è©¦å¤šç¨®å¯èƒ½çš„æ¬„ä½åç¨±
        var exampleText = word.examples || word.example || word.example_sentence || word.example_sentences || word.sentences || word.sentence || '';
        var examples = exampleText ? exampleText.split('|').filter(function(e) { return e.trim(); }) : [];
        if (examples.length > 0) {
          html += '<div style="width: 100%; border-top: 1px solid ' + colors.text + '20; padding-top: 0.5rem;">';
          html += '<div style="font-size: ' + (baseSize * 0.85) + 'px; font-weight: bold; color: ' + colors.accent + '; margin-bottom: 0.35rem; text-align: center;">ä¾‹å¥</div>';
          examples.forEach(function(ex) {
            html += '<div style="font-size: ' + (baseSize * 0.8) + 'px; color: ' + colors.text + '; margin-bottom: 0.35rem; text-align: left; padding: 0 0.5rem;">' + ex.trim() + '</div>';
          });
          html += '</div>';
        }
        html += '</div></div></div>';
        html += '<div style="display: flex; justify-content: space-between; gap: 1rem; margin-top: 2rem; max-width: 600px; margin-left: auto; margin-right: auto;">';
        html += '<button class="prev-card-btn" ' + (currentCardIndex === 0 ? 'disabled' : '') + ' style="flex: 1; padding: 1rem; background-color: ' + colors.primary + '; color: white; border: none; border-radius: 0.5rem; cursor: ' + (currentCardIndex === 0 ? 'not-allowed' : 'pointer') + '; font-size: ' + baseSize + 'px; opacity: ' + (currentCardIndex === 0 ? '0.5' : '1') + ';">â† ä¸Šä¸€å¼µ</button>';
        html += '<button class="next-card-btn" ' + (currentCardIndex === studyWords.length - 1 ? 'disabled' : '') + ' style="flex: 1; padding: 1rem; background-color: ' + colors.primary + '; color: white; border: none; border-radius: 0.5rem; cursor: ' + (currentCardIndex === studyWords.length - 1 ? 'not-allowed' : 'pointer') + '; font-size: ' + baseSize + 'px; opacity: ' + (currentCardIndex === studyWords.length - 1 ? '0.5' : '1') + ';">ä¸‹ä¸€å¼µ â†’</button>';
        html += '</div></div></div>';
        return html;
      }
      return '';
    }

    function renderTest(colors, baseSize, config) {
      const word = studyWords[currentCardIndex];
      const progress = ((currentCardIndex + 1) / studyWords.length) * 100;
      let html = '<div class="w-full min-h-full" style="background-color: ' + colors.background + '; padding: 2rem;">';
      html += '<div style="max-width: 800px; margin: 0 auto;">';
      html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">';
      html += '<h1 style="font-size: ' + (baseSize * 1.5) + 'px; font-weight: bold; color: ' + colors.text + ';">æ¸¬é©—æ¨¡å¼</h1>';
      html += '<button class="back-to-mode-btn" style="padding: 0.75rem 1.5rem; background-color: ' + colors.primary + '; color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-size: ' + baseSize + 'px;">è¿”å›</button>';
      html += '</div>';
      html += '<div style="margin-bottom: 2rem;">';
      html += '<div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">';
      html += '<span style="font-size: ' + (baseSize * 0.9) + 'px; color: ' + colors.text + ';">é€²åº¦ï¼š' + (currentCardIndex + 1) + ' / ' + studyWords.length + '</span>';
      html += '<span style="font-size: ' + (baseSize * 0.9) + 'px; color: ' + colors.text + ';">å¾—åˆ†ï¼š' + testScore + '</span>';
      html += '</div>';
      html += '<div style="width: 100%; height: 10px; background-color: ' + colors.card + '; border-radius: 1rem; overflow: hidden;">';
      html += '<div style="width: ' + progress + '%; height: 100%; background-color: ' + colors.accent + '; transition: width 0.3s;"></div>';
      html += '</div></div>';
      html += '<div style="background-color: ' + colors.card + '; padding: 3rem; border-radius: 1rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">';
      html += '<div style="text-align: center; margin-bottom: 2rem;">';
      html += '<div style="font-size: ' + (baseSize * 3) + 'px; font-weight: bold; color: ' + colors.text + '; margin-bottom: 1rem;">' + word.simplified + '</div>';
      html += '<div style="background-color: ' + colors.accent + '; color: white; padding: 0.4rem 0.8rem; border-radius: 1rem; font-size: ' + (baseSize * 0.9) + 'px; font-weight: 600;">' + word.word_type + '</div>';
      // å¤–å±‚å®¹å™¨ï¼šä¿è¯å’Œå…¶ä»–å†…å®¹çš„é—´è·ï¼Œé¿å…æ’ç‰ˆæ··ä¹±
html += '<div style="margin: 0.5rem 0;">';
// ç‚¹å‡»è§¦å‘çš„æ–‡å­—ï¼ˆç§»é™¤äº†ä¸‹åˆ’çº¿ï¼Œä¿ç•™æ‰‹å‹å’Œä¸»é¢˜è‰²æç¤ºå¯ç‚¹å‡»ï¼‰
html += '  <span onclick="';
// ç‚¹å‡»äº‹ä»¶é€»è¾‘ï¼šåˆ‡æ¢æ‹¼éŸ³çš„æ˜¾ç¤º/éšè—ï¼ŒåŒæ—¶ä¿®æ”¹è§¦å‘æ–‡å­—
html += '    const pinyinDiv = this.nextElementSibling;';
html += '    const isHidden = pinyinDiv.style.display === \'none\';';
html += '    pinyinDiv.style.display = isHidden ? \'block\' : \'none\';';
html += '    this.textContent = isHidden ? \'éšè—æ‹¼éŸ³\' : \'æ˜¾ç¤ºæ‹¼éŸ³\';';
html += '" style="font-family: \'Noto Sans SC\', \'Microsoft YaHei\', å¾®è½¯é›…é»‘, å®‹ä½“, sans-serif; font-size: ' + (baseSize * 1.1) + 'px; color: ' + colors.accent + '; cursor: pointer;">'; // åˆ æ‰äº†text-decoration: underline;
html += '  æ˜¾ç¤ºæ‹¼éŸ³';
html += '  </span>';
// æ‹¼éŸ³å®¹å™¨ï¼šé»˜è®¤éšè—ï¼Œä¿ç•™åŸæœ‰æ ·å¼ + è‡ªå®šä¹‰æ‹¼éŸ³å­—ä½“
html += '  <div style="font-family: \'Noto Sans SC\', \'Microsoft YaHei\', å¾®è½¯é›…é»‘, å®‹ä½“, sans-serif; font-size: ' + (baseSize * 1.3) + 'px; color: ' + colors.primary + '; display: none; margin-top: 0.5rem;">' + word.pinyin + '</div>';
html += '</div>';
            html += '</div>';
      html += '<form id="test-form">';
      html += '<div style="margin-bottom: 1.5rem;">';
      html += '<label style="display: block; font-size: ' + baseSize + 'px; font-weight: 600; color: ' + colors.text + '; margin-bottom: 0.5rem;">è«‹è¼¸å…¥æ³°æ–‡ç¿»è­¯ï¼š</label>';
      html += '<input type="text" id="answer-input" required style="width: 100%; padding: 1rem; border: 2px solid ' + colors.primary + '; border-radius: 0.5rem; font-size: ' + (baseSize * 1.1) + 'px; background-color: white; color: ' + colors.text + ';">';
      html += '</div>';
      html += '<div id="answer-feedback" style="margin-bottom: 1.5rem; padding: 1rem; border-radius: 0.5rem; display: none;"></div>';
      html += '<button type="submit" id="check-answer-btn" style="width: 100%; padding: 1rem; background-color: ' + colors.accent + '; color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-size: ' + (baseSize * 1.1) + 'px; font-weight: bold;">æª¢æŸ¥ç­”æ¡ˆ</button>';
      html += '</form></div></div></div>';
      return html;
    }

    function renderMultipleChoice(colors, baseSize, config) {
      const word = studyWords[currentCardIndex];
      const progress = ((currentCardIndex + 1) / studyWords.length) * 100;
      let html = '<div class="w-full min-h-full" style="background-color: ' + colors.background + '; padding: 2rem;">';
      html += '<div style="max-width: 800px; margin: 0 auto;">';
      html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">';
      html += '<h1 style="font-size: ' + (baseSize * 1.5) + 'px; font-weight: bold; color: ' + colors.text + ';">é¸æ“‡é¡Œæ¨¡å¼</h1>';
      html += '<button class="back-to-mode-btn" style="padding: 0.75rem 1.5rem; background-color: ' + colors.primary + '; color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-size: ' + baseSize + 'px;">è¿”å›</button>';
      html += '</div>';
      html += '<div style="margin-bottom: 2rem;">';
      html += '<div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">';
      html += '<span style="font-size: ' + (baseSize * 0.9) + 'px; color: ' + colors.text + ';">é€²åº¦ï¼š' + (currentCardIndex + 1) + ' / ' + studyWords.length + '</span>';
      html += '<span style="font-size: ' + (baseSize * 0.9) + 'px; color: ' + colors.text + ';">å¾—åˆ†ï¼š' + testScore + '</span>';
      html += '</div>';
      html += '<div style="width: 100%; height: 10px; background-color: ' + colors.card + '; border-radius: 1rem; overflow: hidden;">';
      html += '<div style="width: ' + progress + '%; height: 100%; background-color: ' + colors.accent + ';"></div>';
      html += '</div></div>';
      html += '<div style="background-color: ' + colors.card + '; padding: 3rem; border-radius: 1rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">';
      html += '<div style="text-align: center; margin-bottom: 3rem;">';
      html += '<div style="font-size: ' + (baseSize * 3) + 'px; font-weight: bold; color: ' + colors.text + '; margin-bottom: 1rem;">' + word.simplified + '</div>';
      html += '<div style="background-color: ' + colors.accent + '; color: white; padding: 0.4rem 0.8rem; border-radius: 1rem; font-size: ' + (baseSize * 0.9) + 'px; font-weight: 600;">' + word.word_type + '</div>';
    // å¤–å±‚å®¹å™¨ï¼šä¿è¯å’Œå…¶ä»–å†…å®¹çš„é—´è·ï¼Œé¿å…æ’ç‰ˆæ··ä¹±
html += '<div style="margin: 0.5rem 0;">';
// ç‚¹å‡»è§¦å‘çš„æ–‡å­—ï¼ˆç§»é™¤äº†ä¸‹åˆ’çº¿ï¼Œä¿ç•™æ‰‹å‹å’Œä¸»é¢˜è‰²æç¤ºå¯ç‚¹å‡»ï¼‰
html += '  <span onclick="';
// ç‚¹å‡»äº‹ä»¶é€»è¾‘ï¼šåˆ‡æ¢æ‹¼éŸ³çš„æ˜¾ç¤º/éšè—ï¼ŒåŒæ—¶ä¿®æ”¹è§¦å‘æ–‡å­—
html += '    const pinyinDiv = this.nextElementSibling;';
html += '    const isHidden = pinyinDiv.style.display === \'none\';';
html += '    pinyinDiv.style.display = isHidden ? \'block\' : \'none\';';
html += '    this.textContent = isHidden ? \'éšè—æ‹¼éŸ³\' : \'æ˜¾ç¤ºæ‹¼éŸ³\';';
html += '" style="font-family: \'Noto Sans SC\', \'Microsoft YaHei\', å¾®è½¯é›…é»‘, å®‹ä½“, sans-serif; font-size: ' + (baseSize * 1.1) + 'px; color: ' + colors.accent + '; cursor: pointer;">'; // åˆ æ‰äº†text-decoration: underline;
html += '  æ˜¾ç¤ºæ‹¼éŸ³';
html += '  </span>';
// æ‹¼éŸ³å®¹å™¨ï¼šé»˜è®¤éšè—ï¼Œä¿ç•™åŸæœ‰æ ·å¼ + è‡ªå®šä¹‰æ‹¼éŸ³å­—ä½“
html += '  <div style="font-family: \'Noto Sans SC\', \'Microsoft YaHei\', å¾®è½¯é›…é»‘, å®‹ä½“, sans-serif; font-size: ' + (baseSize * 1.3) + 'px; color: ' + colors.primary + '; display: none; margin-top: 0.5rem;">' + word.pinyin + '</div>';
html += '</div>';
      html += '</div>';
      html += '<div id="choices-container" style="display: grid; gap: 1rem;">';
      gameOptions.forEach(function(option, index) {
        html += '<button class="choice-btn" data-index="' + index + '" data-correct="' + option.isCorrect + '" style="padding: 1.5rem; background-color: ' + colors.background + '; color: ' + colors.text + '; border: 2px solid ' + colors.primary + '; border-radius: 0.5rem; cursor: pointer; font-size: ' + baseSize + 'px; text-align: left;">' + option.text + '</button>';
      });
      html += '</div>';
      html += '<div id="choice-feedback" style="margin-top: 1.5rem; padding: 1rem; border-radius: 0.5rem; display: none;"></div>';
      html += '</div></div></div>';
      return html;
    }

    function renderSpeedChallenge(colors, baseSize, config) {
      const word = studyWords[currentCardIndex];
      let html = '<div class="w-full min-h-full" style="background-color: ' + colors.background + '; padding: 2rem;">';
      html += '<div style="max-width: 800px; margin: 0 auto;">';
      html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">';
      html += '<h1 style="font-size: ' + (baseSize * 1.5) + 'px; font-weight: bold; color: ' + colors.text + ';">âš¡ é€Ÿåº¦æŒ‘æˆ°</h1>';
      html += '<button class="back-to-mode-btn" style="padding: 0.75rem 1.5rem; background-color: ' + colors.primary + '; color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-size: ' + baseSize + 'px;">è¿”å›</button>';
      html += '</div>';
      html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 2rem;">';
      html += '<div style="background-color: ' + colors.card + '; padding: 1.5rem; border-radius: 0.5rem; text-align: center;">';
      html += '<div style="font-size: ' + (baseSize * 2.5) + 'px; font-weight: bold; color: ' + colors.accent + ';" id="timer">' + gameTimeLeft + '</div>';
      html += '<div style="font-size: ' + (baseSize * 0.9) + 'px; color: ' + colors.text + '; opacity: 0.7;">å‰©é¤˜æ™‚é–“ï¼ˆç§’ï¼‰</div>';
      html += '</div>';
      html += '<div style="background-color: ' + colors.card + '; padding: 1.5rem; border-radius: 0.5rem; text-align: center;">';
      html += '<div style="font-size: ' + (baseSize * 2.5) + 'px; font-weight: bold; color: ' + colors.primary + ';">' + testScore + '</div>';
      html += '<div style="font-size: ' + (baseSize * 0.9) + 'px; color: ' + colors.text + '; opacity: 0.7;">ç­”å°é¡Œæ•¸</div>';
      html += '</div></div>';
      html += '<div style="background-color: ' + colors.card + '; padding: 3rem; border-radius: 1rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">';
      html += '<div style="text-align: center; margin-bottom: 2rem;">';
      html += '<div style="font-size: ' + (baseSize * 3) + 'px; font-weight: bold; color: ' + colors.text + '; margin-bottom: 1rem;">' + word.simplified + '</div>';
      html += '<div style="background-color: ' + colors.accent + '; color: white; padding: 0.4rem 0.8rem; border-radius: 1rem; font-size: ' + (baseSize * 0.9) + 'px; font-weight: 600;">' + word.word_type + '</div>';
      // å¤–å±‚å®¹å™¨ï¼šä¿è¯å’Œå…¶ä»–å†…å®¹çš„é—´è·ï¼Œé¿å…æ’ç‰ˆæ··ä¹±
html += '<div style="margin: 0.5rem 0;">';
// ç‚¹å‡»è§¦å‘çš„æ–‡å­—ï¼ˆç§»é™¤äº†ä¸‹åˆ’çº¿ï¼Œä¿ç•™æ‰‹å‹å’Œä¸»é¢˜è‰²æç¤ºå¯ç‚¹å‡»ï¼‰
html += '  <span onclick="';
// ç‚¹å‡»äº‹ä»¶é€»è¾‘ï¼šåˆ‡æ¢æ‹¼éŸ³çš„æ˜¾ç¤º/éšè—ï¼ŒåŒæ—¶ä¿®æ”¹è§¦å‘æ–‡å­—
html += '    const pinyinDiv = this.nextElementSibling;';
html += '    const isHidden = pinyinDiv.style.display === \'none\';';
html += '    pinyinDiv.style.display = isHidden ? \'block\' : \'none\';';
html += '    this.textContent = isHidden ? \'éšè—æ‹¼éŸ³\' : \'æ˜¾ç¤ºæ‹¼éŸ³\';';
html += '" style="font-family: \'Noto Sans SC\', \'Microsoft YaHei\', å¾®è½¯é›…é»‘, å®‹ä½“, sans-serif; font-size: ' + (baseSize * 1.1) + 'px; color: ' + colors.accent + '; cursor: pointer;">'; // åˆ æ‰äº†text-decoration: underline;
html += '  æ˜¾ç¤ºæ‹¼éŸ³';
html += '  </span>';
// æ‹¼éŸ³å®¹å™¨ï¼šé»˜è®¤éšè—ï¼Œä¿ç•™åŸæœ‰æ ·å¼ + è‡ªå®šä¹‰æ‹¼éŸ³å­—ä½“
html += '  <div style="font-family: \'Noto Sans SC\', \'Microsoft YaHei\', å¾®è½¯é›…é»‘, å®‹ä½“, sans-serif; font-size: ' + (baseSize * 1.3) + 'px; color: ' + colors.primary + '; display: none; margin-top: 0.5rem;">' + word.pinyin + '</div>';
html += '</div>';
      html += '</div>';
      html += '<div id="speed-choices-container" style="display: grid; gap: 1rem;">';
      gameOptions.forEach(function(option, index) {
        html += '<button class="speed-choice-btn" data-index="' + index + '" data-correct="' + option.isCorrect + '" style="padding: 1.5rem; background-color: ' + colors.background + '; color: ' + colors.text + '; border: 2px solid ' + colors.primary + '; border-radius: 0.5rem; cursor: pointer; font-size: ' + baseSize + 'px; text-align: left;">' + option.text + '</button>';
      });
      html += '</div></div></div></div>';
      return html;
    }

    function renderMatching(colors, baseSize, config) {
      let html = '<div class="w-full min-h-full" style="background-color: ' + colors.background + '; padding: 2rem;">';
      html += '<div style="max-width: 900px; margin: 0 auto;">';
      html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">';
      html += '<h1 style="font-size: ' + (baseSize * 1.5) + 'px; font-weight: bold; color: ' + colors.text + ';">ğŸ´ é…å°éŠæˆ²</h1>';
      html += '<button class="back-to-mode-btn" style="padding: 0.75rem 1.5rem; background-color: ' + colors.primary + '; color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-size: ' + baseSize + 'px;">è¿”å›</button>';
      html += '</div>';
      html += '<div style="background-color: ' + colors.card + '; padding: 1.5rem; border-radius: 0.5rem; margin-bottom: 2rem; text-align: center;">';
      html += '<div style="font-size: ' + (baseSize * 1.2) + 'px; color: ' + colors.text + ';">å·²é…å°ï¼š<span style="font-weight: bold; color: ' + colors.accent + ';">' + matchedPairs.length + '</span> / ' + matchingPairs.length + '</div>';
      html += '</div>';
      html += '<div id="matching-grid" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem;">';
      matchingPairs.forEach(function(pair, index) {
        const isMatched = matchedPairs.includes(index);
        html += '<div class="matching-card ' + (isMatched ? 'matched' : '') + '" data-index="' + index + '" style="aspect-ratio: 1; cursor: pointer; perspective: 1000px;">';
        html += '<div class="card-inner" style="width: 100%; height: 100%; position: relative; transition: transform 0.6s; transform-style: preserve-3d;">';
        html += '<div class="card-front" style="position: absolute; width: 100%; height: 100%; background-color: ' + colors.primary + '; border-radius: 0.5rem; display: flex; align-items: center; justify-content: center; backface-visibility: hidden;">';
        html += '<div style="font-size: ' + (baseSize * 2) + 'px; color: white;">?</div>';
        html += '</div>';
        html += '<div class="card-back" style="position: absolute; width: 100%; height: 100%; background-color: ' + colors.card + '; border: 2px solid ' + colors.primary + '; border-radius: 0.5rem; display: flex; align-items: center; justify-content: center; backface-visibility: hidden; transform: rotateY(180deg); padding: 1rem;">';
        html += '<div style="font-size: ' + (baseSize * 0.9) + 'px; color: ' + colors.text + '; font-weight: bold; text-align: center; word-break: break-word;">' + pair.text + '</div>';
        html += '</div></div></div>';
      });
      html += '</div></div></div>';
      return html;
    }

    function renderListening(colors, baseSize, config) {
      const word = studyWords[currentCardIndex];
      const progress = ((currentCardIndex + 1) / studyWords.length) * 100;
      let html = '<div class="w-full min-h-full" style="background-color: ' + colors.background + '; padding: 2rem;">';
      html += '<div style="max-width: 800px; margin: 0 auto;">';
      html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">';
      html += '<h1 style="font-size: ' + (baseSize * 1.5) + 'px; font-weight: bold; color: ' + colors.text + ';">ğŸ‘‚ æ‹¼éŸ³ç·´ç¿’</h1>';
      html += '<button class="back-to-mode-btn" style="padding: 0.75rem 1.5rem; background-color: ' + colors.primary + '; color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-size: ' + baseSize + 'px;">è¿”å›</button>';
      html += '</div>';
      html += '<div style="margin-bottom: 2rem;">';
      html += '<div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">';
      html += '<span style="font-size: ' + (baseSize * 0.9) + 'px; color: ' + colors.text + ';">é€²åº¦ï¼š' + (currentCardIndex + 1) + ' / ' + studyWords.length + '</span>';
      html += '<span style="font-size: ' + (baseSize * 0.9) + 'px; color: ' + colors.text + ';">å¾—åˆ†ï¼š' + testScore + '</span>';
      html += '</div>';
      html += '<div style="width: 100%; height: 10px; background-color: ' + colors.card + '; border-radius: 1rem; overflow: hidden;">';
      html += '<div style="width: ' + progress + '%; height: 100%; background-color: ' + colors.accent + ';"></div>';
      html += '</div></div>';
      html += '<div style="background-color: ' + colors.card + '; padding: 3rem; border-radius: 1rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">';
      html += '<div style="text-align: center; margin-bottom: 3rem;">';
      html += '<div style="font-size: ' + (baseSize * 0.9) + 'px; color: ' + colors.text + '; opacity: 0.7; margin-bottom: 1rem;">æ ¹æ“šæ‹¼éŸ³é¸æ“‡æ­£ç¢ºçš„ä¸­æ–‡</div>';
      html += '<div style="font-size: ' + (baseSize * 3.5) + 'px; font-weight: bold; color: ' + colors.primary + '; margin-bottom: 1rem;">' + word.pinyin + '</div>';
      html += '<div style="font-size: ' + baseSize + 'px; color: ' + colors.text + '; opacity: 0.6;">è©æ€§ï¼š' + word.word_type + '</div>';
      html += '</div>';
      html += '<div id="listening-choices-container" style="display: grid; gap: 1rem;">';
      gameOptions.forEach(function(option, index) {
        html += '<button class="listening-choice-btn" data-index="' + index + '" data-correct="' + option.isCorrect + '" style="padding: 1.5rem; background-color: ' + colors.background + '; color: ' + colors.text + '; border: 2px solid ' + colors.primary + '; border-radius: 0.5rem; cursor: pointer; font-size: ' + (baseSize * 1.3) + 'px; font-weight: bold; text-align: center;">' + option.text + '</button>';
      });
      html += '</div>';
      html += '<div id="listening-feedback" style="margin-top: 1.5rem; padding: 1rem; border-radius: 0.5rem; display: none;"></div>';
      html += '</div></div></div>';
      return html;
    }

    function renderResults(colors, baseSize, config) {
      const percentage = Math.round((testScore / studyWords.length) * 100);
      let html = '<div class="w-full min-h-full" style="background-color: ' + colors.background + '; padding: 2rem;">';
      html += '<div style="max-width: 800px; margin: 0 auto;">';
      html += '<div style="text-align: center; margin-bottom: 3rem;">';
      html += '<h1 style="font-size: ' + (baseSize * 2.5) + 'px; font-weight: bold; color: ' + colors.text + '; margin-bottom: 1rem;">' + (studyMode === 'speed-challenge' ? 'âš¡ æŒ‘æˆ°å®Œæˆï¼' : 'æ¸¬é©—å®Œæˆï¼') + '</h1>';
      html += '<div style="font-size: ' + (baseSize * 4) + 'px; font-weight: bold; color: ' + colors.primary + '; margin-bottom: 1rem;">' + (studyMode === 'speed-challenge' ? testScore + ' é¡Œ' : percentage + '%') + '</div>';
      html += '<div style="font-size: ' + (baseSize * 1.3) + 'px; color: ' + colors.text + ';">' + (studyMode === 'speed-challenge' ? '60ç§’å…§ç­”å° ' + testScore + ' é¡Œï¼' : 'ç­”å° ' + testScore + ' / ' + studyWords.length + ' é¡Œ') + '</div>';
      html += '</div>';
      if (testAnswers.length > 0) {
        html += '<div style="background-color: ' + colors.card + '; padding: 2rem; border-radius: 1rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 2rem;">';
        html += '<h2 style="font-size: ' + (baseSize * 1.5) + 'px; font-weight: bold; color: ' + colors.text + '; margin-bottom: 1.5rem;">ç­”é¡Œè©³æƒ…</h2>';
        testAnswers.forEach(function(item) {
          const meanings = item.word.thai_meanings ? item.word.thai_meanings.split('|').filter(m => m.trim()) : [];
          const isWordFavorite = isFavorite(item.word.id);
          html += '<div style="padding: 1rem; margin-bottom: 1rem; background-color: ' + (item.correct ? '#f0fdf4' : '#fef2f2') + '; border-left: 4px solid ' + (item.correct ? colors.accent : '#ef4444') + '; border-radius: 0.5rem;">';
          html += '<div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">';
          html += '<div>';
          html += '<span style="font-size: ' + (baseSize * 1.2) + 'px; font-weight: bold; color: ' + colors.text + ';">' + item.word.simplified + '</span>';
          html += '<span style="font-size: ' + baseSize + 'px; color: ' + colors.text + '; opacity: 0.7; margin-left: 0.5rem;">' + item.word.pinyin + '</span>';
          html += '</div>';
          html += '<div style="display: flex; align-items: center; gap: 0.5rem;">';
          html += '<button class="result-favorite-btn" data-id="' + item.word.id + '" style="background-color: ' + (isWordFavorite ? '#f59e0b' : 'transparent') + '; color: ' + (isWordFavorite ? 'white' : '#f59e0b') + '; padding: 0.25rem 0.75rem; border-radius: 0.5rem; border: 1px solid #f59e0b; cursor: pointer; font-size: ' + (baseSize * 0.8) + 'px;">' + (isWordFavorite ? 'å·²æ”¶è—' : 'åŠ å…¥æ”¶è—') + '</button>';
          html += '<span style="font-size: ' + (baseSize * 1.5) + 'px;">' + (item.correct ? 'âœ“' : 'âœ—') + '</span>';
          html += '</div></div>';
          // Show user's wrong answer and correct answer
          if (!item.correct && item.userAnswer) {
            html += '<div style="font-size: ' + (baseSize * 0.9) + 'px; color: #dc2626; margin-bottom: 0.25rem;"><span style="font-weight: 600;">ä½ çš„ç­”æ¡ˆï¼š</span><span style="background-color: #fee2e2; padding: 0.125rem 0.5rem; border-radius: 0.25rem;">' + item.userAnswer + '</span></div>';
          }
          html += '<div style="font-size: ' + (baseSize * 0.9) + 'px; color: ' + (item.correct ? '#166534' : colors.text) + '; opacity: ' + (item.correct ? '1' : '0.8') + ';"><span style="font-weight: 600;">æ­£ç¢ºç­”æ¡ˆï¼š</span><span style="' + (!item.correct ? 'background-color: #dcfce7; padding: 0.125rem 0.5rem; border-radius: 0.25rem;' : '') + '">' + meanings.join(' / ') + '</span></div>';
          html += '</div>';
        });
        html += '</div>';
      }
      html += '<div style="display: flex; gap: 1rem;">';
      html += '<button class="retry-test-btn" style="flex: 1; padding: 1rem; background-color: ' + colors.accent + '; color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-size: ' + baseSize + 'px; font-weight: bold;">å†æ¸¬ä¸€æ¬¡</button>';
      html += '<button class="back-btn" style="flex: 1; padding: 1rem; background-color: ' + colors.primary + '; color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-size: ' + baseSize + 'px; font-weight: bold;">è¿”å›é¦–é </button>';
      html += '</div></div></div>';
      return html;
    }

    function generateMultipleChoiceOptions(correctWord, allWordsPool) {
      const correctMeanings = correctWord.thai_meanings.split('|').map(m => m.trim());
      const correctAnswer = correctMeanings[0];

      const otherWords = allWordsPool.filter(w => w.id !== correctWord.id);
      const shuffled = otherWords.sort(() => Math.random() - 0.5);

      const wrongOptions = [];
      for (let i = 0; i < shuffled.length && wrongOptions.length < 3; i++) {
        const meanings = shuffled[i].thai_meanings.split('|').map(m => m.trim());
        if (meanings[0] && meanings[0] !== correctAnswer) {
          wrongOptions.push(meanings[0]);
        }
      }

      while (wrongOptions.length < 3) {
        wrongOptions.push('é¸é … ' + (wrongOptions.length + 1));
      }

      const options = [
        { text: correctAnswer, isCorrect: true },
        { text: wrongOptions[0], isCorrect: false },
        { text: wrongOptions[1], isCorrect: false },
        { text: wrongOptions[2], isCorrect: false }
      ];

      return options.sort(() => Math.random() - 0.5);
    }

    function generateListeningOptions(correctWord, allWordsPool) {
      const otherWords = allWordsPool.filter(w => w.id !== correctWord.id);
      const shuffled = otherWords.sort(() => Math.random() - 0.5);
      const wrongOptions = shuffled.slice(0, 3).map(w => w.simplified);

      const options = [
        { text: correctWord.simplified, isCorrect: true },
        { text: wrongOptions[0] || 'é¸é …1', isCorrect: false },
        { text: wrongOptions[1] || 'é¸é …2', isCorrect: false },
        { text: wrongOptions[2] || 'é¸é …3', isCorrect: false }
      ];

      return options.sort(() => Math.random() - 0.5);
    }

    function generateMatchingPairs(words) {
      const pairs = [];
      const selectedWords = words.slice(0, Math.min(6, words.length));

      selectedWords.forEach(function(word) {
        const meanings = word.thai_meanings.split('|').map(m => m.trim());
        pairs.push({ text: word.simplified, matchId: word.id, type: 'chinese' });
        pairs.push({ text: meanings[0], matchId: word.id, type: 'thai' });
      });

      return pairs.sort(() => Math.random() - 0.5);
    }

    function startSpeedTimer() {
      if (gameTimer) clearInterval(gameTimer);

      gameTimer = setInterval(function() {
        gameTimeLeft--;
        const timerElement = document.getElementById('timer');
        if (timerElement) {
          timerElement.textContent = gameTimeLeft;
        }

        if (gameTimeLeft <= 0) {
          clearInterval(gameTimer);
          currentView = 'results';
          renderApp();
        }
      }, 1000);
    }

    function startTrainingMode(mode, wordCount) {
      studyMode = mode;

      if (selectedLevel === 'favorites') {
        studyWords = getFavoriteWords();
      } else if (selectedLevel === '7-9') {
        studyWords = allWords.filter(w => w.hsk_level >= 7 && w.hsk_level <= 9);
      } else {
        const levelConfig = customLevels.find(l => l.id === selectedLevel);
        if (levelConfig) {
          studyWords = allWords.filter(w => w.hsk_level === levelConfig.value);
        }
      }

      studyWords = studyWords.sort(() => Math.random() - 0.5);

      if (wordCount && wordCount < studyWords.length) {
        studyWords = studyWords.slice(0, wordCount);
      }

      currentCardIndex = 0;
      testScore = 0;
      testAnswers = [];
      gameTimeLeft = 60;

      if (studyMode === 'flashcard') {
        currentView = 'study';
      } else if (studyMode === 'test') {
        currentView = 'test';
      } else if (studyMode === 'multiple-choice') {
        currentView = 'multiple-choice';
        gameOptions = generateMultipleChoiceOptions(studyWords[0], studyWords);
      } else if (studyMode === 'speed-challenge') {
        currentView = 'speed-challenge';
        gameOptions = generateMultipleChoiceOptions(studyWords[0], studyWords);
        setTimeout(function() { startSpeedTimer(); }, 100);
      } else if (studyMode === 'matching') {
        currentView = 'matching';
        matchingPairs = generateMatchingPairs(studyWords);
        selectedCards = [];
        matchedPairs = [];
        gameStartTime = Date.now();
      } else if (studyMode === 'listening') {
        currentView = 'listening';
        gameOptions = generateListeningOptions(studyWords[0], studyWords);
      }

      renderApp();
    }

    function attachEventListeners() {
      // Logout button
      const logoutBtn = document.getElementById('logout-btn');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', function() {
          if (confirm('ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ')) {
            logout();
          }
        });
      }

      // Login history button
      const loginHistoryBtn = document.getElementById('login-history-btn');
      if (loginHistoryBtn) {
        loginHistoryBtn.addEventListener('click', async function() {
          await fetchLoginHistory();
          showLoginHistory = true;
          renderApp();
        });
      }

      // Close login history modal
      const closeLoginHistoryBtn = document.getElementById('close-login-history-btn');
      if (closeLoginHistoryBtn) {
        closeLoginHistoryBtn.addEventListener('click', function() {
          showLoginHistory = false;
          renderApp();
        });
      }

      // Settings button
      const settingsBtn = document.getElementById('settings-btn');
      if (settingsBtn) {
        settingsBtn.addEventListener('click', function() {
          const currentUrl = window.getGoogleScriptUrl ? window.getGoogleScriptUrl() : '';
          if (currentUrl) {
            const choice = prompt('ç›®å‰å·²é€£æ¥åˆ° Google Sheetsã€‚\n\n1. æ›´æ”¹ URL\n2. æ¸…é™¤é€£æ¥\n\nè¼¸å…¥æ•¸å­— (1-2)ï¼š');
            if (choice === '1') {
              const newUrl = prompt('è«‹è¼¸å…¥æ–°çš„ Google Apps Script URLï¼š', currentUrl);
              if (newUrl && newUrl.trim().includes('script.google.com')) {
                window.setGoogleScriptUrl && window.setGoogleScriptUrl(newUrl.trim());
                alert('è¨­ç½®æˆåŠŸï¼é é¢å°‡é‡æ–°è¼‰å…¥ã€‚');
                window.location.reload();
              }
            } else if (choice === '2') {
              if (confirm('ç¢ºå®šè¦æ¸…é™¤ Google Sheets é€£æ¥å—ï¼Ÿ')) {
                window.clearGoogleScriptUrl && window.clearGoogleScriptUrl();
                window.location.reload();
              }
            }
          } else {
            const newUrl = prompt('è«‹è¼¸å…¥ Google Apps Script URLï¼š');
            if (newUrl && newUrl.trim().includes('script.google.com')) {
              window.setGoogleScriptUrl && window.setGoogleScriptUrl(newUrl.trim());
              alert('è¨­ç½®æˆåŠŸï¼é é¢å°‡é‡æ–°è¼‰å…¥ã€‚');
              window.location.reload();
            }
          }
        });
      }

      // Manage levels button
      const manageLevelsBtn = document.getElementById('manage-levels-btn');
      if (manageLevelsBtn) {
        manageLevelsBtn.addEventListener('click', function() {
          showManageLevelModal = true;
          renderApp();
        });
      }

      // Close manage level modal
      const closeManageLevelBtn = document.getElementById('close-manage-level-btn');
      if (closeManageLevelBtn) {
        closeManageLevelBtn.addEventListener('click', function() {
          showManageLevelModal = false;
          renderApp();
        });
      }

      // Add level button
      const addLevelBtn = document.getElementById('add-level-btn');
      if (addLevelBtn) {
        addLevelBtn.addEventListener('click', function() {
          const labelInput = document.getElementById('new-level-label');
          const valueInput = document.getElementById('new-level-value');
          const label = labelInput.value.trim();
          const value = parseInt(valueInput.value);

          if (!label) {
            alert('è«‹è¼¸å…¥ç­‰ç´šåç¨±');
            return;
          }
          if (isNaN(value) || value < 1) {
            alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„æ•¸å€¼ï¼ˆå¤§æ–¼ 0ï¼‰');
            return;
          }

          // Check for duplicate
          const exists = customLevels.some(l => l.label === label || l.value === value);
          if (exists) {
            alert('æ­¤ç­‰ç´šåç¨±æˆ–æ•¸å€¼å·²å­˜åœ¨');
            return;
          }

          // Add new level
          const newId = label.replace(/\s+/g, '-').toLowerCase();
          customLevels.push({
            id: newId,
            label: label,
            value: value
          });

          // Sort by value
          customLevels.sort((a, b) => a.value - b.value);

          // Save to localStorage
          saveLevelsToStorage();

          // Clear inputs
          labelInput.value = '';
          valueInput.value = '';

          renderApp();
        });
      }

      // Edit level buttons
      const editLevelBtns = document.querySelectorAll('.edit-level-btn');
      editLevelBtns.forEach(function(btn) {
        btn.addEventListener('click', function() {
          const index = parseInt(btn.dataset.index);
          const level = customLevels[index];

          const newLabel = prompt('ç·¨è¼¯ç­‰ç´šåç¨±ï¼š', level.label);
          if (newLabel === null) return;

          const newValue = prompt('ç·¨è¼¯æ•¸å€¼ï¼ˆHSK Levelï¼‰ï¼š', level.value);
          if (newValue === null) return;

          const parsedValue = parseInt(newValue);
          if (isNaN(parsedValue) || parsedValue < 1) {
            alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„æ•¸å€¼');
            return;
          }

          // Update level
          customLevels[index] = {
            id: newLabel.replace(/\s+/g, '-').toLowerCase(),
            label: newLabel.trim(),
            value: parsedValue
          };

          // Sort by value
          customLevels.sort((a, b) => a.value - b.value);

          // Save to localStorage
          saveLevelsToStorage();

          renderApp();
        });
      });

      // Delete level buttons
      const deleteLevelBtns = document.querySelectorAll('.delete-level-btn');
      deleteLevelBtns.forEach(function(btn) {
        btn.addEventListener('click', function() {
          const index = parseInt(btn.dataset.index);
          const level = customLevels[index];

          if (confirm('ç¢ºå®šè¦åˆªé™¤ç­‰ç´šã€Œ' + level.label + 'ã€å—ï¼Ÿ')) {
            customLevels.splice(index, 1);
            saveLevelsToStorage();
            renderApp();
          }
        });
      });

      // Reset levels button
      const resetLevelsBtn = document.getElementById('reset-levels-btn');
      if (resetLevelsBtn) {
        resetLevelsBtn.addEventListener('click', function() {
          if (confirm('ç¢ºå®šè¦é‡ç½®ç‚ºé è¨­ç­‰ç´šå—ï¼Ÿ')) {
            customLevels = [
              { id: '1', label: 'HSK 1', value: 1 },
              { id: '2', label: 'HSK 2', value: 2 },
              { id: '3', label: 'HSK 3', value: 3 },
              { id: '4', label: 'HSK 4', value: 4 },
              { id: '5', label: 'HSK 5', value: 5 },
              { id: '6', label: 'HSK 6', value: 6 },
              { id: '7-9', label: 'HSK 7-9', value: 7 }
            ];
            saveLevelsToStorage();
            renderApp();
          }
        });
      }

      // Action cards
      const actionCards = document.querySelectorAll('.action-card');
      actionCards.forEach(function(card) {
        card.addEventListener('click', function() {
          const action = card.dataset.action;
          if (action === 'browse') {
            currentView = 'browse';
          } else if (action === 'favorites') {
            currentView = 'favorites';
          } else if (action === 'study') {
            currentView = 'study';
            selectedLevel = null;
            studyMode = null;
          }
          renderApp();
        });
        card.addEventListener('mouseenter', function(e) {
          e.currentTarget.style.transform = 'translateY(-4px)';
        });
        card.addEventListener('mouseleave', function(e) {
          e.currentTarget.style.transform = 'translateY(0)';
        });
      });

      // Back buttons
      const backBtns = document.querySelectorAll('.back-btn');
      backBtns.forEach(function(btn) {
        btn.addEventListener('click', function() {
          if (gameTimer) clearInterval(gameTimer);
          currentView = 'home';
          selectedLevel = null;
          studyMode = null;
          currentCardIndex = 0;
          gameTimeLeft = 60;
          renderApp();
        });
      });

      // Go browse button
      const goBrowseBtn = document.querySelector('.go-browse-btn');
      if (goBrowseBtn) {
        goBrowseBtn.addEventListener('click', function() {
          currentView = 'browse';
          renderApp();
        });
      }

      // Search input
      const searchInput = document.getElementById('search-input');
      if (searchInput) {
        searchInput.addEventListener('input', function(e) {
          const query = e.target.value;
          const filtered = searchWords(query, allWords);
          const container = document.getElementById('words-container');
          const colors = getColors();
          const baseSize = getFontSize();
          container.innerHTML = renderWordCards(filtered, colors, baseSize);
          attachFavoriteListeners();
        });
      }

      // Level filters
      const levelFilters = document.querySelectorAll('.level-filter');
      levelFilters.forEach(function(btn) {
        btn.addEventListener('click', function() {
          const level = btn.dataset.level;
          const colors = getColors();
          const baseSize = getFontSize();

          levelFilters.forEach(function(b) {
            if (b === btn) {
              b.style.backgroundColor = colors.primary;
              b.style.color = 'white';
            } else {
              b.style.backgroundColor = colors.card;
              b.style.color = colors.text;
            }
          });

          let filtered;
          if (level === 'all') {
            filtered = allWords;
          } else if (level === '7-9') {
            filtered = allWords.filter(w => w.hsk_level >= 7 && w.hsk_level <= 9);
          } else {
            const levelConfig = customLevels.find(l => l.id === level);
            if (levelConfig) {
              filtered = allWords.filter(w => w.hsk_level === levelConfig.value);
            } else {
              filtered = allWords;
            }
          }

          const container = document.getElementById('words-container');
          container.innerHTML = renderWordCards(filtered, colors, baseSize);
          attachFavoriteListeners();
        });
      });

      // Select level buttons
      const selectLevelBtns = document.querySelectorAll('.select-level-btn');
      selectLevelBtns.forEach(function(btn) {
        btn.addEventListener('click', function() {
          if (!btn.disabled) {
            selectedLevel = btn.dataset.level;
            renderApp();
          }
        });
      });

      // Back to level button
      const backToLevelBtn = document.querySelector('.back-to-level-btn');
      if (backToLevelBtn) {
        backToLevelBtn.addEventListener('click', function() {
          if (gameTimer) clearInterval(gameTimer);
          selectedLevel = null;
          studyMode = null;
          gameTimeLeft = 60;
          renderApp();
        });
      }

      // Select mode buttons - show word count modal for 4 modes
      const selectModeBtns = document.querySelectorAll('.select-mode-btn');
      selectModeBtns.forEach(function(btn) {
        btn.addEventListener('click', function() {
          const mode = btn.dataset.mode;
          // For these 4 modes, show word count selection modal
          if (mode === 'flashcard' || mode === 'test' || mode === 'multiple-choice' || mode === 'listening') {
            pendingStudyMode = mode;
            showWordCountModal = true;
            renderApp();
          } else {
            // For speed-challenge and matching, start directly
            startTrainingMode(mode, null);
          }
        });
      });

      // Word count modal - confirm button
      const confirmWordCountBtn = document.getElementById('confirm-word-count-btn');
      if (confirmWordCountBtn) {
        confirmWordCountBtn.addEventListener('click', function() {
          showWordCountModal = false;
          startTrainingMode(pendingStudyMode, selectedWordCount);
          pendingStudyMode = null;
        });
      }

      // Word count modal - cancel button
      const cancelWordCountBtn = document.getElementById('cancel-word-count-btn');
      if (cancelWordCountBtn) {
        cancelWordCountBtn.addEventListener('click', function() {
          showWordCountModal = false;
          pendingStudyMode = null;
          renderApp();
        });
      }

      // Word count options
      const wordCountOptions = document.querySelectorAll('.word-count-option');
      wordCountOptions.forEach(function(btn) {
        btn.addEventListener('click', function() {
          const count = btn.dataset.count === 'all' ? null : parseInt(btn.dataset.count);
          selectedWordCount = count;
          // Update UI
          wordCountOptions.forEach(function(b) {
            const colors = getColors();
            if (b === btn) {
              b.style.backgroundColor = colors.primary;
              b.style.color = 'white';
            } else {
              b.style.backgroundColor = colors.card;
              b.style.color = colors.text;
            }
          });
        });
      });

      // Flashcard
      const flashcard = document.getElementById('flashcard');
      if (flashcard) {
        flashcard.addEventListener('click', function() {
          flashcard.classList.toggle('flipped');
        });
      }

      // Prev/Next card buttons
      const prevCardBtn = document.querySelector('.prev-card-btn');
      if (prevCardBtn) {
        prevCardBtn.addEventListener('click', function() {
          if (currentCardIndex > 0) {
            currentCardIndex--;
            renderApp();
          }
        });
      }

      const nextCardBtn = document.querySelector('.next-card-btn');
      if (nextCardBtn) {
        nextCardBtn.addEventListener('click', function() {
          if (currentCardIndex < studyWords.length - 1) {
            currentCardIndex++;
            renderApp();
          }
        });
      }

      // Back to mode button
      const backToModeBtn = document.querySelector('.back-to-mode-btn');
      if (backToModeBtn) {
        backToModeBtn.addEventListener('click', function() {
          if (gameTimer) clearInterval(gameTimer);
          studyMode = null;
          currentCardIndex = 0;
          gameTimeLeft = 60;
          if (currentView === 'test' || currentView === 'multiple-choice' || currentView === 'speed-challenge' || currentView === 'matching' || currentView === 'listening') {
            currentView = 'study';
          }
          renderApp();
        });
      }

      // Test form
      const testForm = document.getElementById('test-form');
      if (testForm) {
        testForm.addEventListener('submit', function(e) {
          e.preventDefault();

          const answerInput = document.getElementById('answer-input');
          const userAnswer = answerInput.value.trim();
          const word = studyWords[currentCardIndex];
          const meanings = word.thai_meanings.split('|').map(m => m.trim().toLowerCase());

          const isCorrect = meanings.some(m => m === userAnswer.toLowerCase());

          if (isCorrect) {
            testScore++;
          }

          testAnswers.push({
            word: word,
            userAnswer: userAnswer,
            correct: isCorrect
          });

          const feedback = document.getElementById('answer-feedback');
          const colors = getColors();
          const baseSize = getFontSize();

          if (isCorrect) {
            feedback.style.display = 'block';
            feedback.style.backgroundColor = '#f0fdf4';
            feedback.style.border = '2px solid ' + colors.accent;
            feedback.style.color = '#166534';
            feedback.innerHTML = '<div style="font-size: ' + baseSize + 'px; font-weight: bold;">âœ“ æ­£ç¢ºï¼</div>';
          } else {
            feedback.style.display = 'block';
            feedback.style.backgroundColor = '#fef2f2';
            feedback.style.border = '2px solid #ef4444';
            feedback.style.color = '#991b1b';
            feedback.innerHTML = '<div style="font-size: ' + baseSize + 'px; font-weight: bold; margin-bottom: 0.5rem;">âœ— ç­”éŒ¯äº†</div><div style="font-size: ' + (baseSize * 0.9) + 'px;">æ­£ç¢ºç­”æ¡ˆï¼š' + meanings.join(' / ') + '</div>';
          }

          answerInput.disabled = true;
          const checkBtn = document.getElementById('check-answer-btn');
          checkBtn.textContent = currentCardIndex < studyWords.length - 1 ? 'ä¸‹ä¸€é¡Œ' : 'æŸ¥çœ‹çµæœ';
          checkBtn.style.backgroundColor = colors.primary;

          checkBtn.onclick = function() {
            if (currentCardIndex < studyWords.length - 1) {
              currentCardIndex++;
              renderApp();
            } else {
              currentView = 'results';
              renderApp();
            }
          };
        });
      }

      // Multiple choice buttons
      const choiceBtns = document.querySelectorAll('.choice-btn');
      choiceBtns.forEach(function(btn) {
        btn.addEventListener('click', function() {
          handleChoiceClick(btn, '.choice-btn', 'choice-feedback');
        });
      });

      // Speed choice buttons
      const speedChoiceBtns = document.querySelectorAll('.speed-choice-btn');
      speedChoiceBtns.forEach(function(btn) {
        btn.addEventListener('click', function() {
          const isCorrect = btn.dataset.correct === 'true';
          const colors = getColors();

          if (isCorrect) {
            testScore++;
            btn.style.backgroundColor = colors.accent;
            btn.style.color = 'white';

            testAnswers.push({
              word: studyWords[currentCardIndex],
              userAnswer: btn.textContent.trim(),
              correct: true
            });

            setTimeout(function() {
              currentCardIndex++;
              if (currentCardIndex >= studyWords.length) {
                studyWords = studyWords.sort(() => Math.random() - 0.5);
                currentCardIndex = 0;
              }
              gameOptions = generateMultipleChoiceOptions(studyWords[currentCardIndex], studyWords);
              renderApp();
            }, 300);
          } else {
            btn.classList.add('shake');
            btn.style.backgroundColor = '#ef4444';
            btn.style.color = 'white';

            setTimeout(function() {
              btn.style.backgroundColor = colors.background;
              btn.style.color = colors.text;
              btn.classList.remove('shake');
            }, 500);
          }
        });
      });

      // Matching cards
      const matchingCards = document.querySelectorAll('.matching-card');
      matchingCards.forEach(function(card) {
        card.addEventListener('click', function() {
          if (card.classList.contains('matched') || card.classList.contains('flipped')) return;

          const index = parseInt(card.dataset.index);
          card.classList.add('flipped');
          selectedCards.push(index);

          if (selectedCards.length === 2) {
            const first = selectedCards[0];
            const second = selectedCards[1];
            const firstPair = matchingPairs[first];
            const secondPair = matchingPairs[second];

            if (firstPair.matchId === secondPair.matchId && firstPair.type !== secondPair.type) {
              setTimeout(function() {
                matchedPairs.push(first, second);

                if (matchedPairs.length === matchingPairs.length) {
                  testScore = Math.round((Date.now() - gameStartTime) / 1000);
                  setTimeout(function() {
                    currentView = 'results';
                    renderApp();
                  }, 500);
                } else {
                  renderApp();
                }
              }, 600);
            } else {
              setTimeout(function() {
                const cards = document.querySelectorAll('.matching-card');
                cards[first].classList.remove('flipped');
                cards[second].classList.remove('flipped');
                selectedCards = [];
              }, 1000);
            }

            if (matchedPairs.length < matchingPairs.length) {
              selectedCards = [];
            }
          }
        });
      });

      // Listening choice buttons
      const listeningChoiceBtns = document.querySelectorAll('.listening-choice-btn');
      listeningChoiceBtns.forEach(function(btn) {
        btn.addEventListener('click', function() {
          handleChoiceClick(btn, '.listening-choice-btn', 'listening-feedback');
        });
      });

      // Retry test button
      const retryTestBtn = document.querySelector('.retry-test-btn');
      if (retryTestBtn) {
        retryTestBtn.addEventListener('click', function() {
          studyWords = studyWords.sort(() => Math.random() - 0.5);
          currentCardIndex = 0;
          testScore = 0;
          testAnswers = [];
          gameTimeLeft = 60;
          selectedCards = [];
          matchedPairs = [];
          gameStartTime = null;

          if (studyMode === 'test') {
            currentView = 'test';
          } else if (studyMode === 'multiple-choice') {
            currentView = 'multiple-choice';
            gameOptions = generateMultipleChoiceOptions(studyWords[0], studyWords);
          } else if (studyMode === 'speed-challenge') {
            currentView = 'speed-challenge';
            gameOptions = generateMultipleChoiceOptions(studyWords[0], studyWords);
            setTimeout(function() { startSpeedTimer(); }, 100);
          } else if (studyMode === 'matching') {
            currentView = 'matching';
            matchingPairs = generateMatchingPairs(studyWords);
            gameStartTime = Date.now();
          } else if (studyMode === 'listening') {
            currentView = 'listening';
            gameOptions = generateListeningOptions(studyWords[0], studyWords);
          }

          renderApp();
        });
      }

      // Train favorites button
      const trainFavoritesBtn = document.getElementById('train-favorites-btn');
      if (trainFavoritesBtn) {
        trainFavoritesBtn.addEventListener('click', function() {
          selectedLevel = 'favorites';
          currentView = 'study';
          studyMode = null;
          renderApp();
        });
      }

      // Clear favorites button
      const clearFavoritesBtn = document.getElementById('clear-favorites-btn');
      if (clearFavoritesBtn) {
        clearFavoritesBtn.addEventListener('click', function() {
          if (confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰æ”¶è—å—ï¼Ÿ')) {
            favoriteWords = [];
            saveFavorites();
            renderApp();
          }
        });
      }

      attachFavoriteListeners();
    }

    function handleChoiceClick(btn, btnSelector, feedbackId) {
      const isCorrect = btn.dataset.correct === 'true';
      const colors = getColors();
      const baseSize = getFontSize();

      const allBtns = document.querySelectorAll(btnSelector);
      allBtns.forEach(function(b) { b.disabled = true; });

      if (isCorrect) {
        testScore++;
        btn.classList.add('correct');
        btn.style.backgroundColor = colors.accent;
        btn.style.color = 'white';
        btn.style.borderColor = colors.accent;
      } else {
        btn.classList.add('wrong');
        btn.style.backgroundColor = '#ef4444';
        btn.style.color = 'white';
        btn.style.borderColor = '#ef4444';

        allBtns.forEach(function(b) {
          if (b.dataset.correct === 'true') {
            b.style.backgroundColor = colors.accent;
            b.style.color = 'white';
            b.style.borderColor = colors.accent;
          }
        });
      }

      testAnswers.push({
        word: studyWords[currentCardIndex],
        userAnswer: btn.textContent.trim(),
        correct: isCorrect
      });

      const feedback = document.getElementById(feedbackId);
      feedback.style.display = 'block';

      if (isCorrect) {
        feedback.style.backgroundColor = '#f0fdf4';
        feedback.style.border = '2px solid ' + colors.accent;
        feedback.style.color = '#166534';
        feedback.innerHTML = '<div style="font-size: ' + baseSize + 'px; font-weight: bold; text-align: center;">âœ“ æ­£ç¢ºï¼</div>';
      } else {
        feedback.style.backgroundColor = '#fef2f2';
        feedback.style.border = '2px solid #ef4444';
        feedback.style.color = '#991b1b';
        feedback.innerHTML = '<div style="font-size: ' + baseSize + 'px; font-weight: bold; text-align: center;">âœ— ç­”éŒ¯äº†</div>';
      }

      setTimeout(function() {
        if (currentCardIndex < studyWords.length - 1) {
          currentCardIndex++;
          if (btnSelector === '.listening-choice-btn') {
            gameOptions = generateListeningOptions(studyWords[currentCardIndex], studyWords);
          } else {
            gameOptions = generateMultipleChoiceOptions(studyWords[currentCardIndex], studyWords);
          }
          renderApp();
        } else {
          currentView = 'results';
          renderApp();
        }
      }, 1500);
    }

    function attachFavoriteListeners() {
      const favoriteBtns = document.querySelectorAll('.favorite-word-btn');
      favoriteBtns.forEach(function(btn) {
        btn.addEventListener('click', function(e) {
          e.stopPropagation();
          const wordId = btn.dataset.id;
          const colors = getColors();

          if (isFavorite(wordId)) {
            removeFromFavorites(wordId);
            btn.textContent = 'æ”¶è—';
            btn.style.backgroundColor = colors.background;
            btn.style.color = colors.text;
          } else {
            addToFavorites(wordId);
            btn.textContent = 'å·²æ”¶è—';
            btn.style.backgroundColor = '#f59e0b';
            btn.style.color = 'white';
          }
        });
      });

      const resultFavoriteBtns = document.querySelectorAll('.result-favorite-btn');
      resultFavoriteBtns.forEach(function(btn) {
        btn.addEventListener('click', function(e) {
          e.stopPropagation();
          const wordId = btn.dataset.id;

          if (isFavorite(wordId)) {
            removeFromFavorites(wordId);
            btn.textContent = 'åŠ å…¥æ”¶è—';
            btn.style.backgroundColor = 'transparent';
            btn.style.color = '#f59e0b';
          } else {
            addToFavorites(wordId);
            btn.textContent = 'å·²æ”¶è—';
            btn.style.backgroundColor = '#f59e0b';
            btn.style.color = 'white';
          }
        });
      });
    }

    initializeSDKs();
  </script>
</body>
</html>
