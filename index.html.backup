<!doctype html>
<html lang="zh-TW">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HSK ç”Ÿè©å¡å­¸ç¿’ç³»çµ±</title>
  <script>
    // Mock SDK for standalone use
    window.dataSdk = {
      async init(handler) {
        window._dataHandler = handler;
        const savedData = localStorage.getItem('hsk_words');
        const words = savedData ? JSON.parse(savedData) : [];
        setTimeout(() => handler.onDataChanged(words), 100);
        return { isOk: true };
      },
      async create(wordData) {
        const savedData = localStorage.getItem('hsk_words');
        const words = savedData ? JSON.parse(savedData) : [];
        words.push(wordData);
        localStorage.setItem('hsk_words', JSON.stringify(words));

        const handler = window._dataHandler;
        if (handler) {
          setTimeout(() => handler.onDataChanged(words), 100);
        }
        return { isOk: true };
      },
      async delete(word) {
        const savedData = localStorage.getItem('hsk_words');
        const words = savedData ? JSON.parse(savedData) : [];
        const filtered = words.filter(w => w.id !== word.id);
        localStorage.setItem('hsk_words', JSON.stringify(filtered));

        const handler = window._dataHandler;
        if (handler) {
          setTimeout(() => handler.onDataChanged(filtered), 100);
        }
        return { isOk: true };
      }
    };

    window.elementSdk = {
      config: {},
      async init(options) {
        this.config = options.defaultConfig;
        this._onConfigChange = options.onConfigChange;
        return { isOk: true };
      },
      setConfig(newConfig) {
        Object.assign(this.config, newConfig);
        if (this._onConfigChange) {
          this._onConfigChange(this.config);
        }
      }
    };
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      box-sizing: border-box;
    }

    .card-flip {
      perspective: 1000px;
    }

    .card-inner {
      position: relative;
      width: 100%;
      height: 100%;
      transition: transform 0.6s;
      transform-style: preserve-3d;
    }

    .card-flip.flipped .card-inner {
      transform: rotateY(180deg);
    }

    .card-front, .card-back {
      position: absolute;
      width: 100%;
      height: 100%;
      backface-visibility: hidden;
      border-radius: 0.5rem;
    }

    .card-back {
      transform: rotateY(180deg);
    }

    .fade-in {
      animation: fadeIn 0.3s ease-in;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .sync-indicator {
      animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .matching-card {
      transition: all 0.3s ease;
    }

    .matching-card:hover:not(.matched) {
      transform: scale(1.05);
    }

    .matching-card.flipped .card-inner {
      transform: rotateY(180deg);
    }

    .matching-card.matched {
      opacity: 0.5;
      pointer-events: none;
    }

    .shake {
      animation: shake 0.5s;
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-10px); }
      75% { transform: translateX(10px); }
    }

    .choice-btn {
      transition: all 0.2s;
    }

    .choice-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.15);
    }

    .choice-btn.correct {
      animation: correctPulse 0.6s;
    }

    .choice-btn.wrong {
      animation: wrongShake 0.5s;
    }

    @keyframes correctPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    @keyframes wrongShake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-8px); }
      75% { transform: translateX(8px); }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="w-full min-h-full" style="margin: 0; padding: 0;">
  <div id="app" class="w-full min-h-full"></div>
  <script>
    const defaultConfig = {
      site_title: "HSK ç”Ÿè©å¡å­¸ç¿’ç³»çµ±",
      search_placeholder: "æœå°‹ç”Ÿè©...",
      background_color: "#f0f4f8",
      card_color: "#ffffff",
      primary_color: "#3b82f6",
      text_color: "#1f2937",
      accent_color: "#10b981",
      font_family: "system-ui",
      font_size: 16
    };

    let allWords = [];
    let currentView = 'home';
    let selectedLevel = null;
    let studyMode = null;
    let currentCardIndex = 0;
    let studyWords = [];
    let testScore = 0;
    let testAnswers = [];
    let isLoading = false;
    let customWordTypes = ['åè©', 'å‹•è©', 'å½¢å®¹è©', 'å‰¯è©', 'ä»£è©', 'æ•¸è©', 'é‡è©', 'é€£è©', 'ä»‹è©', 'åŠ©è©', 'å˜†è©', 'æ“¬è²è©', 'æˆèª', 'æ…£ç”¨èª'];
    let showWordTypeModal = false;
    let showLevelModal = false;
    let customLevels = [
      { id: '1', label: 'HSK 1', value: 1 },
      { id: '2', label: 'HSK 2', value: 2 },
      { id: '3', label: 'HSK 3', value: 3 },
      { id: '4', label: 'HSK 4', value: 4 },
      { id: '5', label: 'HSK 5', value: 5 },
      { id: '6', label: 'HSK 6', value: 6 },
      { id: '7-9', label: 'HSK 7-9', value: 7 }
    ];
    let lastSyncTime = null;
    let gameOptions = [];
    let gameTimeLeft = 60;
    let gameTimer = null;
    let matchingPairs = [];
    let selectedCards = [];
    let matchedPairs = [];
    let gameStartTime = null;

    // ç°¡ç¹è½‰æ›å°ç…§è¡¨
    const conversionMap = {
      'å­¦': 'å­¸', 'ä¹ ': 'ç¿’', 'å›½': 'åœ‹', 'è¿™': 'é€™', 'é‚£': 'é‚£',
      'é‡Œ': 'è£¡', 'è¯´': 'èªª', 'è¯': 'è©±', 'åƒ': 'åƒ', 'é¥­': 'é£¯',
      'å–': 'å–', 'èŒ¶': 'èŒ¶', 'ä¹°': 'è²·', 'ä¸œ': 'æ±', 'è¥¿': 'è¥¿',
      'é—¨': 'é–€', 'å¼€': 'é–‹', 'å…³': 'é—œ', 'ä¹¦': 'æ›¸', 'çœ‹': 'çœ‹',
      'è¯»': 'è®€', 'å†™': 'å¯«', 'å¬': 'è½', 'ä¼š': 'æœƒ', 'è§': 'è¦‹',
      'æ—¶': 'æ™‚', 'é—´': 'é–“', 'å¤©': 'å¤©', 'æ°”': 'æ°£', 'å€™': 'å€™',
      'çƒ­': 'ç†±', 'å†·': 'å†·', 'é›¨': 'é›¨', 'é›ª': 'é›ª', 'é£': 'é¢¨',
      'ç”µ': 'é›»', 'è§†': 'è¦–', 'è„‘': 'è…¦', 'ç½‘': 'ç¶²',
      'ç»œ': 'çµ¡', 'é™…': 'éš›', 'ä¸š': 'æ¥­', 'åŠ¡': 'å‹™', 'å‘˜': 'å“¡',
      'å¸ˆ': 'å¸«', 'åŒ»': 'é†«', 'é™¢': 'é™¢', 'è¯': 'è—¥', 'åº—': 'åº—',
      'åœº': 'å ´', 'å¸‚': 'å¸‚', 'é“¶': 'éŠ€', 'è¡Œ': 'è¡Œ', 'é’±': 'éŒ¢',
      'å—': 'å¡Š', 'æ¯›': 'æ¯›', 'ä¸‡': 'è¬', 'äº¿': 'å„„', 'å…ƒ': 'å…ƒ',
      'å·': 'è™Ÿ', 'ç ': 'ç¢¼', 'æœº': 'æ©Ÿ', 'è½¦': 'è»Š', 'ç«™': 'ç«™',
      'ç«': 'ç«', 'æ±½': 'æ±½', 'é£': 'é£›', 'èˆ¹': 'èˆ¹', 'è·¯': 'è·¯',
      'æ¡¥': 'æ©‹', 'æ¥¼': 'æ¨“', 'å±‚': 'å±¤', 'æˆ¿': 'æˆ¿',
      'å…': 'å»³', 'å¨': 'å»š', 'å«': 'è¡›', 'ç”Ÿ': 'ç”Ÿ',
      'å›­': 'åœ’', 'é¦†': 'é¤¨', 'åŠ': 'è¾¦', 'å…¬': 'å…¬', 'å®¤': 'å®¤',
      'å‚': 'å» ', 'åŒº': 'å€', 'å¿': 'ç¸£', 'é•‡': 'é®', 'æ‘': 'æ‘',
      'çœ': 'çœ', 'è¡—': 'è¡—', 'é“': 'é“',
      'æ ‹': 'æ£Ÿ', 'å•': 'å–®',
      'ä¸œ': 'æ±', 'å—': 'å—', 'è¥¿': 'è¥¿', 'åŒ—': 'åŒ—', 'ä¸­': 'ä¸­',
      'å‰': 'å‰', 'å': 'å¾Œ', 'å·¦': 'å·¦', 'å³': 'å³', 'ä¸Š': 'ä¸Š',
      'ä¸‹': 'ä¸‹', 'å¤§': 'å¤§', 'å°': 'å°', 'å¤š': 'å¤š', 'å°‘': 'å°‘',
      'é•¿': 'é•·', 'çŸ­': 'çŸ­', 'é«˜': 'é«˜', 'ä½': 'ä½', 'æ–°': 'æ–°',
      'æ—§': 'èˆŠ', 'å¥½': 'å¥½', 'å': 'å£', 'å¯¹': 'å°', 'é”™': 'éŒ¯',
      'å¿«': 'å¿«', 'æ…¢': 'æ…¢', 'è¿œ': 'é ', 'è¿‘': 'è¿‘', 'æ—©': 'æ—©',
      'æ™š': 'æ™š', 'æ¥': 'ä¾†', 'å»': 'å»', 'å›': 'å›', 'è¿›': 'é€²',
      'å‡º': 'å‡º', 'åˆ°': 'åˆ°', 'ç»™': 'çµ¦', 'è®©': 'è®“', 'è¯·': 'è«‹',
      'è°¢': 'è¬', 'èµ·': 'èµ·', 'æ²¡': 'æ²’',
      'ç³»': 'ä¿‚', 'é—®': 'å•', 'é¢˜': 'é¡Œ', 'å¸®': 'å¹«',
      'åŠ©': 'åŠ©', 'å¿™': 'å¿™', 'è®¤': 'èª', 'è¯†': 'è­˜', 'è¯‰': 'è¨´',
      'çˆ±': 'æ„›', 'æ¬¢': 'æ­¡', 'å–œ': 'å–œ', 'è®¨': 'è¨', 'åŒ': 'å­',
      'å…´': 'èˆˆ', 'å¥‹': 'å¥®', 'æ‹…': 'æ“”', 'å¿ƒ': 'å¿ƒ', 'éš¾': 'é›£',
      'è¿‡': 'é', 'è§‰': 'è¦º', 'å¾—': 'å¾—', 'åº”': 'æ‡‰', 'è¯¥': 'è©²',
      'èƒ½': 'èƒ½', 'å¤Ÿ': 'å¤ ', 'æƒ³': 'æƒ³', 'è¦': 'è¦', 'æ„¿': 'é¡˜',
      'æ„': 'æ„', 'å¸Œ': 'å¸Œ', 'æœ›': 'æœ›', 'æ€•': 'æ€•', 'æ€ª': 'æ€ª',
      'çœŸ': 'çœŸ', 'å‡': 'å‡', 'æ¢¦': 'å¤¢', 'é†’': 'é†’', 'ç¡': 'ç¡',
      'ç´¯': 'ç´¯', 'é¥¿': 'é¤“', 'æ¸´': 'æ¸´', 'ç—…': 'ç—…',
      'ç–¼': 'ç–¼', 'ç—›': 'ç—›', 'èˆ’': 'èˆ’', 'æœ': 'æœ', 'å¥': 'å¥',
      'åº·': 'åº·', 'å²': 'æ­²', 'å¹´': 'å¹´', 'æœˆ': 'æœˆ', 'æ—¥': 'æ—¥',
      'æ˜Ÿ': 'æ˜Ÿ', 'æœŸ': 'æœŸ', 'ç¤¼': 'ç¦®', 'æ‹œ': 'æ‹œ', 'å‘¨': 'é€±',
      'ç‚¹': 'é»', 'é’Ÿ': 'é˜', 'åˆ†': 'åˆ†', 'ç§’': 'ç§’', 'åˆ»': 'åˆ»',
      'åŠ': 'åŠ', 'ä»Š': 'ä»Š', 'æ˜': 'æ˜', 'æ˜¨': 'æ˜¨',
      'ç°': 'ç¾', 'åœ¨': 'åœ¨', 'å°†': 'å°‡', 'åˆš': 'å‰›', 'æ‰': 'æ‰',
      'å·²': 'å·²', 'ç»': 'ç¶“', 'è¿˜': 'é‚„', 'æ­£': 'æ­£', 'æ˜¥': 'æ˜¥',
      'å¤': 'å¤', 'ç§‹': 'ç§‹', 'å†¬': 'å†¬', 'å­£': 'å­£', 'èŠ‚': 'ç¯€',
      'æ¸©': 'æº«', 'åº¦': 'åº¦', 'æ¹¿': 'æ¿•', 'å¹²': 'ä¹¾', 'å‡€': 'æ·¨',
      'è„': 'é«’', 'äº®': 'äº®', 'æš—': 'æš—', 'å“': 'éŸ¿', 'é™': 'éœ',
      'é—¹': 'é¬§', 'è½»': 'è¼•', 'é‡': 'é‡', 'ç²—': 'ç²—', 'ç»†': 'ç´°',
      'åš': 'åš', 'è–„': 'è–„', 'å®½': 'å¯¬', 'çª„': 'çª„', 'æ·±': 'æ·±',
      'æµ…': 'æ·º', 'æ»¡': 'æ»¿', 'ç©º': 'ç©º', 'ç¼º': 'ç¼º',
      'ä¸°': 'è±', 'å¯Œ': 'å¯Œ', 'è´«': 'è²§', 'ç©·': 'çª®', 'è´µ': 'è²´',
      'ä¾¿': 'ä¾¿', 'å®œ': 'å®œ', 'å€¼': 'å€¼', 'ä»·': 'åƒ¹', 'æ ¼': 'æ ¼',
      'è´¹': 'è²»', 'ç”¨': 'ç”¨', 'èŠ±': 'èŠ±', 'èµš': 'è³º', 'çœ': 'çœ',
      'çº¦': 'ç´„', 'æµª': 'æµª', 'èµ”': 'è³ ',
      'è¾“': 'è¼¸', 'èµ¢': 'è´', 'ç®—': 'ç®—', 'æ•°': 'æ•¸', 'è®¡': 'è¨ˆ',
      'æ€»': 'ç¸½', 'å…±': 'å…±', 'å¹³': 'å¹³', 'å‡': 'å‡', 'åŠ ': 'åŠ ',
      'å‡': 'æ¸›', 'ä¹˜': 'ä¹˜', 'é™¤': 'é™¤', 'ç­‰': 'ç­‰', 'äº': 'æ–¼',
      'å€': 'å€', 'åŒ': 'é›™', 'ç¬¬': 'ç¬¬',
      'æ¬¡': 'æ¬¡', 'é': 'é', 'è¶Ÿ': 'è¶Ÿ', 'é¡¿': 'é “',
      'ç•ª': 'ç•ª', 'å±Š': 'å±†', 'æ‰¹': 'æ‰¹',
      'ç»„': 'çµ„', 'é˜Ÿ': 'éšŠ', 'ç¾¤': 'ç¾¤', 'ä¼™': 'å¤¥',
      'ä¸ª': 'å€‹', 'ä½': 'ä½', 'å': 'å', 'æ¡': 'æ¢', 'å¼ ': 'å¼µ',
      'åª': 'éš»', 'æ”¯': 'æ”¯', 'æŠŠ': 'æŠŠ', 'ä»¶': 'ä»¶', 'å¥—': 'å¥—',
      'å‰¯': 'å‰¯', 'ä»½': 'ä»½', 'æœ¬': 'æœ¬',
      'å†Œ': 'å†Š', 'é¡µ': 'é ', 'ç¯‡': 'ç¯‡', 'ç« ': 'ç« ',
      'æ®µ': 'æ®µ', 'å¥': 'å¥', 'è¯': 'è©', 'å­—': 'å­—', 'ç¬”': 'ç­†',
      'ç”»': 'ç•«', 'å£°': 'è²', 'éŸ³': 'éŸ³', 'è°ƒ': 'èª¿', 'çº§': 'ç´š',
      'ç±»': 'é¡', 'ç§': 'ç¨®', 'æ ·': 'æ¨£', 'å¼': 'å¼', 'å‹': 'å‹',
      'æ¬¾': 'æ¬¾', 'å“': 'å“', 'ç‰Œ': 'ç‰Œ', 'è´¨': 'è³ª', 'é‡': 'é‡',
      'é¢': 'é¡', 'ç‡': 'ç‡', 'æ¯”': 'æ¯”', 'ä¾‹': 'ä¾‹',
      'å›´': 'åœ', 'èŒƒ': 'ç¯„', 'é™': 'é™', 'å†…': 'å…§',
      'å¤–': 'å¤–', 'å¤®': 'å¤®', 'è¾¹': 'é‚Š',
      'ä¾§': 'å´', 'æ—': 'æ—', 'è§’': 'è§’', 'å¤„': 'è™•', 'æ‰€': 'æ‰€',
      'å‘': 'å‘', 'æ–¹': 'æ–¹', 'é¢': 'é¢', 'éƒ¨': 'éƒ¨',
      'ä½“': 'é«”', 'èº«': 'èº«', 'å¤´': 'é ­', 'å‘': 'é«®',
      'çœ¼': 'çœ¼', 'ç›': 'ç›', 'è€³': 'è€³', 'æœµ': 'æœµ', 'é¼»': 'é¼»',
      'å˜´': 'å˜´', 'å”‡': 'å”‡', 'é½¿': 'é½’', 'ç‰™': 'ç‰™', 'èˆŒ': 'èˆŒ',
      'è„¸': 'è‡‰', 'é¢Š': 'é °', 'çœ‰': 'çœ‰',
      'é¡»': 'é¬š', 'èƒ¡': 'èƒ¡', 'é¢ˆ': 'é ¸', 'è„–': 'è„–',
      'è‚©': 'è‚©', 'è†€': 'è†€', 'èƒ¸': 'èƒ¸', 'èƒŒ': 'èƒŒ', 'è…°': 'è…°',
      'è…¹': 'è…¹', 'è‚š': 'è‚š', 'è‡€': 'è‡€', 'è…¿': 'è…¿', 'è†': 'è†',
      'è„š': 'è…³', 'è¶¾': 'è¶¾', 'è‡‚': 'è‡‚', 'è‚˜': 'è‚˜', 'è…•': 'è…•',
      'æŒ': 'æŒ', 'æ‹³': 'æ‹³', 'æŒ‡': 'æŒ‡', 'ç”²': 'ç”²', 'çš®': 'çš®',
      'è‚¤': 'è†š', 'è‚‰': 'è‚‰', 'éª¨': 'éª¨', 'ç­‹': 'ç­‹', 'è¡€': 'è¡€',
      'æ±—': 'æ±—', 'æ³ª': 'æ·š', 'æ¶•': 'æ¶•', 'ç—°': 'ç—°', 'å°¿': 'å°¿',
      'ç²ª': 'ç³', 'å±': 'å±', 'æ¯': 'æ¯',
      'å‘¼': 'å‘¼', 'å¸': 'å¸', 'å': 'å', 'å’³': 'å’³', 'å—½': 'å—½',
      'å–·': 'å™´', 'åš': 'åš', 'æ‰“': 'æ‰“', 'å“ˆ': 'å“ˆ', 'æ¬ ': 'æ¬ ',
      'å¹': 'å˜†', 'å“­': 'å“­', 'ç¬‘': 'ç¬‘', 'å”±': 'å”±', 'å–Š': 'å–Š',
      'å«': 'å«', 'éª‚': 'ç½µ', 'åµ': 'åµ', 'è®²': 'è¬›',
      'è°ˆ': 'è«‡', 'èŠ': 'èŠ', 'è®®': 'è­°', 'è®º': 'è«–', 'è¾©': 'è¾¯',
      'äº‰': 'çˆ­', 'æ¶': 'æ¶', 'ä»—': 'ä»—',
      'æˆ˜': 'æˆ°', 'æ–—': 'é¬¥', 'èƒœ': 'å‹', 'è´¥': 'æ•—', 'è´Ÿ': 'è² ',
      'èµ›': 'è³½', 'æ•Œ': 'æ•µ', 'å‹': 'å‹', 'ä¼´': 'ä¼´', 'ä¾£': 'ä¾¶',
      'å¤«': 'å¤«', 'å¦»': 'å¦»', 'å¦‡': 'å©¦', 'å©š': 'å©š',
      'å§»': 'å§»', 'æ‹': 'æˆ€', 'äº²': 'è¦ª', 'å»': 'å»',
      'æŠ±': 'æŠ±', 'æ‚': 'æ‘Ÿ', 'æ‹¥': 'æ“', 'æ¡': 'æ¡', 'ç‰µ': 'ç‰½',
      'æ‹‰': 'æ‹‰', 'æ¨': 'æ¨', 'æ‹–': 'æ‹–', 'æ‹½': 'æ‹½', 'æ‰”': 'æ‰”',
      'ä¸¢': 'ä¸Ÿ', 'æŠ›': 'æ‹‹', 'æ’’': 'æ’’', 'æ´’': 'ç‘', 'å€’': 'å€’',
      'æ³¨': 'æ³¨', 'çŒ': 'çŒ', 'å†²': 'æ²–', 'æ´—': 'æ´—', 'åˆ·': 'åˆ·',
      'æ“¦': 'æ“¦', 'æŠ¹': 'æŠ¹', 'æ¶‚': 'å¡—', 'æ': 'æ',
      'ç»˜': 'ç¹ª', 'åˆ»': 'åˆ»', 'å°': 'å°', 'æ‹“': 'æ‹“',
      'ç›–': 'è“‹', 'ç­¾': 'ç°½', 'ç« ': 'ç« ', 'æˆ³': 'æˆ³',
      'æŒ‰': 'æŒ‰', 'å‹': 'å£“', 'æŒ¤': 'æ“ ', 'æ': 'æ', 'æ': 'æ',
      'æ‹§': 'æ“°', 'æ‰­': 'æ‰­', 'è½¬': 'è½‰', 'æ‘‡': 'æ–', 'æ™ƒ': 'æ™ƒ',
      'æ‘†': 'æ“º', 'åŠ¨': 'å‹•', 'æ‘¸': 'æ‘¸', 'æŠš': 'æ’«', 'æ‘©': 'æ‘©',
      'æ‰': 'æ‰', 'æ“': 'æ“', 'æŒ ': 'æ’“', 'æŠ“': 'æŠ“', 'æŒ–': 'æŒ–',
      'æ': 'æ', 'æ': 'æ’ˆ', 'æ¡': 'æ’¿', 'æ‹¾': 'æ‹¾', 'æ§': 'æ§',
      'æ‰˜': 'è¨—', 'ä¸¾': 'èˆ‰', 'æŠ¬': 'æŠ¬', 'æ': 'æ', 'æ‹': 'æ‹',
      'æ¬': 'æ¬', 'æ‰›': 'æ‰›', 'æŠ—': 'æŠ—', 'æŒ‘': 'æŒ‘',
      'é©®': 'é¦±', 'è½½': 'è¼‰', 'è¿': 'é‹', 'é€': 'é€',
      'é€’': 'é', 'ä¼ ': 'å‚³', 'æ¥': 'æ¥', 'æ”¶': 'æ”¶', 'å–': 'å–',
      'é¢†': 'é ˜', 'æ¢': 'æ›', 'äº¤': 'äº¤', 'ä»˜': 'ä»˜',
      'å€Ÿ': 'å€Ÿ', 'è´·': 'è²¸', 'æ¬ ': 'æ¬ ', 'å€º': 'å‚µ', 'ç§Ÿ': 'ç§Ÿ',
      'èµ': 'è³ƒ', 'å–': 'è³£', 'è´­': 'è³¼', 'è®¢': 'è¨‚', 'é¢„': 'é ',
      'å®š': 'å®š', 'æ”¹': 'æ”¹', 'å˜': 'è®Š', 'åŒ–': 'åŒ–',
      'ä»£': 'ä»£', 'æ›¿': 'æ›¿', 'è¡¥': 'è£œ', 'å……': 'å……',
      'å¡«': 'å¡«', 'å¢': 'å¢', 'æ·»': 'æ·»', 'å‰Š': 'å‰Š',
      'é™': 'é™', 'å‡': 'å‡', 'æ¶¨': 'æ¼²', 'è·Œ': 'è·Œ',
      'è½': 'è½', 'è·³': 'è·³', 'è¹¦': 'è¹¦', 'è¸¢': 'è¸¢', 'è¸©': 'è¸©',
      'è¸': 'è¸', 'è·¨': 'è·¨', 'è¶Š': 'è¶Š', 'è¿ˆ': 'é‚',
      'è·‘': 'è·‘', 'å¥”': 'å¥”', 'è¿½': 'è¿½', 'èµ¶': 'è¶•', 'é€ƒ': 'é€ƒ',
      'èº²': 'èº²', 'è—': 'è—', 'é¿': 'é¿', 'é—ª': 'é–ƒ',
      'é€€': 'é€€', 'è¿”': 'è¿”', 'ç¦»': 'é›¢', 'åˆ«': 'åˆ¥', 'èµ°': 'èµ°',
      'æ­¥': 'æ­¥', 'æ¸¸': 'éŠ', 'é€›': 'é€›', 'æ•£': 'æ•£',
      'æºœ': 'æºœ', 'è¾¾': 'é”', 'è®¿': 'è¨ª', 'æ¢': 'æ¢',
      'è¿': 'è¿', 'å¾…': 'å¾…', 'ç•™': 'ç•™', 'ä½': 'ä½', 'å®¿': 'å®¿', 'å±…': 'å±…',
      'è¿': 'é·', 'ç§»': 'ç§»', 'ç«™': 'ç«™', 'ç«‹': 'ç«‹',
      'ç«–': 'è±', 'å§': 'è‡¥', 'èºº': 'èºº', 'è¶´': 'è¶´',
      'è·ª': 'è·ª', 'è¹²': 'è¹²', 'å': 'å', 'é ': 'é ', 'å€š': 'å€š',
      'æŒ‚': 'æ›', 'æ‚¬': 'æ‡¸', 'åŠ': 'åŠ', 'å‚': 'å‚',
      'ç»‘': 'ç¶', 'æ‰': 'ç´®', 'æ†': 'æ†', 'ç¼ ': 'çº', 'ç»•': 'ç¹',
      'å·': 'æ²', 'å ': 'ç–Š', 'æŠ˜': 'æŠ˜', 'å¼¯': 'å½', 'æ›²': 'æ›²',
      'ç›´': 'ç›´', 'é¡º': 'é †', 'æ–œ': 'æ–œ', 'æ­ª': 'æ­ª',
      'åœ†': 'åœ“', 'å°–': 'å°–', 'é’': 'éˆ', 'é”': 'éŠ³',
      'åˆ©': 'åˆ©', 'æ»‘': 'æ»‘', 'æ¶©': 'æ¾€', 'ç³™': 'ç³™',
      'è½¯': 'è»Ÿ', 'ç¡¬': 'ç¡¬', 'æ¾': 'é¬†', 'ç´§': 'ç·Š', 'å®': 'å¯¦',
      'è™š': 'è™›', 'å›º': 'å›º', 'ç¨³': 'ç©©', 'é¢¤': 'é¡«', 'æŠ–': 'æŠ–', 'éœ‡': 'éœ‡', 'æŒ¯': 'æŒ¯',
      'æ­¢': 'æ­¢', 'åœ': 'åœ', 'æ­‡': 'æ­‡',
      'ä¼‘': 'ä¼‘', 'çœ ': 'çœ ', 'è¿·': 'è¿·',
      'ç³Š': 'ç³Š', 'æ™•': 'æšˆ', 'æ˜': 'æ˜', 'æ²‰': 'æ²‰',
      'é­‡': 'é­˜', 'å‘“': 'å›ˆ', 'è¯­': 'èª', 'é¼¾': 'é¼¾',
      'ç£¨': 'ç£¨', 'æ¸¸': 'éŠ', 'æƒŠ': 'é©š',
      'å“': 'åš‡', 'æ': 'æ', 'æƒ§': 'æ‡¼', 'æ…Œ': 'æ…Œ',
      'æ€¥': 'æ€¥', 'ç´§': 'ç·Š', 'è¿«': 'è¿«', 'å¼›': 'å¼›', 'æ‡ˆ': 'æ‡ˆ',
      'æ€ ': 'æ€ ', 'æ‡’': 'æ‡¶', 'æƒ°': 'æƒ°', 'å‹¤': 'å‹¤',
      'åŠª': 'åŠª', 'åŠ›': 'åŠ›', 'åŠ²': 'å‹', 'æ‹¼': 'æ‹¼', 'æ': 'æ',
      'ç«': 'ç«¶', 'æŠ¢': 'æ¶', 'å¤º': 'å¥ª', 'å ': 'ä½”',
      'æ®': 'æ“š', 'å®ˆ': 'å®ˆ', 'é˜²': 'é˜²', 'æŠ¤': 'è­·',
      'ä¿': 'ä¿', 'é™©': 'éšª', 'å®‰': 'å®‰', 'å…¨': 'å…¨', 'å±': 'å±',
      'ç¾': 'ç½', 'ç¥¸': 'ç¦', 'æ‚£': 'æ‚£',
      'æ•…': 'æ•…', 'éšœ': 'éšœ', 'ç–¾': 'ç–¾',
      'ç—‡': 'ç—‡', 'çŠ¶': 'ç‹€', 'å†µ': 'æ³', 'ä¼¤': 'å‚·', 'æŸ': 'æ',
      'å®³': 'å®³', 'æ¯’': 'æ¯’', 'æ²»': 'æ²»', 'ç–—': 'ç™‚',
      'æ„ˆ': 'ç™’', 'å¤': 'å¾©', 'å£®': 'å£¯',
      'å¼º': 'å¼·', 'å¼±': 'å¼±', 'è¡°': 'è¡°',
      'è€': 'è€', 'å¹¼': 'å¹¼', 'å«©': 'å«©', 'é’': 'é’',
      'è¿ˆ': 'é‚', 'è½»': 'è¼•', 'é¾„': 'é½¡', 'å¯¿': 'å£½', 'å‘½': 'å‘½',
      'æ­»': 'æ­»', 'äº¡': 'äº¡', 'ç»ˆ': 'çµ‚', 'æœ«': 'æœ«', 'ä¸´': 'è‡¨',
      'é—': 'éº', 'æ‰¿': 'æ‰¿',
      'ç»§': 'ç¹¼', 'ç»­': 'çºŒ', 'æ–­': 'æ–·', 'ç»': 'çµ•', 'ç­': 'æ»…',
      'å­˜': 'å­˜', 'æœ‰': 'æœ‰', 'æ— ': 'ç„¡',
      'ä¹': 'ä¹', 'æ¬ ': 'æ¬ ',
      'è¶³': 'è¶³', 'è£•': 'è£•', 'ä½™': 'é¤˜',
      'å‰©': 'å‰©'
    };

    function convertToTraditional(text) {
      let result = '';
      for (let char of text) {
        result += conversionMap[char] || char;
      }
      return result;
    }

    const dataHandler = {
      onDataChanged(data) {
        allWords = data.sort((a, b) => a.hsk_level - b.hsk_level || a.simplified.localeCompare(b.simplified));
        lastSyncTime = new Date();
        if (!isLoading && currentView !== 'add') {
          renderApp();
        } else if (currentView === 'add') {
          const syncIndicators = document.querySelectorAll('.sync-indicator');
          syncIndicators.forEach(indicator => {
            const parent = indicator.parentElement;
            if (parent) {
              const timeSpan = parent.querySelector('.sync-time');
              if (timeSpan) {
                timeSpan.textContent = `æœ€å¾ŒåŒæ­¥ï¼š${formatSyncTime()}`;
              }
            }
          });
        }
      }
    };

    async function onConfigChange(config) {
      const baseSize = config.font_size || defaultConfig.font_size;
      const customFont = config.font_family || defaultConfig.font_family;
      const baseFontStack = 'system-ui, -apple-system, sans-serif';

      document.body.style.backgroundColor = config.background_color || defaultConfig.background_color;
      document.body.style.fontFamily = `${customFont}, ${baseFontStack}`;
      document.body.style.fontSize = `${baseSize}px`;
      document.body.style.color = config.text_color || defaultConfig.text_color;

      renderApp();
    }

    async function initializeSDKs() {
      const elementResult = await window.elementSdk.init({
        defaultConfig,
        onConfigChange,
        mapToCapabilities: (config) => ({
          recolorables: [
            {
              get: () => config.background_color || defaultConfig.background_color,
              set: (value) => {
                window.elementSdk.config.background_color = value;
                window.elementSdk.setConfig({ background_color: value });
              }
            },
            {
              get: () => config.card_color || defaultConfig.card_color,
              set: (value) => {
                window.elementSdk.config.card_color = value;
                window.elementSdk.setConfig({ card_color: value });
              }
            },
            {
              get: () => config.primary_color || defaultConfig.primary_color,
              set: (value) => {
                window.elementSdk.config.primary_color = value;
                window.elementSdk.setConfig({ primary_color: value });
              }
            },
            {
              get: () => config.text_color || defaultConfig.text_color,
              set: (value) => {
                window.elementSdk.config.text_color = value;
                window.elementSdk.setConfig({ text_color: value });
              }
            },
            {
              get: () => config.accent_color || defaultConfig.accent_color,
              set: (value) => {
                window.elementSdk.config.accent_color = value;
                window.elementSdk.setConfig({ accent_color: value });
              }
            }
          ],
          borderables: [],
          fontEditable: {
            get: () => config.font_family || defaultConfig.font_family,
            set: (value) => {
              window.elementSdk.config.font_family = value;
              window.elementSdk.setConfig({ font_family: value });
            }
          },
          fontSizeable: {
            get: () => config.font_size || defaultConfig.font_size,
            set: (value) => {
              window.elementSdk.config.font_size = value;
              window.elementSdk.setConfig({ font_size: value });
            }
          }
        }),
        mapToEditPanelValues: (config) => new Map([
          ["site_title", config.site_title || defaultConfig.site_title],
          ["search_placeholder", config.search_placeholder || defaultConfig.search_placeholder]
        ])
      });

      const dataResult = await window.dataSdk.init(dataHandler);

      if (!dataResult.isOk) {
        console.error("Failed to initialize Data SDK");
      }
    }

    function getColors() {
      const config = window.elementSdk?.config || defaultConfig;
      return {
        background: config.background_color || defaultConfig.background_color,
        card: config.card_color || defaultConfig.card_color,
        primary: config.primary_color || defaultConfig.primary_color,
        text: config.text_color || defaultConfig.text_color,
        accent: config.accent_color || defaultConfig.accent_color
      };
    }

    function getFontSize() {
      const config = window.elementSdk?.config || defaultConfig;
      return config.font_size || defaultConfig.font_size;
    }

    function formatSyncTime() {
      if (!lastSyncTime) return 'å°šæœªåŒæ­¥';
      const now = new Date();
      const diff = Math.floor((now - lastSyncTime) / 1000);

      if (diff < 5) return 'å‰›å‰›';
      if (diff < 60) return `${diff} ç§’å‰`;
      if (diff < 3600) return `${Math.floor(diff / 60)} åˆ†é˜å‰`;
      return lastSyncTime.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' });
    }

    function renderApp() {
      const app = document.getElementById('app');
      const colors = getColors();
      const baseSize = getFontSize();
      const config = window.elementSdk?.config || defaultConfig;

      if (currentView === 'home') {
        app.innerHTML = renderHome(colors, baseSize, config);
      } else if (currentView === 'browse') {
        app.innerHTML = renderBrowse(colors, baseSize, config);
      } else if (currentView === 'add') {
        app.innerHTML = renderAddWord(colors, baseSize, config);
      } else if (currentView === 'study') {
        app.innerHTML = renderStudy(colors, baseSize, config);
      } else if (currentView === 'test') {
        app.innerHTML = renderTest(colors, baseSize, config);
      } else if (currentView === 'multiple-choice') {
        app.innerHTML = renderMultipleChoice(colors, baseSize, config);
      } else if (currentView === 'speed-challenge') {
        app.innerHTML = renderSpeedChallenge(colors, baseSize, config);
      } else if (currentView === 'matching') {
        app.innerHTML = renderMatching(colors, baseSize, config);
      } else if (currentView === 'listening') {
        app.innerHTML = renderListening(colors, baseSize, config);
      } else if (currentView === 'results') {
        app.innerHTML = renderResults(colors, baseSize, config);
      }

      attachEventListeners();
    }

    function renderSyncIndicator(colors, baseSize) {
      return `
        <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background-color: ${colors.card}; border-radius: 0.5rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
          <div class="sync-indicator" style="width: 8px; height: 8px; background-color: ${colors.accent}; border-radius: 50%;"></div>
          <div style="font-size: ${baseSize * 0.85}px; color: ${colors.text};">
            <span style="font-weight: 600;">Canva Sheet å·²é€£çµ</span>
            <span class="sync-time" style="opacity: 0.6; margin-left: 0.5rem;">æœ€å¾ŒåŒæ­¥ï¼š${formatSyncTime()}</span>
          </div>
        </div>
      `;
    }

    function renderHome(colors, baseSize, config) {
      const levelCounts = Array(9).fill(0);
      allWords.forEach(word => {
        if (word.hsk_level >= 1 && word.hsk_level <= 9) {
          levelCounts[word.hsk_level - 1]++;
        }
      });

      return `
        ${showLevelModal ? `
          <div id="level-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; padding: 1rem;">
            <div style="background-color: ${colors.card}; padding: 2rem; border-radius: 1rem; max-width: 600px; width: 100%; max-height: 80%; overflow-y: auto; box-shadow: 0 20px 25px rgba(0,0,0,0.3);">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h2 style="font-size: ${baseSize * 1.5}px; font-weight: bold; color: ${colors.text};">ç®¡ç†ç­‰ç´šé¸é …</h2>
                <button id="close-level-modal-btn" style="background-color: transparent; border: none; font-size: ${baseSize * 1.5}px; color: ${colors.text}; cursor: pointer; padding: 0.25rem; line-height: 1;">âœ•</button>
              </div>

              <div style="margin-bottom: 1.5rem;">
                <label style="display: block; font-size: ${baseSize}px; font-weight: 600; color: ${colors.text}; margin-bottom: 0.5rem;">
                  æ–°å¢ç­‰ç´šé¸é …
                </label>
                <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                  <input type="text" id="new-level-label" placeholder="ç­‰ç´šåç¨± (å¦‚: HSK 10)"
                    style="flex: 1; padding: 0.75rem; border: 2px solid ${colors.primary}; border-radius: 0.5rem; font-size: ${baseSize}px; background-color: white; color: ${colors.text};">
                  <input type="number" id="new-level-value" placeholder="ç­‰ç´šæ•¸å€¼" min="1" max="99"
                    style="width: 120px; padding: 0.75rem; border: 2px solid ${colors.primary}; border-radius: 0.5rem; font-size: ${baseSize}px; background-color: white; color: ${colors.text};">
                </div>
                <button id="add-level-btn" style="width: 100%; padding: 0.75rem; background-color: ${colors.accent}; color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-size: ${baseSize}px;">
                  æ–°å¢ç­‰ç´š
                </button>
              </div>

              <div style="margin-bottom: 1rem;">
                <h3 style="font-size: ${baseSize * 1.1}px; font-weight: bold; color: ${colors.text}; margin-bottom: 0.75rem;">
                  ç¾æœ‰ç­‰ç´šé¸é … (${customLevels.length})
                </h3>
              </div>

              <div id="levels-list" style="display: grid; gap: 0.5rem;">
                ${customLevels.map((level, index) => `
                  <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 1rem; background-color: ${colors.background}; border-radius: 0.5rem;">
                    <div>
                      <span style="font-size: ${baseSize}px; color: ${colors.text}; font-weight: 600;">${level.label}</span>
                      <span style="font-size: ${baseSize * 0.85}px; color: ${colors.text}; opacity: 0.6; margin-left: 0.5rem;">(æ•¸å€¼: ${level.value})</span>
                    </div>
                    <button class="delete-level-btn" data-index="${index}" style="background-color: #ef4444; color: white; padding: 0.25rem 0.75rem; border-radius: 0.5rem; border: none; cursor: pointer; font-size: ${baseSize * 0.85}px;">
                      åˆªé™¤
                    </button>
                  </div>
                `).join('')}
              </div>
            </div>
          </div>
        ` : ''}
        <div class="w-full min-h-full" style="background-color: ${colors.background}; padding: 2rem;">
          <div style="max-width: 1200px; margin: 0 auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem;">
              <div style="text-align: center; flex: 1;">
                <h1 style="font-size: ${baseSize * 2.5}px; font-weight: bold; color: ${colors.text}; margin-bottom: 0.5rem;">
                  ${(config && config.site_title) || defaultConfig.site_title}
                </h1>
                <p style="font-size: ${baseSize * 1.1}px; color: ${colors.text}; opacity: 0.7;">
                  å°ˆæ¥­çš„ HSK ç”Ÿè©å­¸ç¿’å¹³å°
                </p>
              </div>
              ${renderSyncIndicator(colors, baseSize)}
            </div>

            <div style="background-color: ${colors.card}; padding: 1.5rem; border-radius: 1rem; margin-bottom: 2rem; border-left: 4px solid ${colors.accent};">
              <div style="display: flex; align-items: start; gap: 1rem;">
                <div style="font-size: ${baseSize * 2}px;">ğŸ“Š</div>
                <div style="flex: 1;">
                  <h3 style="font-size: ${baseSize * 1.2}px; font-weight: bold; color: ${colors.text}; margin-bottom: 0.5rem;">
                    Canva Sheet é›™å‘åŒæ­¥å·²å•Ÿç”¨
                  </h3>
                  <p style="font-size: ${baseSize * 0.9}px; color: ${colors.text}; opacity: 0.8; margin-bottom: 0.75rem;">
                    æ‚¨çš„ç”Ÿè©è³‡æ–™æœƒè‡ªå‹•å„²å­˜åˆ° Canva Sheetï¼ˆè©¦ç®—è¡¨ï¼‰ã€‚æ‚¨å¯ä»¥ï¼š
                  </p>
                  <ul style="font-size: ${baseSize * 0.85}px; color: ${colors.text}; opacity: 0.8; list-style: none; padding: 0;">
                    <li style="margin-bottom: 0.25rem;">âœ“ åœ¨ç¶²ç«™ä¸Šæ–°å¢/åˆªé™¤ç”Ÿè© â†’ è‡ªå‹•åŒæ­¥åˆ°è©¦ç®—è¡¨</li>
                    <li style="margin-bottom: 0.25rem;">âœ“ åœ¨è©¦ç®—è¡¨ä¸­ç·¨è¼¯ç”Ÿè© â†’ è‡ªå‹•æ›´æ–°åˆ°ç¶²ç«™</li>
                    <li style="margin-bottom: 0.25rem;">âœ“ é›™å‘å³æ™‚åŒæ­¥ï¼Œè³‡æ–™æ°¸ä¸éºå¤±</li>
                  </ul>
                </div>
              </div>
            </div>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-bottom: 3rem;">
              <div class="action-card" data-action="browse" style="background-color: ${colors.card}; padding: 2rem; border-radius: 1rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); cursor: pointer; transition: transform 0.2s;">
                <div style="font-size: ${baseSize * 2}px; margin-bottom: 1rem;">ğŸ“š</div>
                <h3 style="font-size: ${baseSize * 1.3}px; font-weight: bold; color: ${colors.text}; margin-bottom: 0.5rem;">ç€è¦½ç”Ÿè©</h3>
                <p style="font-size: ${baseSize * 0.9}px; color: ${colors.text}; opacity: 0.7;">æŸ¥çœ‹å’Œæœå°‹æ‰€æœ‰ç”Ÿè©</p>
              </div>

              <div class="action-card" data-action="add" style="background-color: ${colors.card}; padding: 2rem; border-radius: 1rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); cursor: pointer; transition: transform 0.2s;">
                <div style="font-size: ${baseSize * 2}px; margin-bottom: 1rem;">â•</div>
                <h3 style="font-size: ${baseSize * 1.3}px; font-weight: bold; color: ${colors.text}; margin-bottom: 0.5rem;">æ–°å¢ç”Ÿè©</h3>
                <p style="font-size: ${baseSize * 0.9}px; color: ${colors.text}; opacity: 0.7;">æ·»åŠ æ–°çš„ HSK ç”Ÿè©</p>
              </div>

              <div class="action-card" data-action="study" style="background-color: ${colors.card}; padding: 2rem; border-radius: 1rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); cursor: pointer; transition: transform 0.2s;">
                <div style="font-size: ${baseSize * 2}px; margin-bottom: 1rem;">âœï¸</div>
                <h3 style="font-size: ${baseSize * 1.3}px; font-weight: bold; color: ${colors.text}; margin-bottom: 0.5rem;">è¨“ç·´æ¨¡å¼</h3>
                <p style="font-size: ${baseSize * 0.9}px; color: ${colors.text}; opacity: 0.7;">ä½¿ç”¨ç”Ÿè©å¡ç·´ç¿’è¨˜æ†¶</p>
              </div>
            </div>

            <div style="background-color: ${colors.card}; padding: 2rem; border-radius: 1rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h2 style="font-size: ${baseSize * 1.5}px; font-weight: bold; color: ${colors.text};">HSK ç­‰ç´šçµ±è¨ˆ</h2>
                <button id="manage-levels-btn" style="padding: 0.5rem 1rem; background-color: ${colors.accent}; color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-size: ${baseSize * 0.9}px;">
                  ç®¡ç†ç­‰ç´š
                </button>
              </div>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 1rem;">
                ${customLevels.map(level => {
                  let count = 0;
                  if (level.id === '7-9') {
                    count = allWords.filter(w => w.hsk_level >= 7 && w.hsk_level <= 9).length;
                  } else {
                    count = allWords.filter(w => w.hsk_level === level.value).length;
                  }
                  return `
                    <div style="text-align: center; padding: 1rem; background-color: ${colors.background}; border-radius: 0.5rem;">
                      <div style="font-size: ${baseSize * 1.8}px; font-weight: bold; color: ${colors.primary};">${count}</div>
                      <div style="font-size: ${baseSize * 0.85}px; color: ${colors.text}; opacity: 0.7; margin-top: 0.25rem;">${level.label}</div>
                    </div>
                  `;
                }).join('')}
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function renderBrowse(colors, baseSize, config) {
      return `
        <div class="w-full min-h-full" style="background-color: ${colors.background}; padding: 2rem;">
          <div style="max-width: 1200px; margin: 0 auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem;">
              <h1 style="font-size: ${baseSize * 2}px; font-weight: bold; color: ${colors.text};">ç€è¦½ç”Ÿè©</h1>
              <div style="display: flex; gap: 1rem; align-items: center;">
                ${renderSyncIndicator(colors, baseSize)}
                <button class="back-btn" style="padding: 0.75rem 1.5rem; background-color: ${colors.primary}; color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-size: ${baseSize}px;">
                  è¿”å›é¦–é 
                </button>
              </div>
            </div>

            <div style="margin-bottom: 2rem;">
              <input type="text" id="search-input" placeholder="${(config && config.search_placeholder) || defaultConfig.search_placeholder}"
                style="width: 100%; padding: 1rem; border: 2px solid ${colors.primary}; border-radius: 0.5rem; font-size: ${baseSize}px; background-color: ${colors.card}; color: ${colors.text};">
            </div>

            <div style="display: flex; gap: 0.5rem; margin-bottom: 2rem; flex-wrap: wrap;">
              <button class="level-filter" data-level="all" style="padding: 0.5rem 1rem; background-color: ${colors.primary}; color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-size: ${baseSize * 0.9}px;">
                å…¨éƒ¨
              </button>
              ${customLevels.map(level => `
                <button class="level-filter" data-level="${level.id}" style="padding: 0.5rem 1rem; background-color: ${colors.card}; color: ${colors.text}; border: 2px solid ${colors.primary}; border-radius: 0.5rem; cursor: pointer; font-size: ${baseSize * 0.9}px;">
                  ${level.label}
                </button>
              `).join('')}
            </div>

            <div id="words-container" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem;">
              ${renderWordCards(allWords, colors, baseSize)}
            </div>
          </div>
        </div>
      `;
    }

    function renderWordCards(words, colors, baseSize) {
      if (words.length === 0) {
        return `<div style="grid-column: 1/-1; text-align: center; padding: 3rem; color: ${colors.text}; opacity: 0.7; font-size: ${baseSize * 1.1}px;">å°šç„¡ç”Ÿè©è³‡æ–™</div>`;
      }

      return words.map(word => {
        const meanings = word.thai_meanings ? word.thai_meanings.split('|').filter(m => m.trim()) : [];
        const examples = word.example_sentences ? word.example_sentences.split('|').filter(e => e.trim()) : [];

        return `
          <div class="word-card" style="background-color: ${colors.card}; padding: 1.5rem; border-radius: 1rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
              <div>
                <div style="font-size: ${baseSize * 1.8}px; font-weight: bold; color: ${colors.text}; margin-bottom: 0.25rem;">
                  ${word.simplified}
                </div>
                <div style="font-size: ${baseSize * 0.9}px; color: ${colors.text}; opacity: 0.6;">
                  ${word.traditional}
                </div>
              </div>
              <div style="display: flex; gap: 0.5rem;">
                <span style="background-color: ${colors.primary}; color: white; padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: ${baseSize * 0.8}px;">
                  HSK ${word.hsk_level}
                </span>
                <button class="delete-word-btn" data-id="${word.id}" style="background-color: #ef4444; color: white; padding: 0.25rem 0.75rem; border-radius: 0.5rem; border: none; cursor: pointer; font-size: ${baseSize * 0.8}px;">
                  åˆªé™¤
                </button>
              </div>
            </div>

            <div style="margin-bottom: 1rem;">
              <div style="font-size: ${baseSize * 1.1}px; color: ${colors.primary}; margin-bottom: 0.5rem;">
                ${word.pinyin}
              </div>
              <div style="font-size: ${baseSize * 0.85}px; color: ${colors.accent}; font-weight: 600;">
                ${word.word_type}
              </div>
            </div>

            ${meanings.length > 0 ? `
              <div style="margin-bottom: 1rem;">
                <div style="font-size: ${baseSize * 0.9}px; font-weight: bold; color: ${colors.text}; margin-bottom: 0.5rem;">
                  æ³°æ–‡ç¿»è­¯ï¼š
                </div>
                ${meanings.map(m => `
                  <div style="font-size: ${baseSize * 0.85}px; color: ${colors.text}; opacity: 0.8; margin-bottom: 0.25rem;">
                    â€¢ ${m.trim()}
                  </div>
                `).join('')}
              </div>
            ` : ''}

            ${examples.length > 0 ? `
              <div>
                <div style="font-size: ${baseSize * 0.9}px; font-weight: bold; color: ${colors.text}; margin-bottom: 0.5rem;">
                  ä¾‹å¥ï¼š
                </div>
                ${examples.map(e => `
                  <div style="font-size: ${baseSize * 0.85}px; color: ${colors.text}; opacity: 0.8; margin-bottom: 0.25rem; font-style: italic;">
                    ${e.trim()}
                  </div>
                `).join('')}
              </div>
            ` : ''}
          </div>
        `;
      }).join('');
    }

    function renderAddWord(colors, baseSize, config) {
      return `
        <div class="w-full min-h-full" style="background-color: ${colors.background}; padding: 2rem;">
          ${showWordTypeModal ? `
            <div id="word-type-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; padding: 1rem;">
              <div style="background-color: ${colors.card}; padding: 2rem; border-radius: 1rem; max-width: 600px; width: 100%; max-height: 80%; overflow-y: auto; box-shadow: 0 20px 25px rgba(0,0,0,0.3);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                  <h2 style="font-size: ${baseSize * 1.5}px; font-weight: bold; color: ${colors.text};">ç®¡ç†è©æ€§</h2>
                  <button id="close-modal-btn" style="background-color: transparent; border: none; font-size: ${baseSize * 1.5}px; color: ${colors.text}; cursor: pointer; padding: 0.25rem; line-height: 1;">âœ•</button>
                </div>

                <div style="margin-bottom: 1.5rem;">
                  <label style="display: block; font-size: ${baseSize}px; font-weight: 600; color: ${colors.text}; margin-bottom: 0.5rem;">
                    æ–°å¢è©æ€§
                  </label>
                  <div style="display: flex; gap: 0.5rem;">
                    <input type="text" id="new-word-type-input" placeholder="è¼¸å…¥æ–°è©æ€§"
                      style="flex: 1; padding: 0.75rem; border: 2px solid ${colors.primary}; border-radius: 0.5rem; font-size: ${baseSize}px; background-color: white; color: ${colors.text};">
                    <button id="add-word-type-btn" style="padding: 0.75rem 1.5rem; background-color: ${colors.accent}; color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-size: ${baseSize}px; white-space: nowrap;">
                      æ–°å¢
                    </button>
                  </div>
                </div>

                <div style="margin-bottom: 1rem;">
                  <h3 style="font-size: ${baseSize * 1.1}px; font-weight: bold; color: ${colors.text}; margin-bottom: 0.75rem;">
                    ç¾æœ‰è©æ€§ (${customWordTypes.length})
                  </h3>
                </div>

                <div id="word-types-list" style="display: grid; gap: 0.5rem;">
                  ${customWordTypes.map((type, index) => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 1rem; background-color: ${colors.background}; border-radius: 0.5rem;">
                      <span style="font-size: ${baseSize}px; color: ${colors.text};">${type}</span>
                      <button class="delete-word-type-btn" data-index="${index}" style="background-color: #ef4444; color: white; padding: 0.25rem 0.75rem; border-radius: 0.5rem; border: none; cursor: pointer; font-size: ${baseSize * 0.85}px;">
                        åˆªé™¤
                      </button>
                    </div>
                  `).join('')}
                </div>
              </div>
            </div>
          ` : ''}
          ${showLevelModal ? `
            <div id="level-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; padding: 1rem;">
              <div style="background-color: ${colors.card}; padding: 2rem; border-radius: 1rem; max-width: 600px; width: 100%; max-height: 80%; overflow-y: auto; box-shadow: 0 20px 25px rgba(0,0,0,0.3);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                  <h2 style="font-size: ${baseSize * 1.5}px; font-weight: bold; color: ${colors.text};">ç®¡ç†ç­‰ç´šé¸é …</h2>
                  <button id="close-level-modal-btn" style="background-color: transparent; border: none; font-size: ${baseSize * 1.5}px; color: ${colors.text}; cursor: pointer; padding: 0.25rem; line-height: 1;">âœ•</button>
                </div>

                <div style="margin-bottom: 1.5rem;">
                  <label style="display: block; font-size: ${baseSize}px; font-weight: 600; color: ${colors.text}; margin-bottom: 0.5rem;">
                    æ–°å¢ç­‰ç´šé¸é …
                  </label>
                  <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                    <input type="text" id="new-level-label" placeholder="ç­‰ç´šåç¨± (å¦‚: HSK 10)"
                      style="flex: 1; padding: 0.75rem; border: 2px solid ${colors.primary}; border-radius: 0.5rem; font-size: ${baseSize}px; background-color: white; color: ${colors.text};">
                    <input type="number" id="new-level-value" placeholder="ç­‰ç´šæ•¸å€¼" min="1" max="99"
                      style="width: 120px; padding: 0.75rem; border: 2px solid ${colors.primary}; border-radius: 0.5rem; font-size: ${baseSize}px; background-color: white; color: ${colors.text};">
                  </div>
                  <button id="add-level-btn" style="width: 100%; padding: 0.75rem; background-color: ${colors.accent}; color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-size: ${baseSize}px;">
                    æ–°å¢ç­‰ç´š
                  </button>
                </div>

                <div style="margin-bottom: 1rem;">
                  <h3 style="font-size: ${baseSize * 1.1}px; font-weight: bold; color: ${colors.text}; margin-bottom: 0.75rem;">
                    ç¾æœ‰ç­‰ç´šé¸é … (${customLevels.length})
                  </h3>
                </div>

                <div id="levels-list" style="display: grid; gap: 0.5rem;">
                  ${customLevels.map((level, index) => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 1rem; background-color: ${colors.background}; border-radius: 0.5rem;">
                      <div>
                        <span style="font-size: ${baseSize}px; color: ${colors.text}; font-weight: 600;">${level.label}</span>
                        <span style="font-size: ${baseSize * 0.85}px; color: ${colors.text}; opacity: 0.6; margin-left: 0.5rem;">(æ•¸å€¼: ${level.value})</span>
                      </div>
                      <button class="delete-level-btn" data-index="${index}" style="background-color: #ef4444; color: white; padding: 0.25rem 0.75rem; border-radius: 0.5rem; border: none; cursor: pointer; font-size: ${baseSize * 0.85}px;">
                        åˆªé™¤
                      </button>
                    </div>
                  `).join('')}
                </div>
              </div>
            </div>
          ` : ''}
          <div style="max-width: 800px; margin: 0 auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem;">
              <h1 style="font-size: ${baseSize * 2}px; font-weight: bold; color: ${colors.text};">æ–°å¢ç”Ÿè©</h1>
              <div style="display: flex; gap: 1rem; align-items: center;">
                ${renderSyncIndicator(colors, baseSize)}
                <button class="back-btn" style="padding: 0.75rem 1.5rem; background-color: ${colors.primary}; color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-size: ${baseSize}px;">
                  è¿”å›é¦–é 
                </button>
              </div>
            </div>

            ${allWords.length >= 999 ? `
              <div style="background-color: #fef2f2; border: 2px solid #ef4444; padding: 1rem; border-radius: 0.5rem; margin-bottom: 2rem; color: #991b1b; font-size: ${baseSize}px;">
                å·²é”åˆ°æœ€å¤§ç”Ÿè©æ•¸é‡é™åˆ¶ï¼ˆ999å€‹ï¼‰ã€‚è«‹å…ˆåˆªé™¤ä¸€äº›ç”Ÿè©å¾Œå†æ–°å¢ã€‚
              </div>
            ` : ''}

            <form id="add-word-form" style="background-color: ${colors.card}; padding: 2rem; border-radius: 1rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
              <div style="margin-bottom: 1.5rem;">
                <label style="display: block; font-size: ${baseSize}px; font-weight: 600; color: ${colors.text}; margin-bottom: 0.5rem;">
                  ç°¡é«”å­— *
                </label>
                <input type="text" id="simplified" required
                  style="width: 100%; padding: 0.75rem; border: 2px solid ${colors.primary}; border-radius: 0.5rem; font-size: ${baseSize}px; background-color: white; color: ${colors.text};">
              </div>

              <div style="margin-bottom: 1.5rem;">
                <label style="display: block; font-size: ${baseSize}px; font-weight: 600; color: ${colors.text}; margin-bottom: 0.5rem;">
                  ç¹é«”å­—ï¼ˆè‡ªå‹•ç”Ÿæˆï¼‰
                </label>
                <input type="text" id="traditional" readonly
                  style="width: 100%; padding: 0.75rem; border: 2px solid ${colors.primary}; border-radius: 0.5rem; font-size: ${baseSize}px; background-color: #f3f4f6; color: ${colors.text}; cursor: not-allowed;">
                <div style="font-size: ${baseSize * 0.8}px; color: ${colors.text}; opacity: 0.6; margin-top: 0.25rem;">
                  âœ“ è¼¸å…¥ç°¡é«”å­—å¾Œè‡ªå‹•è½‰æ›
                </div>
              </div>

              <div style="margin-bottom: 1.5rem;">
                <label style="display: block; font-size: ${baseSize}px; font-weight: 600; color: ${colors.text}; margin-bottom: 0.5rem;">
                  æ‹¼éŸ³ *
                </label>
                <input type="text" id="pinyin" required
                  style="width: 100%; padding: 0.75rem; border: 2px solid ${colors.primary}; border-radius: 0.5rem; font-size: ${baseSize}px; background-color: white; color: ${colors.text};">
              </div>

              <div style="margin-bottom: 1.5rem;">
                <label style="display: block; font-size: ${baseSize}px; font-weight: 600; color: ${colors.text}; margin-bottom: 0.5rem;">
                  è©æ€§ *
                </label>
                <div style="display: flex; gap: 0.5rem;">
                  <select id="word-type" required
                    style="flex: 1; padding: 0.75rem; border: 2px solid ${colors.primary}; border-radius: 0.5rem; font-size: ${baseSize}px; background-color: white; color: ${colors.text};">
                    <option value="">é¸æ“‡è©æ€§</option>
                    ${customWordTypes.map(type => `<option value="${type}">${type}</option>`).join('')}
                    <option value="è‡ªè¨‚">+ è‡ªè¨‚è©æ€§</option>
                  </select>
                  <button type="button" id="manage-word-types-btn"
                    style="padding: 0.75rem 1rem; background-color: ${colors.accent}; color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-size: ${baseSize * 0.9}px; white-space: nowrap;">
                    ç®¡ç†è©æ€§
                  </button>
                </div>
                <input type="text" id="custom-word-type" placeholder="è¼¸å…¥è‡ªè¨‚è©æ€§"
                  style="width: 100%; padding: 0.75rem; border: 2px solid ${colors.primary}; border-radius: 0.5rem; font-size: ${baseSize}px; background-color: white; color: ${colors.text}; margin-top: 0.5rem; display: none;">
              </div>

              <div style="margin-bottom: 1.5rem;">
                <label style="display: block; font-size: ${baseSize}px; font-weight: 600; color: ${colors.text}; margin-bottom: 0.5rem;">
                  æ³°æ–‡ç¿»è­¯ * (ç”¨ | åˆ†éš”å¤šå€‹æ„æ€)
                </label>
                <textarea id="thai-meanings" required rows="3" placeholder="æ„æ€1 | æ„æ€2 | æ„æ€3"
                  style="width: 100%; padding: 0.75rem; border: 2px solid ${colors.primary}; border-radius: 0.5rem; font-size: ${baseSize}px; background-color: white; color: ${colors.text}; resize: vertical;"></textarea>
              </div>

              <div style="margin-bottom: 1.5rem;">
                <label style="display: block; font-size: ${baseSize}px; font-weight: 600; color: ${colors.text}; margin-bottom: 0.5rem;">
                  ä¾‹å¥ (ç”¨ | åˆ†éš”å¤šå€‹ä¾‹å¥)
                </label>
                <textarea id="examples" rows="3" placeholder="ä¾‹å¥1 | ä¾‹å¥2 | ä¾‹å¥3"
                  style="width: 100%; padding: 0.75rem; border: 2px solid ${colors.primary}; border-radius: 0.5rem; font-size: ${baseSize}px; background-color: white; color: ${colors.text}; resize: vertical;"></textarea>
              </div>

              <div style="margin-bottom: 2rem;">
                <label style="display: block; font-size: ${baseSize}px; font-weight: 600; color: ${colors.text}; margin-bottom: 0.5rem;">
                  HSK ç­‰ç´š *
                </label>
                <div style="display: flex; gap: 0.5rem;">
                  <select id="hsk-level" required
                    style="flex: 1; padding: 0.75rem; border: 2px solid ${colors.primary}; border-radius: 0.5rem; font-size: ${baseSize}px; background-color: white; color: ${colors.text};">
                    <option value="">é¸æ“‡ç­‰ç´š</option>
                    ${customLevels.map(level => `<option value="${level.value}">${level.label}</option>`).join('')}
                  </select>
                  <button type="button" id="manage-levels-add-btn"
                    style="padding: 0.75rem 1rem; background-color: ${colors.accent}; color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-size: ${baseSize * 0.9}px; white-space: nowrap;">
                    ç®¡ç†ç­‰ç´š
                  </button>
                </div>
              </div>

              <div id="form-message" style="margin-bottom: 1rem; padding: 0.75rem; border-radius: 0.5rem; display: none;"></div>

              <button type="submit" id="submit-btn" ${allWords.length >= 999 ? 'disabled' : ''}
                style="width: 100%; padding: 1rem; background-color: ${colors.accent}; color: white; border: none; border-radius: 0.5rem; cursor: ${allWords.length >= 999 ? 'not-allowed' : 'pointer'}; font-size: ${baseSize * 1.1}px; font-weight: bold; opacity: ${allWords.length >= 999 ? '0.5' : '1'};">
                æ–°å¢ç”Ÿè©åˆ° Canva Sheet
              </button>
            </form>
          </div>
        </div>
      `;
    }

    function renderStudy(colors, baseSize, config) {
      if (!selectedLevel) {
        return `
          <div class="w-full min-h-full" style="background-color: ${colors.background}; padding: 2rem;">
            <div style="max-width: 800px; margin: 0 auto;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <h1 style="font-size: ${baseSize * 2}px; font-weight: bold; color: ${colors.text};">é¸æ“‡è¨“ç·´ç­‰ç´š</h1>
                <button class="back-btn" style="padding: 0.75rem 1.5rem; background-color: ${colors.primary}; color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-size: ${baseSize}px;">
                  è¿”å›é¦–é 
                </button>
              </div>

              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                ${customLevels.map(level => {
                  let levelWords;
                  if (level.id === '7-9') {
                    levelWords = allWords.filter(w => w.hsk_level >= 7 && w.hsk_level <= 9);
                  } else {
                    levelWords = allWords.filter(w => w.hsk_level === level.value);
                  }
                  return `
                    <button class="select-level-btn" data-level="${level.id}" ${levelWords.length === 0 ? 'disabled' : ''}
                      style="padding: 2rem 1rem; background-color: ${colors.card}; color: ${colors.text}; border: 2px solid ${colors.primary}; border-radius: 1rem; cursor: ${levelWords.length === 0 ? 'not-allowed' : 'pointer'}; opacity: ${levelWords.length === 0 ? '0.5' : '1'};">
                      <div style="font-size: ${baseSize * 1.5}px; font-weight: bold; margin-bottom: 0.5rem;">${level.label}</div>
                      <div style="font-size: ${baseSize * 0.9}px; opacity: 0.7;">${levelWords.length} å€‹ç”Ÿè©</div>
                    </button>
                  `;
                }).join('')}
              </div>
            </div>
          </div>
        `;
      }

      if (!studyMode) {
        return `
          <div class="w-full min-h-full" style="background-color: ${colors.background}; padding: 2rem;">
            <div style="max-width: 800px; margin: 0 auto;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <h1 style="font-size: ${baseSize * 2}px; font-weight: bold; color: ${colors.text};">HSK ${selectedLevel} è¨“ç·´æ¨¡å¼</h1>
                <button class="back-to-level-btn" style="padding: 0.75rem 1.5rem; background-color: ${colors.primary}; color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-size: ${baseSize}px;">
                  è¿”å›
                </button>
              </div>

              <div style="display: grid; gap: 1.5rem;">
                <button class="select-mode-btn" data-mode="flashcard"
                  style="padding: 2rem; background-color: ${colors.card}; color: ${colors.text}; border: 2px solid ${colors.primary}; border-radius: 1rem; cursor: pointer; text-align: left;">
                  <div style="font-size: ${baseSize * 1.5}px; font-weight: bold; margin-bottom: 0.5rem;">ğŸ“‡ ç”Ÿè©å¡æ¨¡å¼</div>
                  <div style="font-size: ${baseSize}px; opacity: 0.7;">ç€è¦½ç”Ÿè©å¡ï¼Œé»æ“Šç¿»è½‰æŸ¥çœ‹ç¿»è­¯å’Œä¾‹å¥</div>
                </button>

                <button class="select-mode-btn" data-mode="test"
                  style="padding: 2rem; background-color: ${colors.card}; color: ${colors.text}; border: 2px solid ${colors.primary}; border-radius: 1rem; cursor: pointer; text-align: left;">
                  <div style="font-size: ${baseSize * 1.5}px; font-weight: bold; margin-bottom: 0.5rem;">âœï¸ æ¸¬é©—æ¨¡å¼</div>
                  <div style="font-size: ${baseSize}px; opacity: 0.7;">æ¸¬è©¦ä½ çš„è¨˜æ†¶ï¼Œè¼¸å…¥æ­£ç¢ºçš„æ³°æ–‡ç¿»è­¯</div>
                </button>

                <button class="select-mode-btn" data-mode="multiple-choice"
                  style="padding: 2rem; background-color: ${colors.card}; color: ${colors.text}; border: 2px solid ${colors.primary}; border-radius: 1rem; cursor: pointer; text-align: left;">
                  <div style="font-size: ${baseSize * 1.5}px; font-weight: bold; margin-bottom: 0.5rem;">ğŸ¯ é¸æ“‡é¡Œæ¨¡å¼</div>
                  <div style="font-size: ${baseSize}px; opacity: 0.7;">å¾å››å€‹é¸é …ä¸­é¸å‡ºæ­£ç¢ºçš„æ³°æ–‡ç¿»è­¯</div>
                </button>

                <button class="select-mode-btn" data-mode="speed-challenge"
                  style="padding: 2rem; background-color: ${colors.card}; color: ${colors.text}; border: 2px solid ${colors.primary}; border-radius: 1rem; cursor: pointer; text-align: left;">
                  <div style="font-size: ${baseSize * 1.5}px; font-weight: bold; margin-bottom: 0.5rem;">âš¡ é€Ÿåº¦æŒ‘æˆ°</div>
                  <div style="font-size: ${baseSize}px; opacity: 0.7;">60ç§’å…§ç­”å°è¶Šå¤šè¶Šå¥½ï¼æ¸¬é©—åæ‡‰é€Ÿåº¦</div>
                </button>

                <button class="select-mode-btn" data-mode="matching"
                  style="padding: 2rem; background-color: ${colors.card}; color: ${colors.text}; border: 2px solid ${colors.primary}; border-radius: 1rem; cursor: pointer; text-align: left;">
                  <div style="font-size: ${baseSize * 1.5}px; font-weight: bold; margin-bottom: 0.5rem;">ğŸ´ é…å°éŠæˆ²</div>
                  <div style="font-size: ${baseSize}px; opacity: 0.7;">ç¿»ç‰Œæ‰¾å‡ºä¸­æ–‡å’Œæ³°æ–‡çš„é…å°çµ„åˆ</div>
                </button>

                <button class="select-mode-btn" data-mode="listening"
                  style="padding: 2rem; background-color: ${colors.card}; color: ${colors.text}; border: 2px solid ${colors.primary}; border-radius: 1rem; cursor: pointer; text-align: left;">
                  <div style="font-size: ${baseSize * 1.5}px; font-weight: bold; margin-bottom: 0.5rem;">ğŸ‘‚ æ‹¼éŸ³ç·´ç¿’</div>
                  <div style="font-size: ${baseSize}px; opacity: 0.7;">çœ‹æ‹¼éŸ³çŒœä¸­æ–‡ï¼Œè¨“ç·´ç™¼éŸ³è¨˜æ†¶</div>
                </button>
              </div>
            </div>
          </div>
        `;
      }

      if (studyMode === 'flashcard') {
        const word = studyWords[currentCardIndex];
        const meanings = word.thai_meanings ? word.thai_meanings.split('|').filter(m => m.trim()) : [];
        const examples = word.example_sentences ? word.example_sentences.split('|').filter(e => e.trim()) : [];

        return `
          <div class="w-full min-h-full" style="background-color: ${colors.background}; padding: 2rem;">
            <div style="max-width: 800px; margin: 0 auto;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <h1 style="font-size: ${baseSize * 1.5}px; font-weight: bold; color: ${colors.text};">ç”Ÿè©å¡ ${currentCardIndex + 1} / ${studyWords.length}</h1>
                <button class="back-to-mode-btn" style="padding: 0.75rem 1.5rem; background-color: ${colors.primary}; color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-size: ${baseSize}px;">
                  è¿”å›
                </button>
              </div>

              <div class="card-flip" id="flashcard" style="width: 100%; max-width: 600px; margin: 0 auto 2rem; cursor: pointer;">
                <div class="card-inner" style="width: 100%; padding-bottom: 100%; position: relative;">
                  <div class="card-front" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: ${colors.card}; padding: 3rem; display: flex; flex-direction: column; justify-content: center; align-items: center; box-shadow: 0 10px 20px rgba(0,0,0,0.2);">
                    <div style="font-size: ${baseSize * 4}px; font-weight: bold; color: ${colors.text}; margin-bottom: 1.5rem;">
                      ${word.simplified}
                    </div>
                    <div style="background-color: ${colors.accent}; color: white; padding: 0.75rem 1.5rem; border-radius: 1rem; font-size: ${baseSize * 1.1}px; font-weight: 600;">
                      ${word.word_type}
                    </div>
                    <div style="margin-top: 3rem; font-size: ${baseSize * 0.9}px; color: ${colors.text}; opacity: 0.5;">
                      é»æ“Šç¿»è½‰å¡ç‰‡
                    </div>
                  </div>

                  <div class="card-back" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: ${colors.card}; padding: 2rem; overflow-y: auto; box-shadow: 0 10px 20px rgba(0,0,0,0.2);">
                    <div style="text-align: center; margin-bottom: 2rem;">
                      <div style="font-size: ${baseSize * 2}px; font-weight: bold; color: ${colors.text}; margin-bottom: 0.5rem;">
                        ${word.simplified}
                      </div>
                      <div style="font-size: ${baseSize}px; color: ${colors.primary};">
                        ${word.pinyin}
                      </div>
                    </div>

                    <div style="margin-bottom: 1.5rem;">
                      <div style="font-size: ${baseSize}px; font-weight: bold; color: ${colors.text}; margin-bottom: 0.5rem;">
                        è©æ€§ï¼š<span style="color: ${colors.accent};">${word.word_type}</span>
                      </div>
                    </div>

                    ${meanings.length > 0 ? `
                      <div style="margin-bottom: 1.5rem;">
                        <div style="font-size: ${baseSize * 1.1}px; font-weight: bold; color: ${colors.text}; margin-bottom: 0.75rem;">
                          æ³°æ–‡ç¿»è­¯ï¼š
                        </div>
                        ${meanings.map(m => `
                          <div style="font-size: ${baseSize}px; color: ${colors.text}; margin-bottom: 0.5rem; padding-left: 1rem;">
                            â€¢ ${m.trim()}
                          </div>
                        `).join('')}
                      </div>
                    ` : ''}

                    ${examples.length > 0 ? `
                      <div>
                        <div style="font-size: ${baseSize * 1.1}px; font-weight: bold; color: ${colors.text}; margin-bottom: 0.75rem;">
                          ä¾‹å¥ï¼š
                        </div>
                        ${examples.map(e => `
                          <div style="font-size: ${baseSize * 0.95}px; color: ${colors.text}; margin-bottom: 0.5rem; padding-left: 1rem; font-style: italic; opacity: 0.9;">
                            ${e.trim()}
                          </div>
                        `).join('')}
                      </div>
                    ` : ''}

                    <div style="margin-top: 2rem; text-align: center; font-size: ${baseSize * 0.9}px; color: ${colors.text}; opacity: 0.5;">
                      é»æ“Šè¿”å›æ­£é¢
                    </div>
                  </div>
                </div>
              </div>

              <div style="display: flex; justify-content: space-between; gap: 1rem;">
                <button class="prev-card-btn" ${currentCardIndex === 0 ? 'disabled' : ''}
                  style="flex: 1; padding: 1rem; background-color: ${colors.primary}; color: white; border: none; border-radius: 0.5rem; cursor: ${currentCardIndex === 0 ? 'not-allowed' : 'pointer'}; font-size: ${baseSize}px; opacity: ${currentCardIndex === 0 ? '0.5' : '1'};">
                  â† ä¸Šä¸€å¼µ
                </button>
                <button class="next-card-btn" ${currentCardIndex === studyWords.length - 1 ? 'disabled' : ''}
                  style="flex: 1; padding: 1rem; background-color: ${colors.primary}; color: white; border: none; border-radius: 0.5rem; cursor: ${currentCardIndex === studyWords.length - 1 ? 'not-allowed' : 'pointer'}; font-size: ${baseSize}px; opacity: ${currentCardIndex === studyWords.length - 1 ? '0.5' : '1'};">
                  ä¸‹ä¸€å¼µ â†’
                </button>
              </div>
            </div>
          </div>
        `;
      }

      return '';
    }

    function renderTest(colors, baseSize, config) {
      const word = studyWords[currentCardIndex];
      const progress = ((currentCardIndex + 1) / studyWords.length) * 100;

      return `
        <div class="w-full min-h-full" style="background-color: ${colors.background}; padding: 2rem;">
          <div style="max-width: 800px; margin: 0 auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
              <h1 style="font-size: ${baseSize * 1.5}px; font-weight: bold; color: ${colors.text};">æ¸¬é©—æ¨¡å¼ - HSK ${selectedLevel}</h1>
              <button class="back-to-mode-btn" style="padding: 0.75rem 1.5rem; background-color: ${colors.primary}; color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-size: ${baseSize}px;">
                è¿”å›
              </button>
            </div>

            <div style="margin-bottom: 2rem;">
              <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                <span style="font-size: ${baseSize * 0.9}px; color: ${colors.text};">é€²åº¦ï¼š${currentCardIndex + 1} / ${studyWords.length}</span>
                <span style="font-size: ${baseSize * 0.9}px; color: ${colors.text};">ç›®å‰å¾—åˆ†ï¼š${testScore}</span>
              </div>
              <div style="width: 100%; height: 10px; background-color: ${colors.card}; border-radius: 1rem; overflow: hidden;">
                <div style="width: ${progress}%; height: 100%; background-color: ${colors.accent}; transition: width 0.3s;"></div>
              </div>
            </div>

            <div style="background-color: ${colors.card}; padding: 3rem; border-radius: 1rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 2rem;">
              <div style="text-align: center; margin-bottom: 2rem;">
                <div style="font-size: ${baseSize * 3}px; font-weight: bold; color: ${colors.text}; margin-bottom: 1rem;">
                  ${word.simplified}
                </div>
                <div style="font-size: ${baseSize * 1.2}px; color: ${colors.text}; opacity: 0.6; margin-bottom: 1rem;">
                  ${word.traditional}
                </div>
                <div style="font-size: ${baseSize * 1.3}px; color: ${colors.primary};">
                  ${word.pinyin}
                </div>
              </div>

              <form id="test-form">
                <div style="margin-bottom: 1.5rem;">
                  <label style="display: block; font-size: ${baseSize}px; font-weight: 600; color: ${colors.text}; margin-bottom: 0.5rem;">
                    è«‹è¼¸å…¥æ³°æ–‡ç¿»è­¯ï¼š
                  </label>
                  <input type="text" id="answer-input" required autofocus
                    style="width: 100%; padding: 1rem; border: 2px solid ${colors.primary}; border-radius: 0.5rem; font-size: ${baseSize * 1.1}px; background-color: white; color: ${colors.text};">
                </div>

                <div id="answer-feedback" style="margin-bottom: 1.5rem; padding: 1rem; border-radius: 0.5rem; display: none;"></div>

                <button type="submit" id="check-answer-btn"
                  style="width: 100%; padding: 1rem; background-color: ${colors.accent}; color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-size: ${baseSize * 1.1}px; font-weight: bold;">
                  æª¢æŸ¥ç­”æ¡ˆ
                </button>
              </form>
            </div>
          </div>
        </div>
      `;
    }

    function renderMultipleChoice(colors, baseSize, config) {
      const word = studyWords[currentCardIndex];
      const progress = ((currentCardIndex + 1) / studyWords.length) * 100;

      return `
        <div class="w-full min-h-full" style="background-color: ${colors.background}; padding: 2rem;">
          <div style="max-width: 800px; margin: 0 auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
              <h1 style="font-size: ${baseSize * 1.5}px; font-weight: bold; color: ${colors.text};">é¸æ“‡é¡Œæ¨¡å¼ - HSK ${selectedLevel}</h1>
              <button class="back-to-mode-btn" style="padding: 0.75rem 1.5rem; background-color: ${colors.primary}; color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-size: ${baseSize}px;">
                è¿”å›
              </button>
            </div>

            <div style="margin-bottom: 2rem;">
              <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                <span style="font-size: ${baseSize * 0.9}px; color: ${colors.text};">é€²åº¦ï¼š${currentCardIndex + 1} / ${studyWords.length}</span>
                <span style="font-size: ${baseSize * 0.9}px; color: ${colors.text};">ç›®å‰å¾—åˆ†ï¼š${testScore}</span>
              </div>
              <div style="width: 100%; height: 10px; background-color: ${colors.card}; border-radius: 1rem; overflow: hidden;">
                <div style="width: ${progress}%; height: 100%; background-color: ${colors.accent}; transition: width 0.3s;"></div>
              </div>
            </div>

            <div style="background-color: ${colors.card}; padding: 3rem; border-radius: 1rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 2rem;">
              <div style="text-align: center; margin-bottom: 3rem;">
                <div style="font-size: ${baseSize * 3}px; font-weight: bold; color: ${colors.text}; margin-bottom: 1rem;">
                  ${word.simplified}
                </div>
                <div style="font-size: ${baseSize * 1.3}px; color: ${colors.primary};">
                  ${word.pinyin}
                </div>
              </div>

              <div style="margin-bottom: 1.5rem;">
                <div style="font-size: ${baseSize * 1.1}px; font-weight: 600; color: ${colors.text}; margin-bottom: 1rem; text-align: center;">
                  é¸æ“‡æ­£ç¢ºçš„æ³°æ–‡ç¿»è­¯ï¼š
                </div>
              </div>

              <div id="choices-container" style="display: grid; gap: 1rem;">
                ${gameOptions.map((option, index) => `
                  <button class="choice-btn" data-index="${index}" data-correct="${option.isCorrect}"
                    style="padding: 1.5rem; background-color: ${colors.background}; color: ${colors.text}; border: 2px solid ${colors.primary}; border-radius: 0.5rem; cursor: pointer; font-size: ${baseSize}px; text-align: left;">
                    ${option.text}
                  </button>
                `).join('')}
              </div>

              <div id="choice-feedback" style="margin-top: 1.5rem; padding: 1rem; border-radius: 0.5rem; display: none;"></div>
            </div>
          </div>
        </div>
      `;
    }

    function renderSpeedChallenge(colors, baseSize, config) {
      const word = studyWords[currentCardIndex];

      return `
        <div class="w-full min-h-full" style="background-color: ${colors.background}; padding: 2rem;">
          <div style="max-width: 800px; margin: 0 auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
              <h1 style="font-size: ${baseSize * 1.5}px; font-weight: bold; color: ${colors.text};">âš¡ é€Ÿåº¦æŒ‘æˆ° - HSK ${selectedLevel}</h1>
              <button class="back-to-mode-btn" style="padding: 0.75rem 1.5rem; background-color: ${colors.primary}; color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-size: ${baseSize}px;">
                è¿”å›
              </button>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 2rem;">
              <div style="background-color: ${colors.card}; padding: 1.5rem; border-radius: 0.5rem; text-align: center;">
                <div style="font-size: ${baseSize * 2.5}px; font-weight: bold; color: ${colors.accent};" id="timer">
                  ${gameTimeLeft}
                </div>
                <div style="font-size: ${baseSize * 0.9}px; color: ${colors.text}; opacity: 0.7;">å‰©é¤˜æ™‚é–“ï¼ˆç§’ï¼‰</div>
              </div>
              <div style="background-color: ${colors.card}; padding: 1.5rem; border-radius: 0.5rem; text-align: center;">
                <div style="font-size: ${baseSize * 2.5}px; font-weight: bold; color: ${colors.primary};">
                  ${testScore}
                </div>
                <div style="font-size: ${baseSize * 0.9}px; color: ${colors.text}; opacity: 0.7;">ç­”å°é¡Œæ•¸</div>
              </div>
            </div>

            <div style="background-color: ${colors.card}; padding: 3rem; border-radius: 1rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
              <div style="text-align: center; margin-bottom: 2rem;">
                <div style="font-size: ${baseSize * 3}px; font-weight: bold; color: ${colors.text}; margin-bottom: 1rem;">
                  ${word.simplified}
                </div>
                <div style="font-size: ${baseSize * 1.3}px; color: ${colors.primary};">
                  ${word.pinyin}
                </div>
              </div>

              <div id="speed-choices-container" style="display: grid; gap: 1rem;">
                ${gameOptions.map((option, index) => `
                  <button class="speed-choice-btn" data-index="${index}" data-correct="${option.isCorrect}"
                    style="padding: 1.5rem; background-color: ${colors.background}; color: ${colors.text}; border: 2px solid ${colors.primary}; border-radius: 0.5rem; cursor: pointer; font-size: ${baseSize}px; text-align: left;">
                    ${option.text}
                  </button>
                `).join('')}
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function renderMatching(colors, baseSize, config) {
      return `
        <div class="w-full min-h-full" style="background-color: ${colors.background}; padding: 2rem;">
          <div style="max-width: 900px; margin: 0 auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
              <h1 style="font-size: ${baseSize * 1.5}px; font-weight: bold; color: ${colors.text};">ğŸ´ é…å°éŠæˆ² - HSK ${selectedLevel}</h1>
              <button class="back-to-mode-btn" style="padding: 0.75rem 1.5rem; background-color: ${colors.primary}; color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-size: ${baseSize}px;">
                è¿”å›
              </button>
            </div>

            <div style="background-color: ${colors.card}; padding: 1.5rem; border-radius: 0.5rem; margin-bottom: 2rem; text-align: center;">
              <div style="font-size: ${baseSize * 1.2}px; color: ${colors.text};">
                å·²é…å°ï¼š<span style="font-weight: bold; color: ${colors.accent};">${matchedPairs.length}</span> / ${matchingPairs.length}
              </div>
            </div>

            <div id="matching-grid" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem;">
              ${matchingPairs.map((pair, index) => `
                <div class="matching-card ${matchedPairs.includes(index) ? 'matched' : ''}" data-index="${index}"
                  style="aspect-ratio: 1; cursor: pointer; perspective: 1000px;">
                  <div class="card-inner" style="width: 100%; height: 100%; position: relative; transition: transform 0.6s; transform-style: preserve-3d;">
                    <div class="card-front" style="position: absolute; width: 100%; height: 100%; background-color: ${colors.primary}; border-radius: 0.5rem; display: flex; align-items: center; justify-content: center; backface-visibility: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                      <div style="font-size: ${baseSize * 2}px; color: white;">?</div>
                    </div>
                    <div class="card-back" style="position: absolute; width: 100%; height: 100%; background-color: ${colors.card}; border: 2px solid ${colors.primary}; border-radius: 0.5rem; display: flex; align-items: center; justify-content: center; backface-visibility: hidden; transform: rotateY(180deg); padding: 1rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                      <div style="font-size: ${baseSize * 0.9}px; color: ${colors.text}; font-weight: bold; text-align: center; word-break: break-word;">
                        ${pair.text}
                      </div>
                    </div>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        </div>
      `;
    }

    function renderListening(colors, baseSize, config) {
      const word = studyWords[currentCardIndex];
      const progress = ((currentCardIndex + 1) / studyWords.length) * 100;

      return `
        <div class="w-full min-h-full" style="background-color: ${colors.background}; padding: 2rem;">
          <div style="max-width: 800px; margin: 0 auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
              <h1 style="font-size: ${baseSize * 1.5}px; font-weight: bold; color: ${colors.text};">ğŸ‘‚ æ‹¼éŸ³ç·´ç¿’ - HSK ${selectedLevel}</h1>
              <button class="back-to-mode-btn" style="padding: 0.75rem 1.5rem; background-color: ${colors.primary}; color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-size: ${baseSize}px;">
                è¿”å›
              </button>
            </div>

            <div style="margin-bottom: 2rem;">
              <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                <span style="font-size: ${baseSize * 0.9}px; color: ${colors.text};">é€²åº¦ï¼š${currentCardIndex + 1} / ${studyWords.length}</span>
                <span style="font-size: ${baseSize * 0.9}px; color: ${colors.text};">ç›®å‰å¾—åˆ†ï¼š${testScore}</span>
              </div>
              <div style="width: 100%; height: 10px; background-color: ${colors.card}; border-radius: 1rem; overflow: hidden;">
                <div style="width: ${progress}%; height: 100%; background-color: ${colors.accent}; transition: width 0.3s;"></div>
              </div>
            </div>

            <div style="background-color: ${colors.card}; padding: 3rem; border-radius: 1rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
              <div style="text-align: center; margin-bottom: 3rem;">
                <div style="font-size: ${baseSize * 0.9}px; color: ${colors.text}; opacity: 0.7; margin-bottom: 1rem;">
                  æ ¹æ“šæ‹¼éŸ³é¸æ“‡æ­£ç¢ºçš„ä¸­æ–‡
                </div>
                <div style="font-size: ${baseSize * 3.5}px; font-weight: bold; color: ${colors.primary}; margin-bottom: 1rem;">
                  ${word.pinyin}
                </div>
                <div style="font-size: ${baseSize}px; color: ${colors.text}; opacity: 0.6;">
                  è©æ€§ï¼š${word.word_type}
                </div>
              </div>

              <div id="listening-choices-container" style="display: grid; gap: 1rem;">
                ${gameOptions.map((option, index) => `
                  <button class="listening-choice-btn" data-index="${index}" data-correct="${option.isCorrect}"
                    style="padding: 1.5rem; background-color: ${colors.background}; color: ${colors.text}; border: 2px solid ${colors.primary}; border-radius: 0.5rem; cursor: pointer; font-size: ${baseSize * 1.3}px; font-weight: bold; text-align: center;">
                    ${option.text}
                  </button>
                `).join('')}
              </div>

              <div id="listening-feedback" style="margin-top: 1.5rem; padding: 1rem; border-radius: 0.5rem; display: none;"></div>
            </div>
          </div>
        </div>
      `;
    }

    function renderResults(colors, baseSize, config) {
      const percentage = Math.round((testScore / studyWords.length) * 100);

      return `
        <div class="w-full min-h-full" style="background-color: ${colors.background}; padding: 2rem;">
          <div style="max-width: 800px; margin: 0 auto;">
            <div style="text-align: center; margin-bottom: 3rem;">
              <h1 style="font-size: ${baseSize * 2.5}px; font-weight: bold; color: ${colors.text}; margin-bottom: 1rem;">
                ${studyMode === 'speed-challenge' ? 'âš¡ æŒ‘æˆ°å®Œæˆï¼' : 'æ¸¬é©—å®Œæˆï¼'}
              </h1>
              <div style="font-size: ${baseSize * 4}px; font-weight: bold; color: ${colors.primary}; margin-bottom: 1rem;">
                ${studyMode === 'speed-challenge' ? `${testScore} é¡Œ` : `${percentage}%`}
              </div>
              <div style="font-size: ${baseSize * 1.3}px; color: ${colors.text};">
                ${studyMode === 'speed-challenge' ? `60ç§’å…§ç­”å° ${testScore} é¡Œï¼` : `ç­”å° ${testScore} / ${studyWords.length} é¡Œ`}
              </div>
            </div>

            ${testAnswers.length > 0 ? `
              <div style="background-color: ${colors.card}; padding: 2rem; border-radius: 1rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 2rem;">
                <h2 style="font-size: ${baseSize * 1.5}px; font-weight: bold; color: ${colors.text}; margin-bottom: 1.5rem;">ç­”é¡Œè©³æƒ…</h2>
                ${testAnswers.map((item, index) => {
                  const meanings = item.word.thai_meanings ? item.word.thai_meanings.split('|').filter(m => m.trim()) : [];

                  return `
                    <div style="padding: 1rem; margin-bottom: 1rem; background-color: ${item.correct ? '#f0fdf4' : '#fef2f2'}; border-left: 4px solid ${item.correct ? colors.accent : '#ef4444'}; border-radius: 0.5rem;">
                      <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                        <div>
                          <span style="font-size: ${baseSize * 1.2}px; font-weight: bold; color: ${colors.text};">
                            ${item.word.simplified}
                          </span>
                          <span style="font-size: ${baseSize}px; color: ${colors.text}; opacity: 0.7; margin-left: 0.5rem;">
                            ${item.word.pinyin}
                          </span>
                        </div>
                        <span style="font-size: ${baseSize * 1.5}px;">
                          ${item.correct ? 'âœ“' : 'âœ—'}
                        </span>
                      </div>
                      ${item.userAnswer ? `
                        <div style="font-size: ${baseSize * 0.9}px; color: ${colors.text}; opacity: 0.8;">
                          ä½ çš„ç­”æ¡ˆï¼š${item.userAnswer}
                        </div>
                      ` : ''}
                      <div style="font-size: ${baseSize * 0.9}px; color: ${colors.text}; opacity: 0.8; margin-top: 0.25rem;">
                        æ­£ç¢ºç­”æ¡ˆï¼š${meanings.join(' / ')}
                      </div>
                    </div>
                  `;
                }).join('')}
              </div>
            ` : ''}

            <div style="display: flex; gap: 1rem;">
              <button class="retry-test-btn" style="flex: 1; padding: 1rem; background-color: ${colors.accent}; color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-size: ${baseSize}px; font-weight: bold;">
                å†${studyMode === 'matching' ? 'ç©' : 'æ¸¬'}ä¸€æ¬¡
              </button>
              <button class="back-btn" style="flex: 1; padding: 1rem; background-color: ${colors.primary}; color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-size: ${baseSize}px; font-weight: bold;">
                è¿”å›é¦–é 
              </button>
            </div>
          </div>
        </div>
      `;
    }

    function generateMultipleChoiceOptions(correctWord, allWordsPool) {
      const correctMeanings = correctWord.thai_meanings.split('|').map(m => m.trim());
      const correctAnswer = correctMeanings[0];

      const otherWords = allWordsPool.filter(w => w.id !== correctWord.id);
      const shuffled = otherWords.sort(() => Math.random() - 0.5);

      const wrongOptions = [];
      for (let i = 0; i < shuffled.length && wrongOptions.length < 3; i++) {
        const meanings = shuffled[i].thai_meanings.split('|').map(m => m.trim());
        if (meanings[0] && meanings[0] !== correctAnswer) {
          wrongOptions.push(meanings[0]);
        }
      }

      while (wrongOptions.length < 3) {
        wrongOptions.push(`é¸é … ${wrongOptions.length + 1}`);
      }

      const options = [
        { text: correctAnswer, isCorrect: true },
        { text: wrongOptions[0], isCorrect: false },
        { text: wrongOptions[1], isCorrect: false },
        { text: wrongOptions[2], isCorrect: false }
      ];

      return options.sort(() => Math.random() - 0.5);
    }

    function generateListeningOptions(correctWord, allWordsPool) {
      const otherWords = allWordsPool.filter(w => w.id !== correctWord.id);
      const shuffled = otherWords.sort(() => Math.random() - 0.5);

      const wrongOptions = shuffled.slice(0, 3).map(w => w.simplified);

      const options = [
        { text: correctWord.simplified, isCorrect: true },
        { text: wrongOptions[0] || 'é¸é …1', isCorrect: false },
        { text: wrongOptions[1] || 'é¸é …2', isCorrect: false },
        { text: wrongOptions[2] || 'é¸é …3', isCorrect: false }
      ];

      return options.sort(() => Math.random() - 0.5);
    }

    function generateMatchingPairs(words) {
      const pairs = [];
      const selectedWords = words.slice(0, Math.min(6, words.length));

      selectedWords.forEach(word => {
        const meanings = word.thai_meanings.split('|').map(m => m.trim());
        pairs.push({ text: word.simplified, matchId: word.id, type: 'chinese' });
        pairs.push({ text: meanings[0], matchId: word.id, type: 'thai' });
      });

      return pairs.sort(() => Math.random() - 0.5);
    }

    function startSpeedTimer() {
      if (gameTimer) clearInterval(gameTimer);

      gameTimer = setInterval(() => {
        gameTimeLeft--;
        const timerElement = document.getElementById('timer');
        if (timerElement) {
          timerElement.textContent = gameTimeLeft;
        }

        if (gameTimeLeft <= 0) {
          clearInterval(gameTimer);
          currentView = 'results';
          renderApp();
        }
      }, 1000);
    }

    function attachEventListeners() {
      const actionCards = document.querySelectorAll('.action-card');
      actionCards.forEach(card => {
        card.addEventListener('click', () => {
          const action = card.dataset.action;
          if (action === 'browse') {
            currentView = 'browse';
            renderApp();
          } else if (action === 'add') {
            currentView = 'add';
            renderApp();
          } else if (action === 'study') {
            currentView = 'study';
            selectedLevel = null;
            studyMode = null;
            renderApp();
          }
        });

        card.addEventListener('mouseenter', (e) => {
          e.currentTarget.style.transform = 'translateY(-4px)';
        });

        card.addEventListener('mouseleave', (e) => {
          e.currentTarget.style.transform = 'translateY(0)';
        });
      });

      const backBtns = document.querySelectorAll('.back-btn');
      backBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          if (gameTimer) clearInterval(gameTimer);
          currentView = 'home';
          selectedLevel = null;
          studyMode = null;
          currentCardIndex = 0;
          gameTimeLeft = 60;
          renderApp();
        });
      });

      const searchInput = document.getElementById('search-input');
      if (searchInput) {
        searchInput.addEventListener('input', (e) => {
          const query = e.target.value.toLowerCase();
          const filtered = allWords.filter(word =>
            word.simplified.includes(query) ||
            word.traditional.includes(query) ||
            word.pinyin.toLowerCase().includes(query) ||
            word.thai_meanings.toLowerCase().includes(query)
          );

          const container = document.getElementById('words-container');
          const colors = getColors();
          const baseSize = getFontSize();
          container.innerHTML = renderWordCards(filtered, colors, baseSize);
          attachDeleteListeners();
        });
      }

      const levelFilters = document.querySelectorAll('.level-filter');
      levelFilters.forEach(btn => {
        btn.addEventListener('click', () => {
          const level = btn.dataset.level;
          const colors = getColors();

          levelFilters.forEach(b => {
            if (b === btn) {
              b.style.backgroundColor = colors.primary;
              b.style.color = 'white';
            } else {
              b.style.backgroundColor = colors.card;
              b.style.color = colors.text;
            }
          });

          let filtered;
          if (level === 'all') {
            filtered = allWords;
          } else if (level === '7-9') {
            filtered = allWords.filter(w => w.hsk_level >= 7 && w.hsk_level <= 9);
          } else {
            const levelConfig = customLevels.find(l => l.id === level);
            if (levelConfig) {
              filtered = allWords.filter(w => w.hsk_level === levelConfig.value);
            } else {
              filtered = allWords;
            }
          }

          const container = document.getElementById('words-container');
          const baseSize = getFontSize();
          container.innerHTML = renderWordCards(filtered, colors, baseSize);
          attachDeleteListeners();
        });
      });

      attachDeleteListeners();

      const wordTypeSelect = document.getElementById('word-type');
      const customWordTypeInput = document.getElementById('custom-word-type');

      if (wordTypeSelect) {
        wordTypeSelect.addEventListener('change', (e) => {
          if (e.target.value === 'è‡ªè¨‚') {
            customWordTypeInput.style.display = 'block';
            customWordTypeInput.required = true;
            wordTypeSelect.required = false;
          } else {
            customWordTypeInput.style.display = 'none';
            customWordTypeInput.required = false;
            wordTypeSelect.required = true;
          }
        });
      }

      const manageWordTypesBtn = document.getElementById('manage-word-types-btn');
      if (manageWordTypesBtn) {
        manageWordTypesBtn.addEventListener('click', () => {
          showWordTypeModal = true;
          renderApp();
        });
      }

      const manageLevelsBtn = document.getElementById('manage-levels-btn');
      if (manageLevelsBtn) {
        manageLevelsBtn.addEventListener('click', () => {
          showLevelModal = true;
          renderApp();
        });
      }

      const manageLevelsAddBtn = document.getElementById('manage-levels-add-btn');
      if (manageLevelsAddBtn) {
        manageLevelsAddBtn.addEventListener('click', () => {
          showLevelModal = true;
          renderApp();
        });
      }

      const closeModalBtn = document.getElementById('close-modal-btn');
      if (closeModalBtn) {
        closeModalBtn.addEventListener('click', () => {
          showWordTypeModal = false;
          renderApp();
        });
      }

      const closeLevelModalBtn = document.getElementById('close-level-modal-btn');
      if (closeLevelModalBtn) {
        closeLevelModalBtn.addEventListener('click', () => {
          showLevelModal = false;
          renderApp();
        });
      }

      const addWordTypeBtn = document.getElementById('add-word-type-btn');
      if (addWordTypeBtn) {
        addWordTypeBtn.addEventListener('click', () => {
          const input = document.getElementById('new-word-type-input');
          const newType = input.value.trim();

          if (newType && !customWordTypes.includes(newType)) {
            customWordTypes.push(newType);
            input.value = '';
            renderApp();
          } else if (customWordTypes.includes(newType)) {
            const colors = getColors();
            const baseSize = getFontSize();
            input.style.borderColor = '#ef4444';
            setTimeout(() => {
              input.style.borderColor = colors.primary;
            }, 2000);
          }
        });
      }

      const deleteWordTypeBtns = document.querySelectorAll('.delete-word-type-btn');
      deleteWordTypeBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          const index = parseInt(btn.dataset.index);
          customWordTypes.splice(index, 1);
          renderApp();
        });
      });

      const addLevelBtn = document.getElementById('add-level-btn');
      if (addLevelBtn) {
        addLevelBtn.addEventListener('click', () => {
          const labelInput = document.getElementById('new-level-label');
          const valueInput = document.getElementById('new-level-value');
          const newLabel = labelInput.value.trim();
          const newValue = parseInt(valueInput.value);

          if (newLabel && newValue && !customLevels.find(l => l.id === newValue.toString())) {
            customLevels.push({
              id: newValue.toString(),
              label: newLabel,
              value: newValue
            });
            customLevels.sort((a, b) => a.value - b.value);
            labelInput.value = '';
            valueInput.value = '';
            renderApp();
          } else if (customLevels.find(l => l.id === newValue.toString())) {
            const colors = getColors();
            valueInput.style.borderColor = '#ef4444';
            setTimeout(() => {
              valueInput.style.borderColor = colors.primary;
            }, 2000);
          }
        });
      }

      const deleteLevelBtns = document.querySelectorAll('.delete-level-btn');
      deleteLevelBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          const index = parseInt(btn.dataset.index);
          customLevels.splice(index, 1);
          renderApp();
        });
      });

      const simplifiedInput = document.getElementById('simplified');
      const traditionalInput = document.getElementById('traditional');

      if (simplifiedInput && traditionalInput) {
        simplifiedInput.addEventListener('input', (e) => {
          const simplifiedText = e.target.value;
          if (simplifiedText) {
            traditionalInput.value = convertToTraditional(simplifiedText);
          } else {
            traditionalInput.value = '';
          }
        });

        if (simplifiedInput.value) {
          simplifiedInput.dispatchEvent(new Event('input'));
        }
      }

      const addWordForm = document.getElementById('add-word-form');
      if (addWordForm) {
        addWordForm.addEventListener('submit', async (e) => {
          e.preventDefault();

          if (allWords.length >= 999) {
            showFormMessage('å·²é”åˆ°æœ€å¤§ç”Ÿè©æ•¸é‡é™åˆ¶ï¼ˆ999å€‹ï¼‰', false);
            return;
          }

          const submitBtn = document.getElementById('submit-btn');
          const messageDiv = document.getElementById('form-message');

          submitBtn.disabled = true;
          submitBtn.textContent = 'åŒæ­¥åˆ° Canva Sheet...';
          isLoading = true;

          const wordTypeSelect = document.getElementById('word-type');
          const customWordTypeInput = document.getElementById('custom-word-type');
          let finalWordType = wordTypeSelect.value;

          if (wordTypeSelect.value === 'è‡ªè¨‚') {
            finalWordType = customWordTypeInput.value.trim();
            if (finalWordType && !customWordTypes.includes(finalWordType)) {
              customWordTypes.push(finalWordType);
            }
          }

          const wordData = {
            id: Date.now().toString(),
            simplified: document.getElementById('simplified').value.trim(),
            traditional: document.getElementById('traditional').value.trim(),
            pinyin: document.getElementById('pinyin').value.trim(),
            word_type: finalWordType,
            thai_meanings: document.getElementById('thai-meanings').value.trim(),
            example_sentences: document.getElementById('examples').value.trim(),
            hsk_level: parseInt(document.getElementById('hsk-level').value),
            created_at: new Date().toISOString()
          };

          const result = await window.dataSdk.create(wordData);

          isLoading = false;

          if (result.isOk) {
            showFormMessage('âœ“ ç”Ÿè©å·²æˆåŠŸæ–°å¢ä¸¦åŒæ­¥åˆ° Canva Sheetï¼', true);
            addWordForm.reset();
            setTimeout(() => {
              currentView = 'browse';
              renderApp();
            }, 1500);
          } else {
            showFormMessage('âœ— æ–°å¢å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', false);
            submitBtn.disabled = false;
            submitBtn.textContent = 'æ–°å¢ç”Ÿè©åˆ° Canva Sheet';
          }
        });
      }

      const selectLevelBtns = document.querySelectorAll('.select-level-btn');
      selectLevelBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          selectedLevel = btn.dataset.level;
          renderApp();
        });
      });

      const backToLevelBtn = document.querySelector('.back-to-level-btn');
      if (backToLevelBtn) {
        backToLevelBtn.addEventListener('click', () => {
          if (gameTimer) clearInterval(gameTimer);
          selectedLevel = null;
          studyMode = null;
          gameTimeLeft = 60;
          renderApp();
        });
      }

      const selectModeBtns = document.querySelectorAll('.select-mode-btn');
      selectModeBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          studyMode = btn.dataset.mode;

          if (selectedLevel === '7-9') {
            studyWords = allWords.filter(w => w.hsk_level >= 7 && w.hsk_level <= 9);
          } else {
            const levelConfig = customLevels.find(l => l.id === selectedLevel);
            if (levelConfig) {
              studyWords = allWords.filter(w => w.hsk_level === levelConfig.value);
            }
          }

          studyWords = studyWords.sort(() => Math.random() - 0.5);
          currentCardIndex = 0;
          testScore = 0;
          testAnswers = [];
          gameTimeLeft = 60;

          if (studyMode === 'test') {
            currentView = 'test';
          } else if (studyMode === 'multiple-choice') {
            currentView = 'multiple-choice';
            gameOptions = generateMultipleChoiceOptions(studyWords[0], studyWords);
          } else if (studyMode === 'speed-challenge') {
            currentView = 'speed-challenge';
            gameOptions = generateMultipleChoiceOptions(studyWords[0], studyWords);
            setTimeout(() => startSpeedTimer(), 100);
          } else if (studyMode === 'matching') {
            currentView = 'matching';
            matchingPairs = generateMatchingPairs(studyWords);
            selectedCards = [];
            matchedPairs = [];
            gameStartTime = Date.now();
          } else if (studyMode === 'listening') {
            currentView = 'listening';
            gameOptions = generateListeningOptions(studyWords[0], studyWords);
          }

          renderApp();
        });
      });

      const flashcard = document.getElementById('flashcard');
      if (flashcard) {
        flashcard.addEventListener('click', () => {
          flashcard.classList.toggle('flipped');
        });
      }

      const prevCardBtn = document.querySelector('.prev-card-btn');
      if (prevCardBtn) {
        prevCardBtn.addEventListener('click', () => {
          if (currentCardIndex > 0) {
            currentCardIndex--;
            renderApp();
          }
        });
      }

      const nextCardBtn = document.querySelector('.next-card-btn');
      if (nextCardBtn) {
        nextCardBtn.addEventListener('click', () => {
          if (currentCardIndex < studyWords.length - 1) {
            currentCardIndex++;
            renderApp();
          }
        });
      }

      const backToModeBtn = document.querySelector('.back-to-mode-btn');
      if (backToModeBtn) {
        backToModeBtn.addEventListener('click', () => {
          if (gameTimer) clearInterval(gameTimer);
          studyMode = null;
          currentCardIndex = 0;
          gameTimeLeft = 60;
          if (currentView === 'test' || currentView === 'multiple-choice' || currentView === 'speed-challenge' || currentView === 'matching' || currentView === 'listening') {
            currentView = 'study';
          }
          renderApp();
        });
      }

      const testForm = document.getElementById('test-form');
      if (testForm) {
        testForm.addEventListener('submit', async (e) => {
          e.preventDefault();

          const answerInput = document.getElementById('answer-input');
          const userAnswer = answerInput.value.trim();
          const word = studyWords[currentCardIndex];
          const meanings = word.thai_meanings.split('|').map(m => m.trim().toLowerCase());

          const isCorrect = meanings.some(m => m === userAnswer.toLowerCase());

          if (isCorrect) {
            testScore++;
          }

          testAnswers.push({
            word: word,
            userAnswer: userAnswer,
            correct: isCorrect
          });

          const feedback = document.getElementById('answer-feedback');
          const colors = getColors();
          const baseSize = getFontSize();

          if (isCorrect) {
            feedback.style.display = 'block';
            feedback.style.backgroundColor = '#f0fdf4';
            feedback.style.border = `2px solid ${colors.accent}`;
            feedback.style.color = '#166534';
            feedback.innerHTML = `<div style="font-size: ${baseSize}px; font-weight: bold;">âœ“ æ­£ç¢ºï¼</div>`;
          } else {
            feedback.style.display = 'block';
            feedback.style.backgroundColor = '#fef2f2';
            feedback.style.border = '2px solid #ef4444';
            feedback.style.color = '#991b1b';
            feedback.innerHTML = `
              <div style="font-size: ${baseSize}px; font-weight: bold; margin-bottom: 0.5rem;">âœ— ç­”éŒ¯äº†</div>
              <div style="font-size: ${baseSize * 0.9}px;">æ­£ç¢ºç­”æ¡ˆï¼š${meanings.join(' / ')}</div>
            `;
          }

          answerInput.disabled = true;
          const checkBtn = document.getElementById('check-answer-btn');
          checkBtn.textContent = currentCardIndex < studyWords.length - 1 ? 'ä¸‹ä¸€é¡Œ' : 'æŸ¥çœ‹çµæœ';
          checkBtn.style.backgroundColor = colors.primary;

          checkBtn.onclick = () => {
            if (currentCardIndex < studyWords.length - 1) {
              currentCardIndex++;
              renderApp();
            } else {
              currentView = 'results';
              renderApp();
            }
          };
        });
      }

      const choiceBtns = document.querySelectorAll('.choice-btn');
      choiceBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          const isCorrect = btn.dataset.correct === 'true';
          const colors = getColors();
          const baseSize = getFontSize();

          choiceBtns.forEach(b => b.disabled = true);

          if (isCorrect) {
            testScore++;
            btn.classList.add('correct');
            btn.style.backgroundColor = colors.accent;
            btn.style.color = 'white';
            btn.style.borderColor = colors.accent;
          } else {
            btn.classList.add('wrong');
            btn.style.backgroundColor = '#ef4444';
            btn.style.color = 'white';
            btn.style.borderColor = '#ef4444';

            choiceBtns.forEach(b => {
              if (b.dataset.correct === 'true') {
                b.style.backgroundColor = colors.accent;
                b.style.color = 'white';
                b.style.borderColor = colors.accent;
              }
            });
          }

          const word = studyWords[currentCardIndex];
          testAnswers.push({
            word: word,
            userAnswer: btn.textContent.trim(),
            correct: isCorrect
          });

          const feedback = document.getElementById('choice-feedback');
          feedback.style.display = 'block';

          if (isCorrect) {
            feedback.style.backgroundColor = '#f0fdf4';
            feedback.style.border = `2px solid ${colors.accent}`;
            feedback.style.color = '#166534';
            feedback.innerHTML = `<div style="font-size: ${baseSize}px; font-weight: bold; text-align: center;">âœ“ æ­£ç¢ºï¼</div>`;
          } else {
            feedback.style.backgroundColor = '#fef2f2';
            feedback.style.border = '2px solid #ef4444';
            feedback.style.color = '#991b1b';
            feedback.innerHTML = `<div style="font-size: ${baseSize}px; font-weight: bold; text-align: center;">âœ— ç­”éŒ¯äº†</div>`;
          }

          setTimeout(() => {
            if (currentCardIndex < studyWords.length - 1) {
              currentCardIndex++;
              gameOptions = generateMultipleChoiceOptions(studyWords[currentCardIndex], studyWords);
              renderApp();
            } else {
              currentView = 'results';
              renderApp();
            }
          }, 1500);
        });
      });

      const speedChoiceBtns = document.querySelectorAll('.speed-choice-btn');
      speedChoiceBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          const isCorrect = btn.dataset.correct === 'true';
          const colors = getColors();

          if (isCorrect) {
            testScore++;
            btn.style.backgroundColor = colors.accent;
            btn.style.color = 'white';

            const word = studyWords[currentCardIndex];
            testAnswers.push({
              word: word,
              userAnswer: btn.textContent.trim(),
              correct: true
            });

            setTimeout(() => {
              currentCardIndex++;
              if (currentCardIndex >= studyWords.length) {
                studyWords = studyWords.sort(() => Math.random() - 0.5);
                currentCardIndex = 0;
              }
              gameOptions = generateMultipleChoiceOptions(studyWords[currentCardIndex], studyWords);
              renderApp();
            }, 300);
          } else {
            btn.classList.add('shake');
            btn.style.backgroundColor = '#ef4444';
            btn.style.color = 'white';

            setTimeout(() => {
              btn.style.backgroundColor = colors.background;
              btn.style.color = colors.text;
              btn.classList.remove('shake');
            }, 500);
          }
        });
      });

      const matchingCards = document.querySelectorAll('.matching-card');
      matchingCards.forEach(card => {
        card.addEventListener('click', () => {
          if (card.classList.contains('matched') || card.classList.contains('flipped')) return;

          const index = parseInt(card.dataset.index);
          card.classList.add('flipped');
          selectedCards.push(index);

          if (selectedCards.length === 2) {
            const [first, second] = selectedCards;
            const firstPair = matchingPairs[first];
            const secondPair = matchingPairs[second];

            if (firstPair.matchId === secondPair.matchId && firstPair.type !== secondPair.type) {
              setTimeout(() => {
                matchedPairs.push(first, second);

                if (matchedPairs.length === matchingPairs.length) {
                  testScore = Math.round((Date.now() - gameStartTime) / 1000);
                  setTimeout(() => {
                    currentView = 'results';
                    renderApp();
                  }, 500);
                } else {
                  renderApp();
                }
              }, 600);
            } else {
              setTimeout(() => {
                const cards = document.querySelectorAll('.matching-card');
                cards[first].classList.remove('flipped');
                cards[second].classList.remove('flipped');
                selectedCards = [];
              }, 1000);
            }

            if (matchedPairs.length < matchingPairs.length) {
              selectedCards = [];
            }
          }
        });
      });

      const listeningChoiceBtns = document.querySelectorAll('.listening-choice-btn');
      listeningChoiceBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          const isCorrect = btn.dataset.correct === 'true';
          const colors = getColors();
          const baseSize = getFontSize();

          listeningChoiceBtns.forEach(b => b.disabled = true);

          if (isCorrect) {
            testScore++;
            btn.classList.add('correct');
            btn.style.backgroundColor = colors.accent;
            btn.style.color = 'white';
            btn.style.borderColor = colors.accent;
          } else {
            btn.classList.add('wrong');
            btn.style.backgroundColor = '#ef4444';
            btn.style.color = 'white';
            btn.style.borderColor = '#ef4444';

            listeningChoiceBtns.forEach(b => {
              if (b.dataset.correct === 'true') {
                b.style.backgroundColor = colors.accent;
                b.style.color = 'white';
                b.style.borderColor = colors.accent;
              }
            });
          }

          const word = studyWords[currentCardIndex];
          testAnswers.push({
            word: word,
            userAnswer: btn.textContent.trim(),
            correct: isCorrect
          });

          const feedback = document.getElementById('listening-feedback');
          feedback.style.display = 'block';

          if (isCorrect) {
            feedback.style.backgroundColor = '#f0fdf4';
            feedback.style.border = `2px solid ${colors.accent}`;
            feedback.style.color = '#166534';
            feedback.innerHTML = `<div style="font-size: ${baseSize}px; font-weight: bold; text-align: center;">âœ“ æ­£ç¢ºï¼</div>`;
          } else {
            feedback.style.backgroundColor = '#fef2f2';
            feedback.style.border = '2px solid #ef4444';
            feedback.style.color = '#991b1b';
            feedback.innerHTML = `<div style="font-size: ${baseSize}px; font-weight: bold; text-align: center;">âœ— ç­”éŒ¯äº†</div>`;
          }

          setTimeout(() => {
            if (currentCardIndex < studyWords.length - 1) {
              currentCardIndex++;
              gameOptions = generateListeningOptions(studyWords[currentCardIndex], studyWords);
              renderApp();
            } else {
              currentView = 'results';
              renderApp();
            }
          }, 1500);
        });
      });

      const retryTestBtn = document.querySelector('.retry-test-btn');
      if (retryTestBtn) {
        retryTestBtn.addEventListener('click', () => {
          studyWords = studyWords.sort(() => Math.random() - 0.5);
          currentCardIndex = 0;
          testScore = 0;
          testAnswers = [];
          gameTimeLeft = 60;
          selectedCards = [];
          matchedPairs = [];
          gameStartTime = null;

          if (studyMode === 'test') {
            currentView = 'test';
          } else if (studyMode === 'multiple-choice') {
            currentView = 'multiple-choice';
            gameOptions = generateMultipleChoiceOptions(studyWords[0], studyWords);
          } else if (studyMode === 'speed-challenge') {
            currentView = 'speed-challenge';
            gameOptions = generateMultipleChoiceOptions(studyWords[0], studyWords);
            setTimeout(() => startSpeedTimer(), 100);
          } else if (studyMode === 'matching') {
            currentView = 'matching';
            matchingPairs = generateMatchingPairs(studyWords);
            gameStartTime = Date.now();
          } else if (studyMode === 'listening') {
            currentView = 'listening';
            gameOptions = generateListeningOptions(studyWords[0], studyWords);
          }

          renderApp();
        });
      }
    }

    function attachDeleteListeners() {
      const deleteBtns = document.querySelectorAll('.delete-word-btn');
      deleteBtns.forEach(btn => {
        btn.addEventListener('click', async (e) => {
          e.stopPropagation();

          const wordId = btn.dataset.id;
          const word = allWords.find(w => w.id === wordId);

          if (!word) return;

          btn.disabled = true;
          btn.textContent = 'åˆªé™¤ä¸­...';
          isLoading = true;

          const result = await window.dataSdk.delete(word);

          isLoading = false;

          if (!result.isOk) {
            btn.disabled = false;
            btn.textContent = 'åˆªé™¤';

            const colors = getColors();
            const baseSize = getFontSize();
            const errorDiv = document.createElement('div');
            errorDiv.style.cssText = `
              position: fixed;
              top: 2rem;
              right: 2rem;
              background-color: #fef2f2;
              border: 2px solid #ef4444;
              color: #991b1b;
              padding: 1rem;
              border-radius: 0.5rem;
              font-size: ${baseSize}px;
              z-index: 1000;
            `;
            errorDiv.textContent = 'åˆªé™¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦';
            document.body.appendChild(errorDiv);

            setTimeout(() => {
              errorDiv.remove();
            }, 3000);
          }
        });
      });
    }

    function showFormMessage(message, isSuccess) {
      const messageDiv = document.getElementById('form-message');
      const colors = getColors();
      const baseSize = getFontSize();

      messageDiv.style.display = 'block';
      messageDiv.style.backgroundColor = isSuccess ? '#f0fdf4' : '#fef2f2';
      messageDiv.style.border = isSuccess ? `2px solid ${colors.accent}` : '2px solid #ef4444';
      messageDiv.style.color = isSuccess ? '#166534' : '#991b1b';
      messageDiv.style.fontSize = `${baseSize}px`;
      messageDiv.textContent = message;
    }

    initializeSDKs();
  </script>
</body>
</html>
